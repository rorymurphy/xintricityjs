(function(e,d){"function"===typeof define&&define.amd?define("XUtil",["jQuery","_"],function(g,c){return e.XUtil=d(b)}):e.$x=e.XUtil=d(e.jQuery,e._)})(this,function(e,d){var g=window,c;"undefined"!==typeof m&&(c=m);var m={namespace:function(d){d=d.split(".");var c;e.each(d,function(d,f){0==d&&(c=g);f in c||(c[f]={});c=c[f]});return c},format:function(d){var c=arguments;return d=d.replace(/\{(\d+)\}/ig,function(d,f,r,a){return c[parseInt(f)+1]})}},p=/\/[^w_]+\//;m.slugify=function(d){return d.replace(p,
"-").toLowerCase()};m.extend=function(c){d.each(Array.prototype.slice.call(arguments,1),function(d){if(d)for(var l in d){var f=d.__lookupGetter__(l),r=d.__lookupSetter__(l);f||r?(f&&c.__defineGetter__(l,f),r&&c.__defineSetter__(l,r)):c[l]=d[l]}});return c};m.noConflict=function(){c?window.$x=c:delete window.$x};return m});
(function(e,d){"function"===typeof define&&define.amd?define("XTemplate",["jQuery","underscore","XUtil"],function(e,c,m){return m.template=d(e,c,m)}):$x.template=d(e.jQuery,e._,e.XUtil)})(this,function(e,d,g){g=function(){d.bindAll(this,"initialize","addTemplate")};g.prototype={_templates:{},_templateTypes:{},initialize:function(){},getTemplate:function(e){c();d.has(this._templates,e)||this.addTemplate(e);return this._templates[e]},addTemplate:function(g,m,u){c();if(void 0===u||null===u){var l=e("#"+
g);if(0==l.length)throw"Must specify a name that corresponds to a template element or provide the template text";l.is('script[type^="text/template"]');u=l.html();void 0===m&&(m=l.data("xt-template"),void 0===m&&(l=l.attr("type"),l=/^text\/template-(.+)$/.exec(l),1<l.length&&(m=l[1])))}if(!d.has(this._templateTypes,m))throw"Unrecognized template type";m=this._templateTypes[m](u);this._templates[g]=m},registerTemplateType:function(d,c){this._templateTypes[d]=c}};var c=function(){d.has(this._templateTypes,
"underscore")||this.registerTemplateType("underscore",function(c){return d.template(c)});d.has(this._templateTypes,"mustache")||"undefined"==typeof Mustache||this.registerTemplateType("mustache",function(d){return Mustache.compile(d)});d.has(this._templateTypes,"handlebars")||"undefined"==typeof Handlebars||this.registerTemplateType("handlebars",function(d){return Handlebars.compile(d)});d.has(this._templateTypes,"xintricity")||"undefined"==typeof XMVVM||this.registerTemplateType("xintricity",function(d){return XMVVM.Template.compile(d)})},
m=new g;g=function(d){return m.getTemplate(d)};g.addTemplate=function(){m.addTemplate.apply(m,arguments)};g.registerTemplateTypes=function(){m.registerTemplateType.apply(m,arguments)};c=d.bind(c,m);return g});
(function(e,d){"function"===typeof define&&define.amd?define("XMVVM-Model",["jQuery","underscore","XUtil"],function(g,c,m){return e.XMVVM=d(g,c,m)}):e.XMVVM=d($,_,$x)})(this,function(e,d,g){var c={};Backbone.Model.isParentTypeOf=function(d){return Backbone.Model.prototype.isPrototypeOf(d.prototype)};Backbone.Collection.isParentTypeOf=function(d){return Backbone.Collection.prototype.isPrototypeOf(d.prototype)};var m=g.extendClass=function(l,f){var c=this,a;a=l&&d.has(l,"constructor")?l.constructor:
function(){return c.apply(this,arguments)};g.extend(a,c,f);var n=function(){this.constructor=a};n.prototype=c.prototype;a.prototype=new n;l&&g.extend(a.prototype,l);a.__super__=c.prototype;return a},p=function(l,f){this.fields||(this.fields={});d.isFunction(f)&&(f={type:f},this.fields[l]=f);this.fields&&!d.has(this,"fields")&&(this.fields=g.extend({},this.fields));d.has(this.fields,l)||(this.fields[l]=f);this.fields[l].name=l;this[l]=function(){if(1===arguments.length)this.set(l,arguments[0]);else return this.get(l)}};
d.mixin({resultBB:function(l,f,c){void 0===c&&(c=!0);var a=l[f];void 0===a&&l instanceof Backbone.Model&&(a=l.get(f));void 0!==a&&c&&d.isFunction(a)&&(a=a());return a},startsWith:function(d,f){return d.substr(0,f.length)===f},endsWith:function(d,f){var c=d.length-f.length;return 0<=c&&d.substr(c)===f}});var v=0;c.Event=function(d){this.eid="e"+v;v++;g.extend(this,d)};c.Event.extend=m;c.Model=Backbone.Model.extend({constructor:function(l,c){var r=this;d.defaults(r,{fields:{}});d.chain(r.fields).keys().each(function(a){r[a]=
d.bind(r[a],r)});Backbone.Model.apply(this,[l,c]);d.bindAll(this,"createField","set")},fields:{},createField:function(l,c){p.call(this,l,c);this[l]=d.bind(this[l],this)},clone:function(){var l=Backbone.Model.prototype.clone.apply(this);d.each(this.fields,function(d,c,a){l.createField(c,d)});return l},trigger:function(d){var f=Array.prototype.slice.call(arguments),e;if(1<arguments.length&&!(arguments[1]instanceof c.Event)){var f=d,a=d.indexOf(":");-1!==a&&(f=d.substr(0,a+1));switch(f){case "add":case "remove":case "destroy":e=
new c.Event({model:arguments[1],collection:arguments[2],options:arguments[3]});break;case "reset":case "sort":e=new c.Event({collection:arguments[1],options:arguments[2]});break;case "change":e=new c.Event({model:arguments[1],options:arguments[2]});break;case "request":case "error":e=new c.Event({model:arguments[1],xhr:arguments[2],options:arguments[3]});break;case "sync":e=new c.Event({model:arguments[1],resp:arguments[2],options:arguments[3]});break;case "invalid":e=new c.Event({model:arguments[1],
error:arguments[2],options:arguments[3]});break;case "route":e=new c.Event({params:arguments[1]});break;case "change:":e=new c.Event({model:arguments[1],value:arguments[2],options:arguments[3]});break;case "route:":e=new c.Event({route1:arguments[1],route2:arguments[2],params:arguments[3]})}null!==e?Backbone.Model.prototype.trigger.apply(this,[d,e]):Backbone.Model.prototype.trigger.apply(this,arguments)}else 1===arguments.length?(this instanceof c.Model?e=new c.Event({model:this}):this instanceof
c.Collection&&(e=new c.Event({collection:this})),f.push(e),Backbone.Model.prototype.trigger.apply(this,f)):Backbone.Model.prototype.trigger.apply(this,arguments)},set:function(c,f,e){var a=this,n,k,h=a.fields;d.isObject(c)?(n=c,e=f):(n={})[c]=f;d.each(n,function(n,c,l){var e;if(null!==h&&d.has(h,c)&&(l=h[c],f=a._prepareValue(l,n),e=!0,d.isFunction(l.validate)&&(e=l.validate(n)),!0!==e))throw e;k=a[c];null!==k&&(k instanceof Backbone.Model||k instanceof Backbone.Collection)&&k.off("all",g,this);if(n instanceof
Backbone.Model||n instanceof Backbone.Collection){var g=function(n,k){var h=Array.prototype.slice.call(arguments);d.has(k,"model")&&k.model===a||d.has(k,"recipients")&&d.has(k.recipients,a.cid)||(k.recipients=k.recipients||{},k.recipients[a.cid]=!0,a.trigger.apply(a,h))};(l=a.get(c))&&l.off("all",g,a.cid+c);n.on("all",g,a.cid+c)}});Backbone.Model.prototype.set.apply(this,[n,e])},_prepareValue:function(c,f){if(void 0===f||null===f)return f;switch(c.type){case "int":"int"!==typeof f&&(f=parseInt(f));
break;case Number:d.isNumber(f)||(f=parseFloat(f));break;case Boolean:d.isBoolean(f)||(f=!0==f);break;case String:d.isString(f)||(f+="");break;case Date:f instanceof Date||(d.isNumber(f)?f=new Date(f):d.isString(f)&&(f=Date.parse(f)));break;case Array:if(!(f instanceof Array))throw"Type mismatch";break;default:if(!(f instanceof c.type))if((c.type===Backbone.Model||Backbone.Model.isParentTypeOf(c.type))&&d.isObject(f)||(c.type===Backbone.Collection||Backbone.Collection.isParentTypeOf(c.type))&&(d.isObject(f)||
d.isArray(f)))f=new c.type(f);else if(!(f instanceof c.type))throw"Type mismatch";}return f},parse:function(c){d.each(this.fields,function(d,e,a){if(Backbone.Model.isParentTypeOf(d.type)||Backbone.Collection.isParentTypeOf(d.type))c[d.name]=new d.type(c[d.name],{parse:!0})});return c}});c.Model.extend=function(c,f){var e=m.call(this,c,f);this.prototype.fields&&d.each(this.prototype.fields,function(a,d){p.call(e.prototype,d,a)});d.has(c,"fields")&&d.each(c.fields,function(a,d){p.call(e.prototype,d,
a)});return e};c.Model.defaults={useGetSet:!1};c.Collection=Backbone.Collection.extend({unique:function(){var c=array.slice.call(arguments);c.unshift(this.models);return d.unique.apply(d,c)},_onModelEvent:function(d,c,e,a){"add"!==d&&"remove"!==d||e===this?Backbone.Collection.prototype._onModelEvent.apply(this,arguments):this.trigger.apply(this,arguments)}});c.View=Backbone.View.extend({});c.ViewModel=c.Model.extend({view:null,fields:{model:Object},render:function(){if(this.view)return g.template(this.view)(this.model(),
{context:{viewmodel:this}})}});var u=function(d,c){if(1==arguments.length)return this.get(d);this.set(d,c)};c.ModelNavMixins={splitModelPath:function(d){return d.match(/\w+(?=\.?)|(?=\[)\w+(?=\])/g)},resolveModelPath:function(d,c,e){return this.resolveModelExpression(d,{path:c},e)},resolveModelExpression:function(c,e,g){var a=e.path;if(3>arguments.length||void 0===g)g={};g=d.defaults(g,{evalVal:!0,allowPartial:!0});var n=[c];if("undefined"!==typeof a&&null!==a&&""!==a){for(var a=a instanceof Array?
a:this.splitModelPath(a),k=0;k<a.length;k++){var h=n[n.length-1];if(null==h&&g.allowPartial)break;else if(null==h){n=void 0;break}h=h instanceof Backbone.Collection?h.at(a[k]):!h[a[k]]&&h instanceof Backbone.Model&&h.has(a[k])?d.bind(u,h,a[k]):k<a.length-1||g.evalVal?d.resultBB(h,a[k]):h[a[k]];if("undefined"===typeof h){g.allowPartial||(n=void 0);break}n.push(h)}a=void 0!==n&&null!==n&&0<n.length?d.last(n):n;k=this._applyBindExpression(e,a,c);k!==a&&n.push(k);return n}},resolveModelExpressionValue:function(c,
e){var g=this.resolveModelExpression(c,e,{allowPartial:!1});return g=void 0!==g&&d.isArray(g)&&0<g.length?d.last(g):void 0},_applyBindExpression:function(c,e,m){if(d.has(c,"filter")&&d.isString(c.filter)){c=this.resolveModelPath(m,c.filter,{evalVal:!1,allowPartial:!1});if(d.isArray(c))c=d.last(c);else throw"Invalid filter, path does not exist";if(d.isFunction(c))e=c(e);else throw"Invalid filter, not a function";}else d.has(c,"pattern")&&d.isString(c.pattern)&&(e=g.format(c.Pattern,e));return e},bindModelPath:function(d,
c,e,a){this.bindModelExpression(d,{path:c},e,a)},bindModelExpression:function(e,f,g,a){var n=this.splitModelPath(f.path),k=this.resolveModelPath(e,n),h={model:e,expression:f,callback:g},s=function(a){var c=d.indexOf(k,a.model);return 0>c||c==n.length||0!==c&&!d.has(a.model.changed,n[c])?!1:!0};d.has(this,"_bindingCallbacks")||(this._bindingCallbacks=[]);h.checkCallback=d.bind(function(a,f){var q;q=!1;switch(a){case "change":q=Array.prototype.slice.call(arguments,1,arguments.length);q=s.apply(this,
q);break;case "add":case "remove":q=d.indexOf(k,f.collection),q=0<=q&&(q===k.length-1||d.indexOf(k,f.collection)===q+1)}if(q=q&&!((this instanceof Backbone.Model||this instanceof Backbone.Collection)&&d.has(f,"recipients")&&d.has(f.recipients,this.cid))){k=this.resolveModelPath(e,n);f.recipients=d.has(f,"recipients")?f.recipients:{};f.recipients[this.cid]=!0;g.apply(this,arguments);q=new c.Event;q.oldValue=h.value;var m=this.resolveModelExpression(h.model,h.expression),m=this._applyBindExpression(h.expression,
m,h.model),m=m.length===n.length+1?d.last(k):void 0;q.value=m;h.value=m;g.apply(this,[q])}},this);this._bindingCallbacks.push(h);e.on("all",h.checkCallback,this)},unbindModelPath:function(d,c,e){this.unbindModelExpression(d,{path:c},e)},unbindModelExpression:function(c,e,g){var a=d.find(this._bindingCallbacks,function(a){return a.model===c&&d.isEqual(a.expression,e)&&a.callback===g});c.off("all",a.checkCallback,this)},setModelPathValue:function(c,e,g,a){a=void 0===a?!0:a;e=d.isArray(e)?e:this.splitModelPath(e);
c=this.resolveModelPath(c,e,{evalVal:!1,allowPartial:!1});var n=c.length,k=c[n-1];a&&d.isFunction(k)?k(g):k instanceof Backbone.Collection?c[n-2].update(g):c[n-2][e[n-1]]=g}};return c});
(function(e,d){"function"===typeof define&&define.amd?define(["jQuery","underscore","XUtil","XMVVM-Model"],function(g,c,m,p){return e.XMVVM=d(g,c,m,p)}):e.XMVVM=d(e.jQuery,e._,e.XUtil,e.XMVVM)})(this,function(e,d,g,c){c.Binding=function(){};c.Binding.extend=g.extendClass;c.AttributeBinding=c.Binding.extend({constructor:function(a){this.options=g.extend({},a);this.options=d.defaults(this.options,this.defaults);if(null===this.options.model||null===this.options.path||null===this.options.el||null===this.options.attr)throw"model, path, el, and attr options are required";
"value"!==this.options.attr&&(this.options.updateModel=!1);this.$el=e(this.options.el);d.bindAll(this,"value","setModelAttr","modelChanged","bindModel","unbindModel","bindEl","setElProp","elChanged","dispose");this.bindModel();this.bindEl();this.initialize()},initialize:function(){this.options.updateElement&&this.setElProp(this.value());this.options.updateModel&&this.setModelAttr(this.$el.attr(this.options.attr))},defaults:{model:null,expression:null,el:null,attr:null,updateModel:!0,updateElement:!0},
bindModel:function(){this._modelPath=this.resolveModelExpression(this.options.model,this.options.expression,{evalVal:!1,allowPartial:!1});this.bindModelExpression(this.options.model,this.options.expression,this.modelChanged)},unbindModel:function(){this.unbindModelExpression(this.options.model,this.options.expression,this.modelChanged)},value:function(){if("undefined"!==typeof this._modelPath&&0!==this._modelPath.length){var a=this._modelPath[this._modelPath.length-1];return d.isFunction(a)?a():a}},
setModelAttr:function(a){var c=this._modelPath;if(void 0===c||null===c)throw"Xintricity cannot set model value, expression does not exist: "+this.options.expression.path;var k=c.length,h=this.splitModelPath(this.options.expression.path);if(0<k&&d.isFunction(c[k-1]))c[k-1](a);else c[k-2][d.last(h)]=a},modelChanged:function(a,d,c){this._modelPath=this.resolveModelExpression(this.options.model,this.options.expression,{evalVal:!1,allowPartial:!1});this.options.updateElement&&this.setElProp(this.value())},
bindEl:function(){if(3==this.options.el.nodeType)throw"Attribute binding cannot be used with text nodes";this.$el.on("change.binding",this.elChanged)},unbindEl:function(){this.$el.off("change.binding",this.elChanged);this._modelPath=null},setElProp:function(a){this.options.updateElement&&("value"===this.options.attr?this.$el.val(a):"data-xt-src"==this.options.attr&&this.$el.is("img")?this.$el.attr("src",a):this.$el.attr(this.options.attr,a))},elChanged:function(a,d){this.setModelAttr(e(a.target).val())},
dispose:function(){this.unbindModel();this.unbindEl()}});g.extend(c.AttributeBinding.prototype,c.ModelNavMixins);c.TextNodeBinding=c.Binding.extend({constructor:function(a){this.options=g.extend({},a);this.options=d.defaults(this.options,this.defaults);if(null===this.options.model||null===this.options.paths||0===this.options.paths.length||null===this.options.el||null==this.options.pattern)throw"model, path, el, and attr options are required";this.options.el instanceof e&&(this.options.el=this.options.el.get(0));
this._modelPaths={};this._callbacks={};d.bindAll(this,"initialize","value","modelChanged","bindModel","updateText","dispose");this.bindModel();this.initialize()},initialize:function(){this.updateText()},defaults:{model:null,paths:null,el:null,pattern:null},bindModel:function(a){var c=this;d.each(1===arguments.length?[a]:this.options.paths,function(a){c._callbacks[a]=d.bind(c.modelChanged,c,a);c.bindModelExpression(c.options.model,a,c._callbacks[a])})},value:function(a){a=this.resolveModelExpression(this.options.model,
a,{evalVal:!0,allowPartial:!1});return d.isArray(a)&&0<a.length?d.last(a):void 0},modelChanged:function(a){this.updateText()},updateText:function(){var a=this,c=[a.options.pattern],k=!1;d.each(a.options.paths,function(h){d.has(h,"html")&&"true"===h.html?(c.push(a.value(h)),k=!0):(h=(h=a.value(h))?a.escapeHtml(h):h,c.push(h))});var h=g.format.apply(this,c).replace(/&#123;/,"{").replace(/&#125;/,"}");if(k){var s=document.createElement("div"),f=e(a.options.el).parent().get(0),m=a.options.el;m instanceof
NodeList||(m=[a.options.el]);s.innerHTML="<div>"+h+"</div>";s=s.children;d.each(s,function(a){f.insertBefore(a,m[0])});d.each(m,function(a){f.removeChild(a)});0<e(s).parents("html").length&&e(s).filter("script").each(function(){e.globalEval(this.text||this.textContent||this.innerHTML||"")});a.options.el=s}else a.options.el.nodeValue=h},escapeHtml:function(a){return a.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},dispose:function(){var a=this;d.each(this.options.paths,
function(d){a.unbindModelExpression(a.options.model,d,a._callbacks[d])});delete a._callbacks;delete a._modelPaths}});g.extend(c.TextNodeBinding.prototype,c.ModelNavMixins);c.CssClassBinding=c.Binding.extend({constructor:function(a){this.options=g.extend({},a);this.options=d.defaults(this.options,this.defaults);if(null===this.options.model||null===this.options.path||null===this.options.el||null===this.options.cssClass)throw"model, path, cssClass, and el are required";this.$el=e(this.options.el);d.bindAll(this,
"value","modelChanged","bindModel","unbindModel","setElClasses","dispose");this.bindModel();this.initialize()},initialize:function(){this.setElClasses(this.value())},defaults:{model:null,expression:null,el:null,attr:null},bindModel:function(){this._modelPath=this.resolveModelExpression(this.options.model,this.options.expression,{evalVal:!1,allowPartial:!1});this.bindModelExpression(this.options.model,this.options.expression,this.modelChanged)},unbindModel:function(){this.unbindModelExpression(this.options.model,
this.options.expression,this.modelChanged)},value:function(){if("undefined"!==typeof this._modelPath&&0!==this._modelPath.length){var a=this._modelPath[this._modelPath.length-1];return d.isFunction(a)?a():a}},modelChanged:function(a,d,c){this._modelPath=this.resolveModelExpression(this.options.model,this.options.expression,{evalVal:!1,allowPartial:!1});this.setElClasses(this.value())},setElClasses:function(a){a?this.$el.addClass(this.options.cssClass,a):this.$el.removeClass(this.options.cssClass,
a)},dispose:function(){this.unbindModel()}});g.extend(c.CssClassBinding.prototype,c.ModelNavMixins);c.SelectBinding=c.Binding.extend({constructor:function(a){this.options=g.extend({},a);this.options=d.defaults(this.options,this.defaults);if(null===this.options.model||null===this.options.path||null===this.options.el)throw"model, path, and el options are required";this.$el=e(this.options.el);d.bindAll(this,"value","bindModel","unbindModel","modelChanged","bindEl","createOptions","dispose");this.bindModel();
this.bindEl();this.initialize()},initialize:function(){var a=this.$el.val();this.createOptions(this.value());this.$el.val()!=a&&this.$el.trigger("change")},defaults:{model:null,path:null,el:null,textField:"name",valueField:"value"},bindModel:function(){this._modelPath=this.resolveModelPath(this.options.model,this.options.path,{evalVal:!1,allowPartial:!1});this.bindModelPath(this.options.model,this.options.path,this.modelChanged)},unbindModel:function(){var a=this;d.each(a._bindingCallbacks,function(d,
c){a.unbindModelPath(d.model,d.path,d.callback)});this._bindingCallbacks=[]},value:function(){if("undefined"!==typeof this._modelPath&&0!==this._modelPath.length){var a=this._modelPath[this._modelPath.length-1];return d.isFunction(a)?a():a}},modelChanged:function(a,d,c){this._modelPath=this.resolveModelPath(this.options.model,this.options.path,{evalVal:!1,allowPartial:!1});this.createOptions(this.value())},bindEl:function(){if(!this.options.el.is("select"))throw"el must be of node type <select>";
e(this.options.el)},unbindEl:function(){e(t.options.el).off("change.binding",t.elChanged);this._modelPath=null},createOptions:function(a){var c=this,k=e(c.options.el),h=k.val();k.empty();var f=function(a,h,f){h=d.resultBB(a,c.options.textField);a=d.resultBB(a,c.options.valueField);f=e(document.createElement("option"));f.text(h).val(a);k.append(f)};a instanceof Backbone.Collection?a.each(f):d.each(a,f);k.val(h)},dispose:function(){this.unbindModel();this.unbindEl()}});g.extend(c.SelectBinding.prototype,
c.ModelNavMixins);c.Trigger=function(a){if(null===arguments||0===arguments.length)a={};this.options=d.defaults(a,this.defaults);this.initialize.apply(this)};g.extend(c.Trigger.prototype,{defaults:{el:null,event:"click"},initialize:function(){this.bind()},onTrigger:function(){},onTriggerInv:function(){},bind:function(){var a=e(this.options.el);switch(this.options.event){case null:throw"Event name cannot be null";case "hover":a.on("mouseenter.binding",this.onTrigger);a.on("mouseleave.binding",this.onTriggerInv);
break;default:a.on(this.options.event+".binding",this.onTrigger)}},unbind:function(){var a=e(this.options.el);switch(this.options.event){case null:throw"Event name cannot be null";case "hover":a.off("mouseenter.binding",this.onTrigger);a.on("mouseleave.binding",this.onTriggerInv);break;default:a.off(this.options.event+".binding",this.onTrigger)}},dispose:function(){this.unbind()}});c.Trigger.extend=g.extendClass;c.StyleTrigger=c.Trigger.extend({initialize:function(){d.bindAll(this,"onTrigger","onTriggerInv",
"bind","unbind","dispose");this.bind()},defaults:{el:null,event:"click",target:null},onTrigger:function(){var a=this,c=e(a.options.el),k=c;null!=a.options.target&&(k=a.getTarget(c));null!=a.options.cssClass&&(a.options.cssClass instanceof Array?d.each(a.options.cssClass,function(a,d,c){k.addClass(a)}):k.addClass(a.options.cssClass));null!=a.options.styles&&(a.prevStyles={},d.each(a.options.styles,function(d,c,e){a.prevStyles[c]=k.css(c);k.css(c,d)}))},onTriggerInv:function(){var a=$el;null!=t.options.target&&
(a=t.getTarget($el));null!=this.options.cssClass&&(this.options.cssClass instanceof Array?d.each(this.options.cssClass,function(d,c,h){a.removeClass(d)}):a.removeClass(this.options.cssClass));null!=this.options.styles&&(this.prevStyles={},d.each(this.options.styles,function(d,c,h){a.css(c,this.prevStyles[c])}))},getTarget:function(a){return a}});g.extend(c.StyleTrigger.prototype,c.ModelNavMixins);c.ActionTrigger=c.Trigger.extend({defaults:{el:null,event:"click",context:{},action:null,value:void 0},
initialize:function(){d.bindAll(this,"onTrigger","onTriggerInv","bind","unbind","dispose");this.bind()},onTrigger:function(){if(null!=this.options.context&&null!=this.options.action){var a=this.resolveModelExpression(this.options.context,this.options.action,{evalVal:!1});d.isArray(a)&&(a=d.last(a));var c=this.options.value,k=void 0!==this.options.value;k&&d.has(c,"path")&&(c=this.resolveModelExpressionValue(this.options.context,c));void 0!==a&&k?a(c):void 0!==a&&a()}}});g.extend(c.ActionTrigger.prototype,
c.ModelNavMixins);var m=function(a){var c=this;c.options=g.extend({},a);0<arguments.length&&d.defaults(c.options,c.defaults);c._bindings=[];c._triggers=[];c._logicBlocks=[];c._nestedTemplates=[];c.excludeNestedScopes=function(a){return 0<e(this).parentsUntil(c.$el,"[data-xt-foreach],[data-xt-if],[data-xt-elseif],[data-xt-else]").length};c.options.el&&(c.options.el instanceof e&&(c.options.el=c.options.el.get(0)),c.el=c.options.el,c.$el=e(c.el));c.initialize();c.options.el&&d.isString(c.options.type)&&
c.parse()};m.attributeBindingPattern=/^\{\{[a-zA-Z][\w\._]*\}\}$/;m.textBindingPattern=/\{\{([a-zA-Z][\w\._]*|([a-zA-z]\w*\s*=\s*('[^']*'|"[^"]*"),?\s*)+)\}\}/g;m.extend=g.extendClass;g.extend(m.prototype,{defaults:{el:null,type:"template"},initialize:function(){},parse:function(){var a=this;a.parseTriggers();a.parseForeaches();a.parseIfs();a.parseTemplates();a.parseSelectBindings();a.$el.find("*").not(a.excludeNestedScopes).each(function(c,d){a.parseAttributeBindings(d);a.parseCssClassBindings(d);
a.parseTextBindings(d)})},parseTriggers:function(){var a=this;a.$el.find("[data-xt-event]").not(a.excludeNestedScopes).each(function(n,k){var h=e(k),f=h.parent(),f={el:f,position:a.calculatePosition(f,a.$el)},g=h.data("xt-action"),l=h.data("xt-value"),q=h.data("xt-style"),p=h.data("xt-class");if(g)f.type=c.ActionTrigger,f.action=a.parseBinding(g,!1),void 0!==l&&(f.value=a.parseBinding(l,!1)),f.event=h.data("xt-event");else if(null!=q||null!=p)f.type=c.StyleTrigger,f.styles={},null!=q&&(q=h.data("xt-style").split(";"),
d.each(f.styles,function(a){a=a.split(":");option.styles[a[0].trim()]=a[1].trim()})),null!=p&&(f.cssClass=p);h.remove();a._triggers.push(new m(f))})},parseForeaches:function(){var a=this;a.$el.find("[data-xt-foreach]").not(a.excludeNestedScopes).each(function(c,d){var h=e(d),f=new m({el:d,type:"foreach",position:a.calculatePosition(h,a.$el),expression:a.parseBinding(h.data("xt-foreach")),iterator:h.data("xt-iterator")});h.is("[data-xt-onrender]")&&(f.options.onrender=a.parseBinding(h.data("xt-onrender")));
a._logicBlocks.push(f)})},parseIfs:function(){var a=this;a.$el.find("[data-xt-if]").not(a.excludeNestedScopes).each(function(c,d){var h=e(d),f=h.next(),g=new m({el:d,type:"if",position:a.calculatePosition(h,a.$el),branches:[],defaultBranch:null}),l=new m({el:h,type:"branch",expression:a.parseBinding(h.data("xt-if"))});h.is("[data-xt-onrender]")&&(l.options.onrender=a.parseBinding(h.data("xt-onrender")));for(g.options.branches.push(l);f.is("[data-xt-elseif]");)l=new m({el:f,type:"branch",expression:a.parseBinding(h.data("xt-elseif"))}),
f.is("[data-xt-onrender]")&&(l.options.onrender=a.parseBinding(f.data("xt-onrender"))),g.options.branches.push(l),f=f.next();f.is("[data-xt-else]")&&(g.options.defaultBranch=new m({el:f,type:"else"}),f.is("[data-xt-onrender]")&&(g.options.defaultBranch.options.onrender=a.parseBinding(f.data("xt-onrender"))));a._logicBlocks.push(g)})},parseTemplates:function(){var a=this;a.$el.find("[data-xt-template]").not(a.excludeNestedScopes).each(function(c,d){var h=e(d);a._nestedTemplates.push(new m({el:d,type:"templateref",
position:a.calculatePosition(h,a.$el),template:h.data("xt-template"),model:a.parseBinding(h.data("xt-model"))}))})},parseAttributeBindings:function(a){var f=e(a),k=this;d.each(a.attributes,function(a){var e=a.name;"data-xt-"===e.substr(0,8)&&"data-xt-src"!==e||"id"===e||"type"===e||(a=a.value,a=k.parseBinding(a),d.isObject(a)&&k._bindings.push({expression:a,type:c.AttributeBinding,position:k.calculatePosition(f,k.$el),attr:e}))})},parseCssClassBindings:function(a){var f=e(a),k=this;a=d.filter(a.attributes,
function(a){return d.startsWith(a.name,"data-xt-class-")});d.each(a,function(a){var e=a.name;a=a.value;a=k.parseBinding(a);d.isObject(a)&&k._bindings.push({expression:a,type:c.CssClassBinding,position:k.calculatePosition(f,k.$el),cssClass:e.substr(14)})})},parseTextBindings:function(a){var f=this;a=e(a).contents();d.each(a.filter(function(){return 3==this.nodeType}),function(a){for(var h=[],g=null;g=m.textBindingPattern.exec(a.nodeValue);)h.push(g[0]);if(null!=h&&0<h.length){var l=d.uniq(h),h=d.map(l,
function(a){return f.parseBinding(a)}),g=a.nodeValue,g=g.replace(/\{/,"&#123;").replace(/\}/,"&#125;"),g=a.nodeValue.replace(m.textBindingPattern,function(a){return"{"+d.indexOf(l,a)+"}"});f._bindings.push({type:c.TextNodeBinding,paths:h,pattern:g,position:f.calculatePosition(e(a),f.$el)})}})},parseSelectBindings:function(a){var d=this,k;d.$el.find("select[data-xt-options]").not(d.excludeNestedScopes).each(function(a,f){var g=e(f);k=g.data("xt-options");var l={el:f,type:c.SelectBinding,path:k.substr(2,
k.length-4),position:d.calculatePosition(g,d.$el)},m=g.data("xt-text-field"),g=g.data("xt-value-field");void 0!==m&&null!==m&&(l.textField=m);void 0!==g&&null!==g&&(l.valueField=g);d._bindings.push(l)})},parseBinding:function(a,d){var c={},e,f=/^\{\{(?:\s*(Path|Filter|Pattern|HTML)\s*=\s*(?:'([^']*)'|"([^"]*)")\s*\,?)+\}\}$/ig,g=/(Path|Filter|Pattern|HTML)\s*=\s*('[^']*'|"[^"]*")\s*/ig;1===arguments.length&&(d=!0);e=a.match(/^\{\{([\w\.\[\]]+)\}\}$/i);if(null!==e&&1<e.length)c.path=e[1];else if(d)if(null!==
f.exec(a)){for(;e=g.exec(a);)c[e[1].toLowerCase()]=e[2].substring(1,e[2].length-1);c.hasOwnProperty("path")||(c=void 0)}else c=a;else c=a;return c},createInstance:function(a){if("template"!==this.options.type)throw"Invalid object type";return new v({block:this})},calculatePosition:function(a,d){a=e(a);d=e(d);var c=a.parentsUntil(d);if(0!==a.closest(d).length){var f=[a.parent().contents().index(a)];c.each(function(a,d){var c=e(d);f.unshift(c.parent().contents().index(c))});return f}}});var p=function(a){this.options=
g.extend({},a);0<arguments.length&&(d.defaults(this.options,this.defaults),a.el&&this.setEl(a.el));this.initialize()};p.extend=g.extendClass;g.extend(p.prototype,{defaults:{block:null,context:null,el:null},initialize:function(){this._bindings=[];this._triggers=[];this._logicBlocks=[];this._nestedTemplates=[];d.bindAll(this,"render")},render:function(){},renderInternal:function(a,c,k){var h=this;a=a?a:this.options.block;var m=e(c);d.each(a._triggers,function(a,d){var c=a.options.type,e=g.extend({},
a.options);e.el=h.resolveElement(m,a.options.position);e.context=k;delete e.type;delete e.position;h._triggers.push(new c(e))});d.each(a._logicBlocks,function(a,c){var d=h.resolveElement(m,a.options.position);switch(a.options.type){case "if":d=new l({block:a,context:k,el:d});break;case "foreach":d=new f({block:a,context:k,el:d});break;default:throw"Unknown logic block";}h._logicBlocks.push(d);d.render()});d.each(a._bindings,function(a,d){var c=h.resolveElement(m,a.position),c=g.extend({},a,{model:k,
el:c});delete c.position;c=new a.type(c);h._bindings.push(c)});d.each(a._nestedTemplates,function(a,c){var d=h.resolveElement(m,a.options.position),d=new u({block:a,context:k,el:d});h._nestedTemplates.push(d);d.render()})},setEl:function(a){this.el=a;this.$el=e(a)},resolveElement:function(a,c){var e=a;d.each(c,function(a){e=e.contents().eq(a)});return e},clear:function(){d.each(this._bindings,function(a){a.dispose()});this._bindings=[];d.each(this._triggers,function(a){a.dispose()});this._triggers=
[];d.each(this._logicBlocks,function(a){a.dispose()});this._logicBlocks=[];d.each(this._nestedTemplates,function(a){a.dispose()});this._nestedTemplates=[];this.$el.empty()},dispose:function(){this.clear()},createContext:function(a,e){var f;f=null!=e?this.options.context.clone():new c.Model;d.each(a,function(a,c,e){f.set(c,a);d.isUndefined(a)||d.isNull(a)||f.createField(c,{type:a.constructor})});return f}});g.extend(p.prototype,c.ModelNavMixins);var v=p.extend({initialize:function(){p.prototype.initialize.apply(this);
d.bindAll(this,"render")},render:function(){var a=this.options.block;this.setEl(e(a.el).clone());var c=this.createContext(this.options.context);this.renderInternal(a,this.$el,c);this.$el.removeClass("xt-template")}}),u=p.extend({initialize:function(){p.prototype.initialize.apply(this);d.bindAll(this,"modelChanged","render");var a=this.options.block.options.model;this.bindModelExpression(this.options.context,a,this.modelChanged);this.model=this.resolveModelExpressionValue(this.options.context,a)},
modelChanged:function(){var a=t.options.block.model;t.unbindModelPath(t.options.context,a,t.modelChanged);t.bindModelExpression(t.options.context,a,t.modelChanged);t.model=t.resolveModelExpressionValue(t.options.context,a)},render:function(){var a=this.options.block;this.clear();g.template(a.options.template)("destroy",this.$el);a=g.template(a.options.template)(this.model);this.$el.replaceWith(a);this.setEl(a)}}),l=p.extend({initialize:function(){var a=this,c=a.options.block;a.current=null;for(var e=
a.$el.next();0<e.filter("[data-xt-else-if]").length;)a.$el=a.$el.add(e),e=e.next();0<e.filter("[data-xt-else]").length&&(a.$el=a.$el.add(e));p.prototype.initialize.apply(a);d.bindAll(a,"render");this.branches=[];d.each(c.options.branches,function(c,e){var f={};f.callback=d.bind(a.modelChanged,a,e);f.value=a.resolveModelExpressionValue(a.options.context,c.options.expression);null===a.current&&f.value&&(a.current=e);a.bindModelExpression(a.options.context,c.options.expression,f.callback);a.branches.push(f)})},
modelChanged:function(a){var c=this.options.block,d=this.branches[a],e=d.value;d.value=this.resolveModelExpressionValue(this.options.context,c.options.branches[a].options.expression);if((null===this.current||a<=this.current)&&d.value!=e){a=null;for(d=0;d<this.branches.length;d++)if(this.branches[d].value){a=d;break}null===a&&null!==c.options.defaultBranch&&(a=this.branches.length);this.current=a;this.render()}},render:function(){var a=this.options.block.options,c=null!==this.current&&this.current<
this.branches.length?a.branches[this.current]:a.defaultBranch;this.clear();var f=null;c?(f=e(c.options.el).clone(),f.removeAttr("data-xt-if"),this.renderInternal(c,f,this.options.context)):f=document.createTextNode("");for(var g=0;g<this.branches.length-1;g++)f=f.add(document.createTextNode(""));null!==a.defaultBranch&&(f=f.add(document.createTextNode("")));this.$el.eq(0).prev().length?f.insertBefore(this.$el.eq(0)):this.$el.eq(0).parent().prepend(f);this.$el.remove();this.setEl(f);d.has(c.options,
"onrender")&&(a=this.resolveModelExpression(this.options.context,c.options.onrender),d.isArray(a)&&0<a.length&&(a=d.last(a),a(f)))}}),f=p.extend({initialize:function(){p.prototype.initialize.apply(this);var a=this.options.block.options.expression;d.bindAll(this,"render","modelChanged");this.bindModelExpression(this.options.context,a,this.modelChanged);this.value=this.resolveModelExpressionValue(this.options.context,a)},modelChanged:function(a){var c=this.options.block.options.expression,d=this.resolveModelExpressionValue(this.options.context,
c);a=this.value!=d||"add"===a||"remove"===a;this.value=d;a&&(this.value=this.resolveModelExpressionValue(this.options.context,c),this.render())},render:function(){var a=this,c=a.options.block;a.clear();if(a.value&&0<a.value.length){var f=c.options.iterator;c.$el.clone().children();a.$el.removeAttr("data-xt-foreach");a.$el.removeAttr("data-xt-iterator");var g=function(d,g,h){g={};g[f]=d;d=a.createContext(g,a.options.context);g=e(c.el).clone();a.renderInternal(a.options.block,g,d);a.$el.append(g.children())};
a.value instanceof Backbone.Collection?a.value.forEach(g):d.each(a.value,g)}d.has(c.options,"onrender")&&(g=a.resolveModelExpression(a.options.context,c.options.onrender),d.isArray(g)&&0<g.length&&(g=d.last(g),g($next)))}}),r={};c.Template=function(a,c){this.block=a;this.context=c;this.tmplID=Math.floor(1E8*Math.random());r[this.tmplID]=this};g.extend(c.Template.prototype,{render:function(){var a=new v({block:this.block,context:this.context});a.render();a=a.$el;a.data("template-id",this.tmplID);return a.children()},
dispose:function(){}});c.Template.compile=function(){var a;if(2<arguments.length)throw"Invalid arguments";a=arguments[0]instanceof e?arguments[0]:e(arguments[0]);a=e("<div></div>").append(a);var f=new m({el:a});return 2===arguments.length&&!0===arguments[1]?f:function(a,h,m){if(!d.isString(a)){m=h;var l={model:a};m&&m.context&&g.extend(l,m.context);return(new c.Template(f,l)).render()}a=arguments[0];if(!d.isString(a))throw"Invalid argument (1), String expected";switch(a){case "destroy":if(2!==arguments.length)throw"Invalid number of arguments";
l=arguments[1];if(!(l instanceof e))throw"Invalid argument (2), jQuery expected";l.data("template-id")&&r[l.data("template-id")].dispose()}}};"undefined"!==typeof test&&(c.templateInstances=r);return c});
