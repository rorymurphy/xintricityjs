var XUtil=XUtil||{};
(function(k,c,d,b){d.namespace=function(c){c=c.split(".");var d;k.each(c,function(c,f){0==c&&(d=b);f in d||(d[f]={});d=d[f]});return d};d.format=function(c){var b=arguments;return c=c.replace(/\{(\d+)\}/ig,function(c,f,e,s){return b[parseInt(f)+1]})};var l=/\/[^w_]+\//;d.slugify=function(c){return c.replace(l,"-").toLowerCase()};d.extend=function(b){c.each(Array.prototype.slice.call(arguments,1),function(c){if(c)for(var d in c){var f=c.__lookupGetter__(d),e=c.__lookupSetter__(d);f||e?(f&&b.__defineGetter__(d,
f),e&&b.__defineSetter__(d,e)):b[d]=c[d]}});return b};d.noConflict=function(){XUtil.__$x?window.$x=XUtil.__$x:delete window.$x}})(jQuery,_,XUtil,this);"undefined"!==typeof $x&&(XUtil.__$x=$x);$x=XUtil;
(function(k,c,d){var b=function(){c.bindAll(this,"initialize","addTemplate")};b.prototype={_templates:{},_templateTypes:{},initialize:function(){},getTemplate:function(b){l();c.has(this._templates,b)||this.addTemplate(b);return this._templates[b]},addTemplate:function(b,d,f){l();if(void 0===f||null===f){var e=k("#"+b);if(0==e.length)throw"Must specify a name that corresponds to a template element or provide the template text";e.is('script[type^="text/template"]');f=e.html();void 0===d&&(d=e.data("template"),
void 0===d&&(e=e.attr("type"),e=/^text\/template-(.+)$/.exec(e),1<e.length&&(d=e[1])))}if(!c.has(this._templateTypes,d))throw"Unrecognized template type";d=this._templateTypes[d](f);this._templates[b]=d},registerTemplateType:function(c,b){this._templateTypes[c]=b}};var l=function(){c.has(this._templateTypes,"underscore")||this.registerTemplateType("underscore",function(b){return c.template(b)});c.has(this._templateTypes,"mustache")||"undefined"==typeof Mustache||this.registerTemplateType("mustache",
function(c){return Mustache.compile(c)});c.has(this._templateTypes,"handlebars")||"undefined"==typeof Handlebars||this.registerTemplateType("handlebars",function(c){return Handlebars.compile(c)});c.has(this._templateTypes,"xintricity")||"undefined"==typeof XMVVM||this.registerTemplateType("xintricity",function(c){return XMVVM.Template.compile(c)})},n=new b;d.template=function(c){return n.getTemplate(c)};d.template.addTemplate=function(){n.addTemplate.apply(n,arguments)};d.template.registerTemplateTypes=
function(){n.registerTemplateType.apply(n,arguments)};l=c.bind(l,n)})(jQuery,_,XUtil);
(function(k,c,d){var b=d.namespace("XMVVM");Backbone.Model.isParentTypeOf=function(c){return Backbone.Model.prototype.isPrototypeOf(c.prototype)};Backbone.Collection.isParentTypeOf=function(c){return Backbone.Collection.prototype.isPrototypeOf(c.prototype)};var l=d.extendClass=function(f,e){var b=this,a;a=f&&c.has(f,"constructor")?f.constructor:function(){return b.apply(this,arguments)};d.extend(a,b,e);var m=function(){this.constructor=a};m.prototype=b.prototype;a.prototype=new m;f&&d.extend(a.prototype,
f);a.__super__=b.prototype;return a},n=function(f,e){c.isFunction(e)&&(e={type:e},this.fields[f]=e);this.fields&&!c.has(this,"fields")&&(this.fields=d.extend({},this.fields));c.has(this.fields,f)||(this.fields[f]=e);this.fields[f].name=f;this[f]=c.bind(function(){if(1===arguments.length)this.set(f,arguments[0]);else return this.get(f)},this)};c.mixin({resultBB:function(f,e,b){void 0===b&&(b=!0);var a=f[e];void 0===a&&f instanceof Backbone.Model&&(a=f.get(e));void 0!==a&&b&&c.isFunction(a)&&(a=a());
return a},startsWith:function(c,e){return c.substr(0,e.length)===e},endsWith:function(c,e){var b=c.length-e.length;return 0<=b&&c.substr(b)===e}});var r=0;b.Event=function(c){this.eid="e"+r;r++;d.extend(this,c)};b.Event.extend=l;b.Model=Backbone.Model.extend({constructor:function(f,e){var b=this;c.defaults(b,{fields:{}});c.each(this.fields,function(a,c,h){b.createField(c,a)});Backbone.Model.apply(this,[f,e]);c.bindAll(this,"createField","set")},fields:{},createField:function(c,e){n.call(this,c,e)},
clone:function(){var f=Backbone.Model.prototype.clone.apply(this);c.each(this.fields,function(c,b,a){f.createField(b,c)});return f},trigger:function(c){var e=Array.prototype.slice.call(arguments),d;if(1<arguments.length&&!(arguments[1]instanceof b.Event)){var e=c,a=c.indexOf(":");-1!==a&&(e=c.substr(0,a+1));switch(e){case "add":case "remove":case "destroy":d=new b.Event({model:arguments[1],collection:arguments[2],options:arguments[3]});break;case "reset":case "sort":d=new b.Event({collection:arguments[1],
options:arguments[2]});break;case "change":d=new b.Event({model:arguments[1],options:arguments[2]});break;case "request":case "error":d=new b.Event({model:arguments[1],xhr:arguments[2],options:arguments[3]});break;case "sync":d=new b.Event({model:arguments[1],resp:arguments[2],options:arguments[3]});break;case "invalid":d=new b.Event({model:arguments[1],error:arguments[2],options:arguments[3]});break;case "route":d=new b.Event({params:arguments[1]});break;case "change:":d=new b.Event({model:arguments[1],
value:arguments[2],options:arguments[3]});break;case "route:":d=new b.Event({route1:arguments[1],route2:arguments[2],params:arguments[3]})}null!=d?Backbone.Model.prototype.trigger.apply(this,[c,d]):Backbone.Model.prototype.trigger.apply(this,arguments)}else 1==arguments.length?(this instanceof b.Model?d=new b.Event({model:this}):this instanceof b.Collection&&(d=new b.Event({collection:this})),e.push(d),Backbone.Model.prototype.trigger.apply(this,e)):Backbone.Model.prototype.trigger.apply(this,arguments)},
set:function(f,e,b){var a=this,m,h,g=a.fields;c.isObject(f)?(m=f,b=e):(m={})[f]=e;c.each(m,function(m,b,f){var d;if(null!=g&&c.has(g,b)&&(f=g[b],e=a._prepareValue(f,m),d=!0,c.isFunction(f.validate)&&(d=f.validate(m)),!0!==d))throw d;h=a[b];null!=h&&(h instanceof Backbone.Model||h instanceof Backbone.Collection)&&h.off("all",k,this);if(m instanceof Backbone.Model||m instanceof Backbone.Collection){var k=function(m,h){var g=Array.prototype.slice.call(arguments);c.has(h,"model")&&h.model===a||c.has(h,
"recipients")&&c.has(h.recipients,a.cid)||(h.recipients=h.recipients||{},h.recipients[a.cid]=!0,a.trigger.apply(a,g))};(f=a.get(b))&&f.off("all",k,a.cid+b);m.on("all",k,a.cid+b)}});Backbone.Model.prototype.set.apply(this,[m,b])},_prepareValue:function(b,e){if(void 0===e||null===e)return e;switch(b.type){case "int":"int"!==typeof e&&(e=parseInt(e));break;case Number:c.isNumber(e)||(e=parseFloat(e));break;case Boolean:c.isBoolean(e)||(e=!0==e);break;case String:c.isString(e)||(e+="");break;case Date:e instanceof
Date||(c.isNumber(e)?e=new Date(e):c.isString(e)&&(e=Date.parse(e)));break;case Array:if(!(e instanceof Array))throw"Type mismatch";break;default:if(!(e instanceof b.type))if((b.type===Backbone.Model||Backbone.Model.isParentTypeOf(b.type))&&c.isObject(e)||(b.type===Backbone.Collection||Backbone.Collection.isParentTypeOf(b.type))&&(c.isObject(e)||c.isArray(e)))e=new b.type(e);else if(!(e instanceof b.type))throw"Type mismatch";}return e},listenToEl:function(){if(3==arguments.length)this.$el.on(arguments[0],
arguments[1],arguments[2]);else if(2==arguments.length)this.$el.on(arguments[0],arguments[1])},parse:function(b){c.each(this.fields,function(c,d,a){if(Backbone.Model.isParentTypeOf(c.type)||Backbone.Collection.isParentTypeOf(c.type))b[c.name]=new c.type(b[c.name],{parse:!0})});return b},extend:function(b,e){l.call(this,b,e);c.has(b,"fields")&&c.each(b.fields,function(c,a){n.call(this,a,c)})}});b.Model.defaults={useGetSet:!1};b.Collection=Backbone.Collection.extend({unique:function(){var b=array.slice.call(arguments);
b.unshift(this.models);return c.unique.apply(c,b)},_onModelEvent:function(c,b,d,a){"add"!==c&&"remove"!==c||d===this?Backbone.Collection.prototype._onModelEvent.apply(this,arguments):this.trigger.apply(this,arguments)}});b.View=Backbone.View.extend({});b.ViewModel=b.Model.extend({model:null,view:null,render:function(){if(this.view)return d.template(this.view)(this.model)}});b.ViewModel.extend=l;var u=function(c,b){if(1==arguments.length)return this.get(c);this.set(c,b)};b.ModelNavMixins={splitModelPath:function(c){return c.match(/\w+(?=\.?)|(?=\[)\w+(?=\])/g)},
resolveModelPath:function(c,b,d){return this.resolveModelExpression(c,{path:b},d)},resolveModelExpression:function(b,e,d){var a=e.path;if(3>arguments.length||void 0===d)d={};d=c.defaults(d,{evalVal:!0,allowPartial:!0});var m=[b];if("undefined"!==typeof a&&null!==a&&""!==a){for(var a=a instanceof Array?a:this.splitModelPath(a),h=0;h<a.length;h++){var g=m[m.length-1];if(null==g&&d.allowPartial)break;else if(null==g){m=void 0;break}g=g instanceof Backbone.Collection?g.at(a[h]):!g[a[h]]&&g instanceof
Backbone.Model&&g.has(a[h])?c.bind(u,g,a[h]):h<a.length-1||d.evalVal?c.resultBB(g,a[h]):g[a[h]];if("undefined"===typeof g){d.allowPartial||(m=void 0);break}m.push(g)}a=void 0!==m&&null!==m&&0<m.length?c.last(m):m;h=this._applyBindExpression(e,a,b);h!==a&&m.push(h);return m}},resolveModelExpressionValue:function(b,e){var d=this.resolveModelExpression(b,e,{allowPartial:!1});return d=void 0!==d&&c.isArray(d)&&0<d.length?c.last(d):void 0},_applyBindExpression:function(b,e,k){if(c.has(b,"transform")&&
c.isString(b.transform)){b=this.resolveModelPath(k,b.transform,{evalVal:!1,allowPartial:!1});if(c.isArray(b))b=c.last(b);else throw"Invalid transform, path does not exist";if(c.isFunction(b))e=b(e);else throw"Invalid transform, not a function";}else c.has(b,"pattern")&&c.isString(b.pattern)&&(e=d.format(b.Pattern,e));return e},bindModelPath:function(c,b,d,a){this.bindModelExpression(c,{path:b},d,a)},bindModelExpression:function(d,e,k,a){var m=this.splitModelPath(e.path),h=this.resolveModelPath(d,
m),g={model:d,expression:e,callback:k},v=function(a){var b=c.indexOf(h,a.model);return 0>b||b==m.length||0!==b&&!c.has(a.model.changed,m[b])?!1:!0};c.has(this,"_bindingCallbacks")||(this._bindingCallbacks=[]);g.checkCallback=c.bind(function(a,e){var p;p=!1;switch(a){case "change":p=Array.prototype.slice.call(arguments,1,arguments.length);p=v.apply(this,p);break;case "add":case "remove":p=c.indexOf(h,e.collection),p=0<=p&&(p===h.length-1||c.indexOf(h,e.collection)===p+1)}if(p=p&&!((this instanceof
Backbone.Model||this instanceof Backbone.Collection)&&c.has(e,"recipients")&&c.has(e.recipients,this.cid))){h=this.resolveModelPath(d,m);e.recipients=c.has(e,"recipients")?e.recipients:{};e.recipients[this.cid]=!0;k.apply(this,arguments);p=new b.Event;p.oldValue=g.value;var l=this.resolveModelExpression(g.model,g.expression),l=this._applyBindExpression(g.expression,l,g.model),l=l.length===m.length+1?c.last(h):void 0;p.value=l;g.value=l;k.apply(this,[p])}},this);this._bindingCallbacks.push(g);d.on("all",
g.checkCallback,this)},unbindModelPath:function(c,b,d){this.unbindModelExpression(c,{path:b},d)},unbindModelExpression:function(b,d,k){var a=c.find(this._bindingCallbacks,function(a){return a.model===b&&c.isEqual(a.expression,d)&&a.callback===k});b.off("all",a.checkCallback,this)},setModelPathValue:function(b,d,k,a){a=void 0===a?!0:a;d=c.isArray(d)?d:this.splitModelPath(d);b=this.resolveModelPath(b,d,{evalVal:!1,allowPartial:!1});var m=b.length,h=b[m-1];a&&c.isFunction(h)?h(k):h instanceof Backbone.Collection?
b[m-2].update(k):b[m-2][d[m-1]]=k}}})(jQuery,_,XUtil);
(function(k,c,d){var b=d.namespace("XMVVM");b.Binding=function(){};b.Binding.extend=d.extendClass;b.AttributeBinding=b.Binding.extend({constructor:function(a){this.options=d.extend({},a);this.options=c.defaults(this.options,this.defaults);if(null===this.options.model||null===this.options.path||null===this.options.el||null===this.options.attr)throw"model, path, el, and attr options are required";"value"!==this.options.attr&&(this.options.updateModel=!1);this.$el=k(this.options.el);c.bindAll(this,"value",
"setModelAttr","modelChanged","bindModel","unbindModel","bindEl","setElProp","elChanged","dispose");this.bindModel();this.bindEl();this.initialize()},initialize:function(){this.options.updateElement&&this.setElProp(this.value());this.options.updateModel&&this.setModelAttr(this.$el.attr(this.options.attr))},defaults:{model:null,expression:null,el:null,attr:null,updateModel:!0,updateElement:!0},bindModel:function(){this._modelPath=this.resolveModelExpression(this.options.model,this.options.expression,
{evalVal:!1,allowPartial:!1});this.bindModelExpression(this.options.model,this.options.expression,this.modelChanged)},unbindModel:function(){this.unbindModelExpression(this.options.model,this.options.expression,this.modelChanged)},value:function(){if("undefined"!==typeof this._modelPath&&0!==this._modelPath.length){var a=this._modelPath[this._modelPath.length-1];return c.isFunction(a)?a():a}},setModelAttr:function(a){var b=this._modelPath;if(void 0===b||null===b)throw"Xintricity cannot set model value, expression does not exist: "+
this.options.expression.path;var h=b.length,g=this.splitModelPath(this.options.expression.path);if(0<h&&c.isFunction(b[h-1]))b[h-1](a);else b[h-2][c.last(g)]=a},modelChanged:function(a,c,b){this._modelPath=this.resolveModelExpression(this.options.model,this.options.expression,{evalVal:!1,allowPartial:!1});this.options.updateElement&&this.setElProp(this.value())},bindEl:function(){if(3==this.options.el.nodeType)throw"Attribute binding cannot be used with text nodes";this.$el.on("change.binding",this.elChanged)},
unbindEl:function(){this.$el.off("change.binding",this.elChanged);this._modelPath=null},setElProp:function(a){this.options.updateElement&&("value"===this.options.attr?this.$el.val(a):"data-xt-src"==this.options.attr&&this.$el.is("img")?this.$el.attr("src",a):this.$el.attr(this.options.attr,a))},elChanged:function(a,c){this.setModelAttr(k(a.target).val())},dispose:function(){this.unbindModel();this.unbindEl()}});d.extend(b.AttributeBinding.prototype,b.ModelNavMixins);b.TextNodeBinding=b.Binding.extend({constructor:function(a){this.options=
d.extend({},a);this.options=c.defaults(this.options,this.defaults);if(null===this.options.model||null===this.options.paths||0===this.options.paths.length||null===this.options.el||null==this.options.pattern)throw"model, path, el, and attr options are required";this.options.el instanceof k&&(this.options.el=this.options.el.get(0));this._modelPaths={};this._callbacks={};c.bindAll(this,"initialize","value","modelChanged","bindModel","updateText","dispose");this.bindModel();this.initialize()},initialize:function(){this.updateText()},
defaults:{model:null,paths:null,el:null,pattern:null},bindModel:function(a){var b=this;c.each(1===arguments.length?[a]:this.options.paths,function(a){b._callbacks[a]=c.bind(b.modelChanged,b,a);b.bindModelExpression(b.options.model,a,b._callbacks[a])})},value:function(a){a=this.resolveModelExpression(this.options.model,a,{evalVal:!0,allowPartial:!1});return c.isArray(a)&&0<a.length?c.last(a):void 0},modelChanged:function(a){this.updateText()},updateText:function(){var a=this,b=[a.options.pattern],
h=!1;c.each(a.options.paths,function(g){c.has(g,"html")&&"true"===g.html?(b.push(a.value(g)),h=!0):(g=(g=a.value(g))?a.escapeHtml(g):g,b.push(g))});var g=d.format.apply(this,b).replace(/&#123;/,"{").replace(/&#125;/,"}");if(h){var e=document.createElement("div"),q=k(a.options.el).parent().get(0),f=a.options.el;f instanceof NodeList||(f=[a.options.el]);e.innerHTML="<div>"+g+"</div>";e=e.children;c.each(e,function(a){q.insertBefore(a,f[0])});c.each(f,function(a){q.removeChild(a)});0<k(e).parents("html").length&&
k(e).filter("script").each(function(){k.globalEval(this.text||this.textContent||this.innerHTML||"")});a.options.el=e}else a.options.el.nodeValue=g},escapeHtml:function(a){return a.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},dispose:function(){var a=this;c.each(this.options.paths,function(c){a.unbindModelExpression(a.options.model,c,a._callbacks[c])});delete a._callbacks;delete a._modelPaths}});d.extend(b.TextNodeBinding.prototype,b.ModelNavMixins);
b.CssClassBinding=b.Binding.extend({constructor:function(a){this.options=d.extend({},a);this.options=c.defaults(this.options,this.defaults);if(null===this.options.model||null===this.options.path||null===this.options.el||null===this.options.cssClass)throw"model, path, cssClass, and el are required";this.$el=k(this.options.el);c.bindAll(this,"value","modelChanged","bindModel","unbindModel","setElClasses","dispose");this.bindModel();this.initialize()},initialize:function(){this.setElClasses(this.value())},
defaults:{model:null,expression:null,el:null,attr:null},bindModel:function(){this._modelPath=this.resolveModelExpression(this.options.model,this.options.expression,{evalVal:!1,allowPartial:!1});this.bindModelExpression(this.options.model,this.options.expression,this.modelChanged)},unbindModel:function(){this.unbindModelExpression(this.options.model,this.options.expression,this.modelChanged)},value:function(){if("undefined"!==typeof this._modelPath&&0!==this._modelPath.length){var a=this._modelPath[this._modelPath.length-
1];return c.isFunction(a)?a():a}},modelChanged:function(a,c,b){this._modelPath=this.resolveModelExpression(this.options.model,this.options.expression,{evalVal:!1,allowPartial:!1});this.setElClasses(this.value())},setElClasses:function(a){a?this.$el.addClass(this.options.cssClass,a):this.$el.removeClass(this.options.cssClass,a)},dispose:function(){this.unbindModel()}});d.extend(b.CssClassBinding.prototype,b.ModelNavMixins);b.SelectBinding=b.Binding.extend({constructor:function(a){this.options=d.extend({},
a);this.options=c.defaults(this.options,this.defaults);if(null===this.options.model||null===this.options.path||null===this.options.el)throw"model, path, and el options are required";this.$el=k(this.options.el);c.bindAll(this,"value","bindModel","unbindModel","modelChanged","bindEl","createOptions","dispose");this.bindModel();this.bindEl();this.initialize()},initialize:function(){var a=this.$el.val();this.createOptions(this.value());this.$el.val()!=a&&this.$el.trigger("change")},defaults:{model:null,
path:null,el:null,textField:"name",valueField:"value"},bindModel:function(){this._modelPath=this.resolveModelPath(this.options.model,this.options.path,{evalVal:!1,allowPartial:!1});this.bindModelPath(this.options.model,this.options.path,this.modelChanged)},unbindModel:function(){var a=this;c.each(a._bindingCallbacks,function(c,b){a.unbindModelPath(c.model,c.path,c.callback)});this._bindingCallbacks=[]},value:function(){if("undefined"!==typeof this._modelPath&&0!==this._modelPath.length){var a=this._modelPath[this._modelPath.length-
1];return c.isFunction(a)?a():a}},modelChanged:function(a,c,b){this._modelPath=this.resolveModelPath(this.options.model,this.options.path,{evalVal:!1,allowPartial:!1});this.createOptions(this.value())},bindEl:function(){if(!this.options.el.is("select"))throw"el must be of node type <select>";k(this.options.el)},unbindEl:function(){k(t.options.el).off("change.binding",t.elChanged);this._modelPath=null},createOptions:function(a){var b=this,h=k(b.options.el),g=h.val();h.empty();var d=function(a,g,d){g=
c.resultBB(a,b.options.textField);a=c.resultBB(a,b.options.valueField);d=k(document.createElement("option"));d.text(g).val(a);h.append(d)};a instanceof Backbone.Collection?a.each(d):c.each(a,d);h.val(g)},dispose:function(){this.unbindModel();this.unbindEl()}});d.extend(b.SelectBinding.prototype,b.ModelNavMixins);b.Trigger=function(a){if(null===arguments||0===arguments.length)a={};this.options=c.defaults(a,this.defaults);this.initialize.apply(this)};d.extend(b.Trigger.prototype,{defaults:{el:null,
event:"click"},initialize:function(){this.bind()},onTrigger:function(){},onTriggerInv:function(){},bind:function(){var a=k(this.options.el);switch(this.options.event){case null:throw"Event name cannot be null";case "hover":a.on("mouseenter.binding",this.onTrigger);a.on("mouseleave.binding",this.onTriggerInv);break;default:a.on(this.options.event+".binding",this.onTrigger)}},unbind:function(){var a=k(this.options.el);switch(this.options.event){case null:throw"Event name cannot be null";case "hover":a.off("mouseenter.binding",
this.onTrigger);a.on("mouseleave.binding",this.onTriggerInv);break;default:a.off(this.options.event+".binding",this.onTrigger)}},dispose:function(){this.unbind()}});b.Trigger.extend=d.extendClass;b.StyleTrigger=b.Trigger.extend({initialize:function(){c.bindAll(this,"onTrigger","onTriggerInv","bind","unbind","dispose");this.bind()},defaults:{el:null,event:"click",target:null},onTrigger:function(){var a=this,b=k(a.options.el),h=b;null!=a.options.target&&(h=a.getTarget(b));null!=a.options.cssClass&&
(a.options.cssClass instanceof Array?c.each(a.options.cssClass,function(a,c,b){h.addClass(a)}):h.addClass(a.options.cssClass));null!=a.options.styles&&(a.prevStyles={},c.each(a.options.styles,function(c,b,d){a.prevStyles[b]=h.css(b);h.css(b,c)}))},onTriggerInv:function(){var a=$el;null!=t.options.target&&(a=t.getTarget($el));null!=this.options.cssClass&&(this.options.cssClass instanceof Array?c.each(this.options.cssClass,function(c,b,g){a.removeClass(c)}):a.removeClass(this.options.cssClass));null!=
this.options.styles&&(this.prevStyles={},c.each(this.options.styles,function(c,b,g){a.css(b,this.prevStyles[b])}))},getTarget:function(a){return a}});d.extend(b.StyleTrigger.prototype,b.ModelNavMixins);b.ActionTrigger=b.Trigger.extend({defaults:{el:null,event:"click",context:{},action:null,value:void 0},initialize:function(){c.bindAll(this,"onTrigger","onTriggerInv","bind","unbind","dispose");this.bind()},onTrigger:function(){if(null!=this.options.context&&null!=this.options.action){var a=this.resolveModelExpression(this.options.context,
this.options.action,{evalVal:!1});c.isArray(a)&&(a=c.last(a));var b=this.options.value,h=void 0!==this.options.value;h&&c.has(b,"path")&&(b=this.resolveModelExpressionValue(this.options.context,b));void 0!==a&&h?a(b):void 0!==a&&a()}}});d.extend(b.ActionTrigger.prototype,b.ModelNavMixins);var l=function(a){var b=this;b.options=d.extend({},a);0<arguments.length&&c.defaults(b.options,b.defaults);b._bindings=[];b._triggers=[];b._logicBlocks=[];b._nestedTemplates=[];b.excludeNestedScopes=function(a){return 0<
k(this).parentsUntil(b.$el,"[data-xt-foreach],[data-xt-if],[data-xt-elseif],[data-xt-else]").length};b.options.el&&(b.options.el instanceof k&&(b.options.el=b.options.el.get(0)),b.el=b.options.el,b.$el=k(b.el));b.initialize();b.options.el&&c.isString(b.options.type)&&b.parse()};l.attributeBindingPattern=/^\{\{[a-zA-Z][\w\._]*\}\}$/;l.textBindingPattern=/\{\{([a-zA-Z][\w\._]*|([a-zA-z]\w*\s*=\s*('[^']*'|"[^"]*"),?\s*)+)\}\}/g;l.extend=d.extendClass;d.extend(l.prototype,{defaults:{el:null,type:"template"},
initialize:function(){},parse:function(){var a=this;a.parseTriggers();a.parseForeaches();a.parseIfs();a.parseTemplates();a.parseSelectBindings();a.$el.find("*").not(a.excludeNestedScopes).each(function(b,c){a.parseAttributeBindings(c);a.parseCssClassBindings(c);a.parseTextBindings(c)})},parseTriggers:function(){var a=this;a.$el.find("[data-xt-event]").not(a.excludeNestedScopes).each(function(d,h){var g=k(h),e=g.parent(),e={el:e,position:a.calculatePosition(e,a.$el)},q=g.data("xt-action"),f=g.data("xt-value"),
p=g.data("xt-style"),n=g.data("xt-class");if(q)e.type=b.ActionTrigger,e.action=a.parseBinding(q,!1),void 0!==f&&(e.value=a.parseBinding(f,!1)),e.event=g.data("xt-event");else if(null!=p||null!=n)e.type=b.StyleTrigger,e.styles={},null!=p&&(p=g.data("xt-style").split(";"),c.each(e.styles,function(a){a=a.split(":");option.styles[a[0].trim()]=a[1].trim()})),null!=n&&(e.cssClass=n);g.remove();a._triggers.push(new l(e))})},parseForeaches:function(){var a=this;a.$el.find("[data-xt-foreach]").not(a.excludeNestedScopes).each(function(b,
c){var g=k(c),d=new l({el:c,type:"foreach",position:a.calculatePosition(g,a.$el),expression:a.parseBinding(g.data("xt-foreach")),iterator:g.data("xt-iterator")});g.is("[data-xt-onrender]")&&(d.options.onrender=a.parseBinding(g.data("xt-onrender")));a._logicBlocks.push(d)})},parseIfs:function(){var a=this;a.$el.find("[data-xt-if]").not(a.excludeNestedScopes).each(function(b,c){var g=k(c),d=g.next(),e=new l({el:c,type:"if",position:a.calculatePosition(g,a.$el),branches:[],defaultBranch:null}),f=new l({el:g,
type:"branch",expression:a.parseBinding(g.data("xt-if"))});g.is("[data-xt-onrender]")&&(f.options.onrender=a.parseBinding(g.data("xt-onrender")));for(e.options.branches.push(f);d.is("[data-xt-elseif]");)f=new l({el:d,type:"branch",expression:a.parseBinding(g.data("xt-elseif"))}),d.is("[data-xt-onrender]")&&(f.options.onrender=a.parseBinding(d.data("xt-onrender"))),e.options.branches.push(f),d=d.next();d.is("[data-xt-else]")&&(e.options.defaultBranch=new l({el:d,type:"else"}),d.is("[data-xt-onrender]")&&
(e.options.defaultBranch.options.onrender=a.parseBinding(d.data("xt-onrender"))));a._logicBlocks.push(e)})},parseTemplates:function(){var a=this;a.$el.find("[data-xt-template]").not(a.excludeNestedScopes).each(function(b,c){var d=k(c);a._nestedTemplates.push(new l({el:c,type:"templateref",position:a.calculatePosition(d,a.$el),template:d.data("xt-template"),model:a.parseBinding(d.data("xt-model"))}))})},parseAttributeBindings:function(a){var d=k(a),h=this;c.each(a.attributes,function(a){var e=a.name;
"data-xt-"===e.substr(0,8)&&"data-xt-src"!==e||"id"===e||"type"===e||(a=a.value,a=h.parseBinding(a),c.isObject(a)&&h._bindings.push({expression:a,type:b.AttributeBinding,position:h.calculatePosition(d,h.$el),attr:e}))})},parseCssClassBindings:function(a){var d=k(a),h=this;a=c.filter(a.attributes,function(a){return c.startsWith(a.name,"data-xt-class-")});c.each(a,function(a){var e=a.name;a=a.value;a=h.parseBinding(a);c.isObject(a)&&h._bindings.push({expression:a,type:b.CssClassBinding,position:h.calculatePosition(d,
h.$el),cssClass:e.substr(14)})})},parseTextBindings:function(a){var d=this;a=k(a).contents();c.each(a.filter(function(){return 3==this.nodeType}),function(a){for(var e=[],f=null;f=l.textBindingPattern.exec(a.nodeValue);)e.push(f[0]);if(null!=e&&0<e.length){var q=c.uniq(e),e=c.map(q,function(a){return d.parseBinding(a)}),f=a.nodeValue,f=f.replace(/\{/,"&#123;").replace(/\}/,"&#125;"),f=a.nodeValue.replace(l.textBindingPattern,function(a){return"{"+c.indexOf(q,a)+"}"});d._bindings.push({type:b.TextNodeBinding,
paths:e,pattern:f,position:d.calculatePosition(k(a),d.$el)})}})},parseSelectBindings:function(a){var c=this,d;c.$el.find("select[data-xt-options]").not(c.excludeNestedScopes).each(function(a,e){var f=k(e);d=f.data("xt-options");var l={el:e,type:b.SelectBinding,path:d.substr(2,d.length-4),position:c.calculatePosition(f,c.$el)},p=f.data("xt-text-field"),f=f.data("xt-value-field");void 0!==p&&null!==p&&(l.textField=p);void 0!==f&&null!==f&&(l.valueField=f);c._bindings.push(l)})},parseBinding:function(a,
c){var b={},d,e=/^\{\{(?:\s*(Path|Transform|Pattern|HTML)\s*=\s*(?:'([^']*)'|"([^"]*)")\s*\,?)+\}\}$/ig,f=/(Path|Transform|Pattern|HTML)\s*=\s*('[^']*'|"[^"]*")\s*/ig;1===arguments.length&&(c=!0);d=a.match(/^\{\{([\w\.\[\]]+)\}\}$/i);if(null!==d&&1<d.length)b.path=d[1];else if(c)if(null!==e.exec(a)){for(;d=f.exec(a);)b[d[1].toLowerCase()]=d[2].substring(1,d[2].length-1);b.hasOwnProperty("path")||(b=void 0)}else b=a;else b=a;return b},createInstance:function(a){if("template"!==this.options.type)throw"Invalid object type";
return new r({block:this})},calculatePosition:function(a,c){a=k(a);c=k(c);var b=a.parentsUntil(c);if(0!==a.closest(c).length){var d=[a.parent().contents().index(a)];b.each(function(a,c){var b=k(c);d.unshift(b.parent().contents().index(b))});return d}}});var n=function(a){this.options=d.extend({},a);0<arguments.length&&(c.defaults(this.options,this.defaults),a.el&&this.setEl(a.el));this.initialize()};n.extend=d.extendClass;d.extend(n.prototype,{defaults:{block:null,context:null,el:null},initialize:function(){this._bindings=
[];this._triggers=[];this._logicBlocks=[];this._nestedTemplates=[];c.bindAll(this,"render")},render:function(){},renderInternal:function(a,b,h){var g=this;a=a?a:this.options.block;var l=k(b);c.each(a._triggers,function(a,c){var b=a.options.type,e=d.extend({},a.options);e.el=g.resolveElement(l,a.options.position);e.context=h;delete e.type;delete e.position;g._triggers.push(new b(e))});c.each(a._logicBlocks,function(a,c){var b=g.resolveElement(l,a.options.position);switch(a.options.type){case "if":b=
new f({block:a,context:h,el:b});break;case "foreach":b=new e({block:a,context:h,el:b});break;default:throw"Unknown logic block";}g._logicBlocks.push(b);b.render()});c.each(a._bindings,function(a,b){var c=g.resolveElement(l,a.position),c=d.extend({},a,{model:h,el:c});delete c.position;c=new a.type(c);g._bindings.push(c)});c.each(a._nestedTemplates,function(a,c){var b=g.resolveElement(l,a.options.position),b=new u({block:a,context:h,el:b});g._nestedTemplates.push(b);b.render()})},setEl:function(a){this.el=
a;this.$el=k(a)},resolveElement:function(a,b){var d=a;c.each(b,function(a){d=d.contents().eq(a)});return d},clear:function(){c.each(this._bindings,function(a){a.dispose()});this._bindings=[];c.each(this._triggers,function(a){a.dispose()});this._triggers=[];c.each(this._logicBlocks,function(a){a.dispose()});this._logicBlocks=[];c.each(this._nestedTemplates,function(a){a.dispose()});this._nestedTemplates=[];this.$el.empty()},dispose:function(){this.clear()},createContext:function(a,d){var e;e=null!=
d?this.options.context.clone():new b.Model;c.each(a,function(a,b,c){e.set(b,a);e.createField(b,{type:a.constructor})});return e}});d.extend(n.prototype,b.ModelNavMixins);var r=n.extend({initialize:function(){n.prototype.initialize.apply(this);c.bindAll(this,"render")},render:function(){var a=this.options.block;this.setEl(k(a.el).clone());var b=this.createContext(this.options.context);this.renderInternal(a,this.$el,b);this.$el.removeClass("xt-template")}}),u=n.extend({initialize:function(){n.prototype.initialize.apply(this);
c.bindAll(this,"modelChanged","render");var a=this.options.block.options.model;this.bindModelExpression(this.options.context,a,this.modelChanged);this.model=this.resolveModelExpressionValue(this.options.context,a)},modelChanged:function(){var a=t.options.block.model;t.unbindModelPath(t.options.context,a,t.modelChanged);t.bindModelExpression(t.options.context,a,t.modelChanged);t.model=t.resolveModelExpressionValue(t.options.context,a)},render:function(){var a=this.options.block;this.clear();d.template(a.options.template)("destroy",
this.$el);a=d.template(a.options.template)(this.model);this.$el.replaceWith(a);this.setEl(a)}}),f=n.extend({initialize:function(){var a=this,b=a.options.block;a.current=null;for(var d=a.$el.next();0<d.filter("[data-xt-else-if]").length;)a.$el=a.$el.add(d),d=d.next();0<d.filter("[data-xt-else]").length&&(a.$el=a.$el.add(d));n.prototype.initialize.apply(a);c.bindAll(a,"render");this.branches=[];c.each(b.options.branches,function(b,d){var e={};e.callback=c.bind(a.modelChanged,a,d);e.value=a.resolveModelExpressionValue(a.options.context,
b.options.expression);null===a.current&&e.value&&(a.current=d);a.bindModelExpression(a.options.context,b.options.expression,e.callback);a.branches.push(e)})},modelChanged:function(a){var b=this.options.block,c=this.branches[a],d=c.value;c.value=this.resolveModelExpressionValue(this.options.context,b.options.branches[a].options.expression);if((null===this.current||a<=this.current)&&c.value!=d){a=null;for(c=0;c<this.branches.length;c++)if(this.branches[c].value){a=c;break}null===a&&null!==b.options.defaultBranch&&
(a=this.branches.length);this.current=a;this.render()}},render:function(){var a=this.options.block.options,b=null!==this.current&&this.current<this.branches.length?a.branches[this.current]:a.defaultBranch;this.clear();var d=null;b?(d=k(b.options.el).clone(),d.removeAttr("data-xt-if"),this.renderInternal(b,d,this.options.context)):d=document.createTextNode("");for(var e=0;e<this.branches.length-1;e++)d=d.add(document.createTextNode(""));null!==a.defaultBranch&&(d=d.add(document.createTextNode("")));
this.$el.eq(0).prev().length?d.insertBefore(this.$el.eq(0)):this.$el.eq(0).parent().prepend(d);this.$el.remove();this.setEl(d);c.has(b.options,"onrender")&&(a=this.resolveModelExpression(this.options.context,b.options.onrender),c.isArray(a)&&0<a.length&&(a=c.last(a),a(d)))}}),e=n.extend({initialize:function(){n.prototype.initialize.apply(this);var a=this.options.block.options.expression;c.bindAll(this,"render","modelChanged");this.bindModelExpression(this.options.context,a,this.modelChanged);this.value=
this.resolveModelExpressionValue(this.options.context,a)},modelChanged:function(a){var b=this.options.block.options.expression,c=this.resolveModelExpressionValue(this.options.context,b);a=this.value!=c||"add"===a||"remove"===a;this.value=c;a&&(this.value=this.resolveModelExpressionValue(this.options.context,b),this.render())},render:function(){var a=this,b=a.options.block;a.clear();if(a.value&&0<a.value.length){var d=b.options.iterator;b.$el.clone().children();a.$el.removeAttr("data-xt-foreach");
a.$el.removeAttr("data-xt-iterator");var e=function(c,e,g){e={};e[d]=c;c=a.createContext(e,a.options.context);e=k(b.el).clone();a.renderInternal(a.options.block,e,c);a.$el.append(e.children())};a.value instanceof Backbone.Collection?a.value.forEach(e):c.each(a.value,e)}c.has(b.options,"onrender")&&(e=a.resolveModelExpression(a.options.context,b.options.onrender),c.isArray(e)&&0<e.length&&(e=c.last(e),e($next)))}}),s={};b.Template=function(a,b){this.block=a;this.context=b;this.tmplID=Math.floor(1E8*
Math.random());s[this.tmplID]=this};d.extend(b.Template.prototype,{render:function(){var a=new r({block:this.block,context:this.context});a.render();a=a.$el;a.data("template-id",this.tmplID);return a.children()},dispose:function(){}});b.Template.compile=function(){var a;if(2<arguments.length)throw"Invalid arguments";a=arguments[0]instanceof k?arguments[0]:k(arguments[0]);a=k("<div></div>").append(a);var e=new l({el:a});return 2===arguments.length&&!0===arguments[1]?e:function(a,g,f){if(!c.isString(a)){f=
g;var l={model:a};f&&f.context&&d.extend(l,f.context);return(new b.Template(e,l)).render()}a=arguments[0];if(!c.isString(a))throw"Invalid argument (1), String expected";switch(a){case "destroy":if(2!==arguments.length)throw"Invalid number of arguments";l=arguments[1];if(!(l instanceof k))throw"Invalid argument (2), jQuery expected";l.data("template-id")&&s[l.data("template-id")].dispose()}}};"undefined"!==typeof test&&(b.templateInstances=s)})(jQuery,_,XUtil);
