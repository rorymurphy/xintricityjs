/*
@license
Copyright (c) 2013, Rory Murphy
All rights reserved.

Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:

Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.
Neither the name of the Rory Murphy nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR
CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
*/

!function(root,factory){"function"==typeof define&&define.amd?define("xutil",["underscore"],function(_){return root.XUtil=factory(_,root)}):root.$x=root.XUtil=factory(root._,root)}(this,function(_,root){"use strict";var __$xOld;"undefined"!=typeof root.$x&&(__$xOld=root.$x);var $x=root.$x={};$x.noConflict=function(){__$xOld?root.$x=__$xOld:delete root.$x},$x.namespace=function(namespace){var nsIter,pieces=namespace.split(".");return $.each(pieces,function(index,item){0==index&&(nsIter=root),item in nsIter||(nsIter[item]={}),nsIter=nsIter[item]}),nsIter},$x.format=function(formatString){var args=arguments;return formatString=formatString.replace(/\{(\d+)\}/gi,function(match,p1,offset,s){return args[parseInt(p1)+1]})};var slugifyRegex=new RegExp("/[^w_]+/");return $x.slugify=function(value){return value.replace(slugifyRegex,"-").toLowerCase()},$x.extend=function(obj){return _.each(Array.prototype.slice.call(arguments,1),function(source){if(source){var hasGetterSetter="undefined"!=typeof{}.__lookupGetter__;for(var i in source){var g,s;hasGetterSetter&&(g=source.__lookupGetter__(i),s=source.__lookupSetter__(i)),g||s?(g&&obj.__defineGetter__(i,g),s&&obj.__defineSetter__(i,s)):obj[i]=source[i]}}}),obj},$x.extendClass=function(protoProps,staticProps){var child,parent=this;child=protoProps&&_.has(protoProps,"constructor")?protoProps.constructor:function(){return parent.apply(this,arguments)},$x.extend(child,parent,staticProps);var Surrogate=function(){this.constructor=child};return Surrogate.prototype=parent.prototype,child.prototype=new Surrogate,protoProps&&$x.extend(child.prototype,protoProps),child.__super__=parent.prototype,child},$x}),function(root,factory){"function"==typeof define&&define.amd?define("XBase",["underscore","xutil","xmvvm"],function(_,$x,mvvm){return root.__XBase__=factory(root,_,$x,mvvm)}):root.__XBase__=factory(root,root._,root.XUtil,root.XMVVM)}(this,function(root,_,$x){var Backbone,array=(root.Backbone,[]),slice=(array.push,array.slice);array.splice;Backbone="undefined"!=typeof exports?exports:{},Backbone.VERSION="1.1.0";var _=root._;_||"undefined"==typeof require||(_=require("underscore")),Backbone.$=root.jQuery||root.Zepto||root.ender||root.$,Backbone.emulateHTTP=!1,Backbone.emulateJSON=!1;var extend=$x.extendClass,urlError=function(){throw new Error('A "url" property or function must be specified')},wrapError=function(model,options){var error=options.error;options.error=function(resp){error&&error(model,resp,options),model.trigger("error",model,resp,options)}},eid_iter=0;Backbone.Event=function(options){this.eid="e"+eid_iter,eid_iter++;var isDefaultPrevented=!1;this.preventDefault=function(){isDefaultPrevented=!0},this.isDefaultPrevented=function(){return isDefaultPrevented};var isBubbled=!1;this.bubble=function(){isBubbled=!0},this.isBubbled=function(){return isBubbled},$x.extend(this,options)},Backbone.Event.extend=$x.extendClass;var Events=Backbone.Events={on:function(name,callback,context,bubbled){if(!eventsApi(this,"on",name,[callback,context])||!callback)return this;this._events||(this._events={});var events=this._events[name]||(this._events[name]=[]);return events.push({callback:callback,context:context,bubbled:bubbled,ctx:context||this}),this},once:function(name,callback,context,bubbled){if(!eventsApi(this,"once",name,[callback,context])||!callback)return this;var self=this,once=_.once(function(){self.off(name,once,context,bubbled),callback.apply(this,arguments)});return once._callback=callback,this.on(name,once,context,bubbled)},off:function(name,callback,context,bubbled){var retain,ev,events,names,i,l,j,k;if(!this._events||!eventsApi(this,"off",name,[callback,context]))return this;if(!(name||callback||context||bubbled))return this._events={},this;for(names=name?[name]:_.keys(this._events),i=0,l=names.length;l>i;i++)if(name=names[i],events=this._events[name]){if(this._events[name]=retain=[],callback||context||bubbled)for(j=0,k=events.length;k>j;j++)ev=events[j],(callback&&callback!==ev.callback&&callback!==ev.callback._callback||context&&context!==ev.context||bubbled&&bubbled!==ev.bubbled)&&retain.push(ev);retain.length||delete this._events[name]}return this},trigger:function(name){if(!this._events)return this;var args=slice.call(arguments,1);if(!eventsApi(this,"trigger",name,args))return this;var events=this._events[name];args[0]instanceof Backbone.Event&&args[0].isBubbled()&&(events=_.filter(events,function(evt){return evt.bubbled}));var allEvents=this._events.all;return events&&triggerEvents(events,args),allEvents&&triggerEvents(allEvents,arguments),this},stopListening:function(obj,name,callback){var listeningTo=this._listeningTo;if(!listeningTo)return this;var remove=!name&&!callback;callback||"object"!=typeof name||(callback=this),obj&&((listeningTo={})[obj._listenId]=obj);for(var id in listeningTo)obj=listeningTo[id],obj.off(name,callback,this),(remove||_.isEmpty(obj._events))&&delete this._listeningTo[id];return this}},eventSplitter=/\s+/,eventsApi=function(obj,action,name,rest){if(!name)return!0;if("object"==typeof name){for(var key in name)obj[action].apply(obj,[key,name[key]].concat(rest));return!1}if(eventSplitter.test(name)){for(var names=name.split(eventSplitter),i=0,l=names.length;l>i;i++)obj[action].apply(obj,[names[i]].concat(rest));return!1}return!0},triggerEvents=function(events,args){var ev,i=-1,l=events.length,a1=args[0],a2=args[1],a3=args[2];switch(args.length){case 0:for(;++i<l;)(ev=events[i]).callback.call(ev.ctx);return;case 1:for(;++i<l;)(ev=events[i]).callback.call(ev.ctx,a1);return;case 2:for(;++i<l;)(ev=events[i]).callback.call(ev.ctx,a1,a2);return;case 3:for(;++i<l;)(ev=events[i]).callback.call(ev.ctx,a1,a2,a3);return;default:for(;++i<l;)(ev=events[i]).callback.apply(ev.ctx,args)}},listenMethods={listenTo:"on",listenToOnce:"once"};_.each(listenMethods,function(implementation,method){Events[method]=function(obj,name,callback){var listeningTo=this._listeningTo||(this._listeningTo={}),id=obj._listenId||(obj._listenId=_.uniqueId("l"));return listeningTo[id]=obj,callback||"object"!=typeof name||(callback=this),obj[implementation](name,callback,this),this}}),Events.bind=Events.on,Events.unbind=Events.off,_.extend(Backbone,Events);var Model=Backbone.Model=function(attributes,options){var attrs=attributes||{};options||(options={}),this.cid=_.uniqueId("c"),this.attributes={},options.collection&&(this.collection=options.collection),options.parse&&(attrs=this.parse(attrs,options)||{}),attrs=_.defaults({},attrs,_.result(this,"defaults")),this.set(attrs,options),this.changed={},this.initialize.apply(this,arguments)};_.extend(Model.prototype,Events,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(options){return _.clone(this.attributes)},sync:function(){return Backbone.sync.apply(this,arguments)},get:function(attr){return this.attributes[attr]},escape:function(attr){return _.escape(this.get(attr))},has:function(attr){return null!=this.get(attr)},set:function(key,val,options){var attr,attrs,unset,changes,silent,changing,prev,current;if(null==key)return this;if("object"==typeof key?(attrs=key,options=val):(attrs={})[key]=val,options||(options={}),!this._validate(attrs,options))return!1;unset=options.unset,silent=options.silent,changes=[],changing=this._changing,this._changing=!0,changing||(this._previousAttributes=_.clone(this.attributes),this.changed={}),current=this.attributes,prev=this._previousAttributes,this.idAttribute in attrs&&(this.id=attrs[this.idAttribute]);for(attr in attrs)val=attrs[attr],_.isEqual(current[attr],val)||changes.push(attr),_.isEqual(prev[attr],val)?delete this.changed[attr]:this.changed[attr]=val,unset?delete current[attr]:current[attr]=val;if(!silent){changes.length&&(this._pending=!0);for(var i=0,l=changes.length;l>i;i++)this.trigger("change:"+changes[i],this,current[changes[i]],options)}if(changing)return this;if(!silent)for(;this._pending;)this._pending=!1,this.trigger("change",this,options);return this._pending=!1,this._changing=!1,this},unset:function(attr,options){return this.set(attr,void 0,_.extend({},options,{unset:!0}))},clear:function(options){var attrs={};for(var key in this.attributes)attrs[key]=void 0;return this.set(attrs,_.extend({},options,{unset:!0}))},hasChanged:function(attr){return null==attr?!_.isEmpty(this.changed):_.has(this.changed,attr)},changedAttributes:function(diff){if(!diff)return this.hasChanged()?_.clone(this.changed):!1;var val,changed=!1,old=this._changing?this._previousAttributes:this.attributes;for(var attr in diff)_.isEqual(old[attr],val=diff[attr])||((changed||(changed={}))[attr]=val);return changed},previous:function(attr){return null!=attr&&this._previousAttributes?this._previousAttributes[attr]:null},previousAttributes:function(){return _.clone(this._previousAttributes)},fetch:function(options){options=options?_.clone(options):{},void 0===options.parse&&(options.parse=!0);var model=this,success=options.success;return options.success=function(resp){return model.set(model.parse(resp,options),options)?(success&&success(model,resp,options),void model.trigger("sync",model,resp,options)):!1},wrapError(this,options),this.sync("read",this,options)},save:function(key,val,options){var attrs,method,xhr,attributes=this.attributes;if(null==key||"object"==typeof key?(attrs=key,options=val):(attrs={})[key]=val,options=_.extend({validate:!0},options),attrs&&!options.wait){if(!this.set(attrs,options))return!1}else if(!this._validate(attrs,options))return!1;attrs&&options.wait&&(this.attributes=_.extend({},attributes,attrs)),void 0===options.parse&&(options.parse=!0);var model=this,success=options.success;return options.success=function(resp){model.attributes=attributes;var serverAttrs=model.parse(resp,options);return options.wait&&(serverAttrs=_.extend(attrs||{},serverAttrs)),_.isObject(serverAttrs)&&!model.set(serverAttrs,options)?!1:(success&&success(model,resp,options),void model.trigger("sync",model,resp,options))},wrapError(this,options),method=this.isNew()?"create":options.patch?"patch":"update","patch"===method&&(options.attrs=attrs),xhr=this.sync(method,this,options),attrs&&options.wait&&(this.attributes=attributes),xhr},destroy:function(options){options=options?_.clone(options):{};var model=this,success=options.success,destroy=function(){model.trigger("destroy",model,model.collection,options)};if(options.success=function(resp){(options.wait||model.isNew())&&destroy(),success&&success(model,resp,options),model.isNew()||model.trigger("sync",model,resp,options)},this.isNew())return options.success(),!1;wrapError(this,options);var xhr=this.sync("delete",this,options);return options.wait||destroy(),xhr},url:function(){var base=_.result(this,"urlRoot")||_.result(this.collection,"url")||urlError();return this.isNew()?base:base+("/"===base.charAt(base.length-1)?"":"/")+encodeURIComponent(this.id)},parse:function(resp,options){return resp},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return null==this.id},isValid:function(options){return this._validate({},_.extend(options||{},{validate:!0}))},_validate:function(attrs,options){if(!options.validate||!this.validate)return!0;attrs=_.extend({},this.attributes,attrs);var error=this.validationError=this.validate(attrs,options)||null;return error?(this.trigger("invalid",this,error,_.extend(options,{validationError:error})),!1):!0}});var modelMethods=["keys","values","pairs","invert","pick","omit"];_.each(modelMethods,function(method){Model.prototype[method]=function(){var args=slice.call(arguments);return args.unshift(this.attributes),_[method].apply(_,args)}});var Collection=Backbone.Collection=function(models,options){options||(options={}),options.model&&(this.model=options.model),void 0!==options.comparator&&(this.comparator=options.comparator),this._reset(),this.initialize.apply(this,arguments),models&&this.reset(models,_.extend({silent:!0},options))},setOptions={add:!0,remove:!0,merge:!0},addOptions={add:!0,remove:!1};_.extend(Collection.prototype,Events,{model:Model,initialize:function(){},toJSON:function(options){return this.map(function(model){return model.toJSON(options)})},sync:function(){return Backbone.sync.apply(this,arguments)},add:function(models,options){return this.set(models,_.extend({merge:!1},options,addOptions))},remove:function(models,options){var singular=!_.isArray(models);models=singular?[models]:_.clone(models),options||(options={});var i,l,index,model;for(i=0,l=models.length;l>i;i++)model=models[i]=this.get(models[i]),model&&(delete this._byId[model.id],delete this._byId[model.cid],index=this.indexOf(model),this.models.splice(index,1),this.length--,options.silent||(options.index=index,this.trigger("remove",model,this,options)),this._removeReference(model));return singular?models[0]:models},set:function(models,options){options=_.defaults({},options,setOptions),options.parse&&(models=this.parse(models,options));var singular=!_.isArray(models);models=singular?models?[models]:[]:_.clone(models);var i,l,id,model,attrs,existing,sort,at=options.at,targetModel=this.model,sortable=this.comparator&&null==at&&options.sort!==!1,sortAttr=_.isString(this.comparator)?this.comparator:null,toAdd=[],toRemove=[],modelMap={},add=options.add,merge=options.merge,remove=options.remove,order=!sortable&&add&&remove?[]:!1;for(i=0,l=models.length;l>i;i++){if(attrs=models[i],id=attrs instanceof Model?model=attrs:attrs[targetModel.prototype.idAttribute],existing=this.get(id))remove&&(modelMap[existing.cid]=!0),merge&&(attrs=attrs===model?model.attributes:attrs,options.parse&&(attrs=existing.parse(attrs,options)),existing.set(attrs,options),sortable&&!sort&&existing.hasChanged(sortAttr)&&(sort=!0)),models[i]=existing;else if(add){if(model=models[i]=this._prepareModel(attrs,options),!model)continue;toAdd.push(model),model.on("all",this._onModelEvent,this),this._byId[model.cid]=model,null!=model.id&&(this._byId[model.id]=model)}order&&order.push(existing||model)}if(remove){for(i=0,l=this.length;l>i;++i)modelMap[(model=this.models[i]).cid]||toRemove.push(model);toRemove.length&&this.remove(toRemove,options)}if(toAdd.length||order&&order.length)if(sortable&&(sort=!0),this.length+=toAdd.length,null!=at)for(i=0,l=toAdd.length;l>i;i++)this.models.splice(at+i,0,toAdd[i]);else{order&&(this.models.length=0);var orderedModels=order||toAdd;for(i=0,l=orderedModels.length;l>i;i++)this.models.push(orderedModels[i])}if(sort&&this.sort({silent:!0}),!options.silent){for(i=0,l=toAdd.length;l>i;i++)model=toAdd[i],this.trigger("add",model,this,options);(sort||order&&order.length)&&this.trigger("sort",this,options)}return singular?models[0]:models},reset:function(models,options){options||(options={});for(var i=0,l=this.models.length;l>i;i++)this._removeReference(this.models[i]);return options.previousModels=this.models,this._reset(),models=this.add(models,_.extend({silent:!0},options)),options.silent||this.trigger("reset",this,options),models},push:function(model,options){return this.add(model,_.extend({at:this.length},options))},pop:function(options){var model=this.at(this.length-1);return this.remove(model,options),model},unshift:function(model,options){return this.add(model,_.extend({at:0},options))},shift:function(options){var model=this.at(0);return this.remove(model,options),model},slice:function(){return slice.apply(this.models,arguments)},get:function(obj){return null==obj?void 0:this._byId[obj.id]||this._byId[obj.cid]||this._byId[obj]},at:function(index){return this.models[index]},where:function(attrs,first){return _.isEmpty(attrs)?first?void 0:[]:this[first?"find":"filter"](function(model){for(var key in attrs)if(attrs[key]!==model.get(key))return!1;return!0})},findWhere:function(attrs){return this.where(attrs,!0)},sort:function(options){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return options||(options={}),_.isString(this.comparator)||1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort(_.bind(this.comparator,this)),options.silent||this.trigger("sort",this,options),this},pluck:function(attr){return _.invoke(this.models,"get",attr)},fetch:function(options){options=options?_.clone(options):{},void 0===options.parse&&(options.parse=!0);var success=options.success,collection=this;return options.success=function(resp){var method=options.reset?"reset":"set";collection[method](resp,options),success&&success(collection,resp,options),collection.trigger("sync",collection,resp,options)},wrapError(this,options),this.sync("read",this,options)},create:function(model,options){if(options=options?_.clone(options):{},!(model=this._prepareModel(model,options)))return!1;options.wait||this.add(model,options);var collection=this,success=options.success;return options.success=function(model,resp,options){options.wait&&collection.add(model,options),success&&success(model,resp,options)},model.save(null,options),model},parse:function(resp,options){return resp},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(attrs,options){if(attrs instanceof Model)return attrs.collection||(attrs.collection=this),attrs;options=options?_.clone(options):{},options.collection=this;var model=new this.model(attrs,options);return model.validationError?(this.trigger("invalid",this,model.validationError,options),!1):model},_removeReference:function(model){this===model.collection&&delete model.collection,model.off("all",this._onModelEvent,this)},_onModelEvent:function(event,model,collection,options){("add"!==event&&"remove"!==event||collection===this)&&("destroy"===event&&this.remove(model,options),model&&event==="change:"+model.idAttribute&&(delete this._byId[model.previous(model.idAttribute)],null!=model.id&&(this._byId[model.id]=model)),this.trigger.apply(this,arguments))}});var methods=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","difference","indexOf","shuffle","lastIndexOf","isEmpty","chain"];_.each(methods,function(method){Collection.prototype[method]=function(){var args=slice.call(arguments);return args.unshift(this.models),_[method].apply(_,args)}});var attributeMethods=["groupBy","countBy","sortBy"];_.each(attributeMethods,function(method){Collection.prototype[method]=function(value,context){var iterator=_.isFunction(value)?value:function(model){return model.get(value)};return _[method](this.models,iterator,context)}}),Backbone.sync=function(method,model,options){var type=methodMap[method];_.defaults(options||(options={}),{emulateHTTP:Backbone.emulateHTTP,emulateJSON:Backbone.emulateJSON});var params={type:type,dataType:"json"};if(options.url||(params.url=_.result(model,"url")||urlError()),null!=options.data||!model||"create"!==method&&"update"!==method&&"patch"!==method||(params.contentType="application/json",params.data=JSON.stringify(options.attrs||model.toJSON(options))),options.emulateJSON&&(params.contentType="application/x-www-form-urlencoded",params.data=params.data?{model:params.data}:{}),options.emulateHTTP&&("PUT"===type||"DELETE"===type||"PATCH"===type)){params.type="POST",options.emulateJSON&&(params.data._method=type);var beforeSend=options.beforeSend;options.beforeSend=function(xhr){return xhr.setRequestHeader("X-HTTP-Method-Override",type),beforeSend?beforeSend.apply(this,arguments):void 0}}"GET"===params.type||options.emulateJSON||(params.processData=!1),"PATCH"===params.type&&noXhrPatch&&(params.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")});var xhr=options.xhr=Backbone.ajax(_.extend(params,options));return model.trigger("request",model,xhr,options),xhr};var noXhrPatch=!("undefined"==typeof window||!window.ActiveXObject||window.XMLHttpRequest&&(new XMLHttpRequest).dispatchEvent),methodMap={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};Backbone.ajax=function(){return Backbone.$.ajax.apply(Backbone.$,arguments)};var Router=Backbone.Router=function(options){options||(options={}),options.routes&&(this.routes=options.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},optionalParam=/\((.*?)\)/g,namedParam=/(\(\?)?:\w+/g,splatParam=/\*\w+/g,escapeRegExp=/[\-{}\[\]+?.,\\\^$|#\s]/g;_.extend(Router.prototype,Events,{initialize:function(){},route:function(route,name,callback){_.isRegExp(route)||(route=this._routeToRegExp(route)),_.isFunction(name)&&(callback=name,name=""),callback||(callback=this[name]);var router=this;return Backbone.history.route(route,function(fragment){var args=router._extractParameters(route,fragment);callback&&callback.apply(router,args),router.trigger.apply(router,["route:"+name].concat(args)),router.trigger("route",name,args),Backbone.history.trigger("route",router,name,args)}),this},navigate:function(fragment,options){return Backbone.history.navigate(fragment,options),this},_bindRoutes:function(){if(this.routes){this.routes=_.result(this,"routes");for(var route,routes=_.keys(this.routes);null!=(route=routes.pop());)this.route(route,this.routes[route])}},_routeToRegExp:function(route){return route=route.replace(escapeRegExp,"\\$&").replace(optionalParam,"(?:$1)?").replace(namedParam,function(match,optional){return optional?match:"([^/]+)"}).replace(splatParam,"(.*?)"),new RegExp("^"+route+"$")},_extractParameters:function(route,fragment){var params=route.exec(fragment).slice(1);return _.map(params,function(param){return param?decodeURIComponent(param):null})}});var noXhrPatch=!("undefined"==typeof window||!window.ActiveXObject||window.XMLHttpRequest&&(new XMLHttpRequest).dispatchEvent),methodMap={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};Backbone.ajax=function(){return Backbone.$.ajax.apply(Backbone.$,arguments)};var History=Backbone.History=function(){this.handlers=[],_.bindAll(this,"checkUrl"),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)},routeStripper=/^[#\/]|\s+$/g,rootStripper=/^\/+|\/+$/g,isExplorer=/msie [\w.]+/,trailingSlash=/\/$/,pathStripper=/[?#].*$/;History.started=!1,_.extend(History.prototype,Events,{interval:50,getHash:function(window){var match=(window||this).location.href.match(/#(.*)$/);return match?match[1]:""},getFragment:function(fragment,forcePushState){if(null==fragment)if(this._hasPushState||!this._wantsHashChange||forcePushState){fragment=this.location.pathname;var root=this.root.replace(trailingSlash,"");fragment.indexOf(root)||(fragment=fragment.slice(root.length))}else fragment=this.getHash();return fragment.replace(routeStripper,"")},start:function(options){if(History.started)throw new Error("Backbone.history has already been started");History.started=!0,this.options=_.extend({root:"/"},this.options,options),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var fragment=this.getFragment(),docMode=document.documentMode,oldIE=isExplorer.exec(navigator.userAgent.toLowerCase())&&(!docMode||7>=docMode);this.root=("/"+this.root+"/").replace(rootStripper,"/"),oldIE&&this._wantsHashChange&&(this.iframe=Backbone.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(fragment)),this._hasPushState?Backbone.$(window).on("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!oldIE?Backbone.$(window).on("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=fragment;var loc=this.location,atRoot=loc.pathname.replace(/[^\/]$/,"$&/")===this.root;if(this._wantsHashChange&&this._wantsPushState){if(!this._hasPushState&&!atRoot)return this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0;this._hasPushState&&atRoot&&loc.hash&&(this.fragment=this.getHash().replace(routeStripper,""),this.history.replaceState({},document.title,this.root+this.fragment+loc.search))}return this.options.silent?void 0:this.loadUrl()},stop:function(){Backbone.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),History.started=!1},route:function(route,callback){this.handlers.unshift({route:route,callback:callback})},checkUrl:function(e){var current=this.getFragment();return current===this.fragment&&this.iframe&&(current=this.getFragment(this.getHash(this.iframe))),current===this.fragment?!1:(this.iframe&&this.navigate(current),void this.loadUrl())},loadUrl:function(fragment){return fragment=this.fragment=this.getFragment(fragment),_.any(this.handlers,function(handler){return handler.route.test(fragment)?(handler.callback(fragment),!0):void 0})},navigate:function(fragment,options){if(!History.started)return!1;options&&options!==!0||(options={trigger:!!options});var url=this.root+(fragment=this.getFragment(fragment||""));if(fragment=fragment.replace(pathStripper,""),this.fragment!==fragment){if(this.fragment=fragment,""===fragment&&"/"!==url&&(url=url.slice(0,-1)),this._hasPushState)this.history[options.replace?"replaceState":"pushState"]({},document.title,url);else{if(!this._wantsHashChange)return this.location.assign(url);this._updateHash(this.location,fragment,options.replace),this.iframe&&fragment!==this.getFragment(this.getHash(this.iframe))&&(options.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,fragment,options.replace))}return options.trigger?this.loadUrl(fragment):void 0}},_updateHash:function(location,fragment,replace){if(replace){var href=location.href.replace(/(javascript:|#).*$/,"");location.replace(href+"#"+fragment)}else location.hash="#"+fragment}}),Backbone.history=new History;var Router=Backbone.Router=function(options){options||(options={}),options.routes&&(this.routes=options.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},optionalParam=/\((.*?)\)/g,namedParam=/(\(\?)?:\w+/g,splatParam=/\*\w+/g,escapeRegExp=/[\-{}\[\]+?.,\\\^$|#\s]/g;return _.extend(Router.prototype,Events,{initialize:function(){},route:function(route,name,callback){_.isRegExp(route)||(route=this._routeToRegExp(route)),_.isFunction(name)&&(callback=name,name=""),callback||(callback=this[name]);var router=this;return Backbone.history.route(route,function(fragment){var args=router._extractParameters(route,fragment);callback&&callback.apply(router,args),router.trigger.apply(router,["route:"+name].concat(args)),router.trigger("route",name,args),Backbone.history.trigger("route",router,name,args)}),this},navigate:function(fragment,options){return Backbone.history.navigate(fragment,options),this},_bindRoutes:function(){if(this.routes){this.routes=_.result(this,"routes");for(var route,routes=_.keys(this.routes);null!=(route=routes.pop());)this.route(route,this.routes[route])}},_routeToRegExp:function(route){return route=route.replace(escapeRegExp,"\\$&").replace(optionalParam,"(?:$1)?").replace(namedParam,function(match,optional){return optional?match:"([^/]+)"}).replace(splatParam,"(.*?)"),new RegExp("^"+route+"$")},_extractParameters:function(route,fragment){var params=route.exec(fragment).slice(1);return _.map(params,function(param){return param?decodeURIComponent(param):null})}}),Model.extend=Collection.extend=Router.extend=History.extend=extend,Backbone}),function(root,factory){"function"==typeof define&&define.amd?define("xtemplate",["jquery","underscore","xutil"],function($,_,$x){return $x.template=factory($,_,$x)}):$x.template=factory(root.jQuery,root._,root.XUtil)}(this,function($,_,$x){"use strict";var templateManager=function(){_.bindAll(this,"initialize","addTemplate")};templateManager.prototype={_templates:{},_templateTypes:{},initialize:function(){},hasTemplate:function(name){var t=this,found=_.has(t._templates,name);if(!found){var item=$("#"+name);found=item.length>0&&(void 0!==item.data("xt-template")||item.is('script[type^="text/template"]'))}return found},getTemplate:function(name){registerTemplateTypes();var pattern,t=this;return pattern=new RegExp("^text/template-(.*)$","i"),_.has(t._templates,name)||t.addTemplate(name),t._templates[name]},addTemplate:function(name,type,template){if(registerTemplateTypes(),void 0===template||null===template){var elem=$("#"+name);if(0==elem.length)throw"Must specify a name that corresponds to a template element or provide the template text";if(template=elem.is('script[type^="text/template"]')?elem.html():elem.html(),void 0===type){var type=elem.data("xt-template");if(void 0===type){var ttype=elem.attr("type"),regex=new RegExp("^text/template-(.+)$"),match=regex.exec(ttype);match.length>1&&(type=match[1])}}}if(!_.has(this._templateTypes,type))throw"Unrecognized template type";var compTmpl=this._templateTypes[type](template);this._templates[name]=compTmpl},registerTemplateType:function(type,compileFunc){this._templateTypes[type]=compileFunc}};var registerTemplateTypes=function(){_.has(this._templateTypes,"underscore")||this.registerTemplateType("underscore",function(tmplText){return _.template(tmplText)}),_.has(this._templateTypes,"mustache")||"undefined"==typeof Mustache||this.registerTemplateType("mustache",function(tmplText){return Mustache.compile(tmplText)}),_.has(this._templateTypes,"handlebars")||"undefined"==typeof Handlebars||this.registerTemplateType("handlebars",function(tmplText){return Handlebars.compile(tmplText)}),_.has(this._templateTypes,"xintricity")||"undefined"==typeof XMVVM||this.registerTemplateType("xintricity",function(el){return XMVVM.Template.compile(el)})},tmplMgr=new templateManager,XTemplate=function(template){return tmplMgr.getTemplate(template)};return XTemplate.addTemplate=function(){tmplMgr.addTemplate.apply(tmplMgr,arguments)},XTemplate.registerTemplateTypes=function(){tmplMgr.registerTemplateType.apply(tmplMgr,arguments)},registerTemplateTypes=_.bind(registerTemplateTypes,tmplMgr),XTemplate}),function(root,factory){"function"==typeof define&&define.amd?define("xmvvm-model",["jquery","underscore","xutil","XBase"],function($,_,$x,XBase){return root.XMVVM=factory($,_,$x,XBase)}):root.XMVVM=factory(root.jQuery,root._,root.XUtil,root.__XBase__)}(this,function($,_,$x,Backbone){"use strict";var mvvm={};Backbone.Model.isParentTypeOf=function(type){return Backbone.Model.prototype.isPrototypeOf(type.prototype)},Backbone.Collection.isParentTypeOf=function(type){return Backbone.Collection.prototype.isPrototypeOf(type.prototype)};var extend=$x.extendClass,createField=function(key,options){var t=this;createFieldInternal.call(t,key,options),t[key]=_.bind(t[key],t)},createFieldInternal=function(key,options){var t=this;t.fields||(t.fields={}),t.fields&&!_.has(this,"fields")&&(t.fields=$x.extend({},t.fields)),_.isFunction(options)&&(options={type:options}),_.defaults(options,{persist:!0,type:Object}),options.name=key,t.fields[key]=options,t[key]=function(){return 1!==arguments.length?this.get(key):void this.set(key,arguments[0])}};_.mixin({resultBB:function(obj,property,evaluate){void 0===evaluate&&(evaluate=!0);var val=obj[property];return void 0===val&&obj instanceof Backbone.Model&&(val=obj.get(property)),void 0!==val&&evaluate&&_.isFunction(val)&&(val=val()),val},startsWith:function(val,prefix){return val.substr(0,prefix.length)===prefix},endsWith:function(val,suffix){var startPos=val.length-suffix.length;return startPos>=0&&val.substr(startPos)===suffix}}),mvvm.Event=Backbone.Event;var collEvtMap={add:["model","collection","options"],remove:["model","collection","options"],destroy:["model","collection","options"],reset:["collection","options"],sort:["collection","options"],request:["collection","xhr","options"],sync:["collection","resp","options"],error:["collection","xhr","options"]},modelEvtMap={add:["model","collection","options"],remove:["model","collection","options"],
destroy:["model","collection","options"],change:["model","options"],"change:":["model","value","options"],request:["model","xhr","options"],sync:["model","resp","options"],error:["model","xhr","options"],invalid:["model","error","options"]},mapEvent=function(evtMap,event){var evt,reqArgCount=2,args=Array.prototype.slice.call(arguments),evtType=event,eIdx=event.indexOf(":"),map=void 0;if(_.has(evtMap,evtType))map=evtMap[evtType];else if(eIdx>=0){var eType=evtType.substr(0,eIdx+1);_.has(evtMap,eType)&&(map=evtMap[eType])}if(void 0!==map){var newArgs={};_.each(map,function(val,idx){newArgs[val]=args[idx+reqArgCount]}),evt=new mvvm.Event(newArgs)}return evt},trigger=function(parentType,eventAttrName,eventMap,event){var evt,reqArgCount=4,evtArgs=(Array.prototype.slice.call(arguments),null);if(arguments.length>reqArgCount&&!(arguments[reqArgCount]instanceof mvvm.Event)){var mapArgs=Array.prototype.slice.call(arguments,reqArgCount-1);mapArgs.unshift(eventMap),evt=mapEvent.apply(this,mapArgs),evtArgs=void 0!==evt?[event,evt]:Array.prototype.slice.call(arguments,reqArgCount-1)}else if(reqArgCount===arguments.length){var newArgs={};newArgs[eventAttrName]=this,evt=new mvvm.Event(newArgs),evtArgs=[event].concat([evt])}else evtArgs=Array.prototype.slice.call(arguments,reqArgCount-1);parentType.prototype.trigger.apply(this,evtArgs)};mvvm.Model=Backbone.Model.extend({constructor:function(attributes,options){var t=this;_.bindAll(this,"createField","set"),_.defaults(t,{fields:{}}),_.chain(t.fields).keys().each(function(val){t[val]=_.bind(t[val],t)}),Backbone.Model.apply(this,[attributes,options])},fields:{},createField:function(key,options){createField.call(this,key,options)},clone:function(){var t=this,inst=new this.constructor(this.attributes);return _.chain(inst.fields).keys().each(function(val){inst[val]=_.bind(inst[val],inst)}),inst.fields=$x.extend({},t.fields),_.each(inst.fields,function(val,name,list){inst.constructor.prototype&&inst.constructor.prototype.fields&&inst.constructor.prototype.fields[name]||inst.createField(name,val)}),inst},toJSON:function(){var t=this,atts=_.clone(t.attributes);return _.each(atts,function(val,key){(!_.has(t.fields,key)||t.fields[key].persist)&&(val instanceof mvvm.Model||val instanceof mvvm.Collection)&&(atts[key]=val.toJSON())}),atts},trigger:_.partial(trigger,Backbone.Model,"model",modelEvtMap),set:function(key,val,options){var attrs,curr,t=this,fields=t.fields;_.isObject(key)?(attrs=key,options=val):(attrs={})[key]=val;var fAttrs=_.clone(attrs);return _.each(attrs,function(value,name,list){var field,valid,fVal;if(fVal=value,null!==fields&&_.has(fields,name)&&(field=fields[name],fVal=t._prepareValue(field,value),valid=!0,_.isFunction(field.validate)&&(valid=field.validate(value)),valid!==!0))throw valid;if(curr=t[name],null!==curr&&(curr instanceof Backbone.Model||curr instanceof Backbone.Collection)&&curr.off("all",retrigger,this),fVal instanceof Backbone.Model||fVal instanceof Backbone.Collection){var retrigger=function(evtName,evt){var args=Array.prototype.slice.call(arguments);_.has(evt,"model")&&evt.model===t||_.has(evt,"recipients")&&_.has(evt.recipients,t.cid)||(evt.bubble(),evt.recipients=evt.recipients||{},evt.recipients[t.cid]=!0,t.trigger.apply(t,args))},currVal=t.get(name);currVal&&currVal.off("all",retrigger,t.cid+name),fVal.on("all",retrigger,t.cid+name)}fAttrs[name]=fVal}),Backbone.Model.prototype.set.apply(this,[fAttrs,options])},_prepareValue:function(field,value){if(void 0===value||null===value)return value;switch(field.type){case"int":"int"!=typeof value&&(value=parseInt(value));break;case Number:_.isNumber(value)||(value=parseFloat(value));break;case Boolean:_.isBoolean(value)||(value=1==value);break;case String:_.isString(value)||(value+="");break;case Date:value instanceof Date||(_.isNumber(value)?value=new Date(value):_.isString(value)&&(value=Date.parse(value)));break;case Array:if(!(value instanceof Array))throw"Type mismatch";break;default:if(!(value instanceof field.type))if((field.type===Backbone.Model||Backbone.Model.isParentTypeOf(field.type))&&_.isObject(value)||(field.type===Backbone.Collection||Backbone.Collection.isParentTypeOf(field.type))&&(_.isObject(value)||_.isArray(value)))value=new field.type(value);else if(!(value instanceof field.type))throw"Type mismatch"}return value},parse:function(res){var result={};return _.each(this.fields,function(elem,index,list){Backbone.Model.isParentTypeOf(elem.type)||Backbone.Collection.isParentTypeOf(elem.type)?result[elem.name]=new elem.type(res[elem.name],{parse:!0}):result[elem.name]=res[elem.name]}),result}}),mvvm.Model.extend=function(protoProps,staticProps){var t=this;if(protoProps.fields){var fields=protoProps.fields;delete protoProps.fields}var obj=extend.call(t,protoProps,staticProps);return fields&&(protoProps.fields=fields),t.prototype.fields&&_.each(t.prototype.fields,function(val,key){createFieldInternal.call(obj.prototype,key,val)}),_.has(protoProps,"fields")&&_.each(protoProps.fields,function(val,key){createFieldInternal.call(obj.prototype,key,val)}),obj},mvvm.Model.createField=function(obj,key,options){createFieldInternal.call(obj,key,options)},mvvm.Model.defaults={useGetSet:!1},mvvm.Collection=Backbone.Collection.extend({unique:function(){var args=array.slice.call(arguments);return args.unshift(this.models),_.unique.apply(_,args)},_onModelEvent:function(event,model,collection,options){"add"!==event&&"remove"!==event||collection===this?Backbone.Collection.prototype._onModelEvent.apply(this,arguments):this.trigger.apply(this,arguments)},trigger:_.partial(trigger,Backbone.Collection,"collection",collEvtMap)}),mvvm.ViewModel=mvvm.Model.extend({view:null,fields:{model:Object},constructor:function(options){options&&options.container&&(this.container=$(options.container),delete options.container),mvvm.Model.apply(this,arguments)},render:function(){var t=this;return t.view&&(t.trigger("rendering",new mvvm.Event),t.$el=$x.template(t.view)(t.model(),{context:{viewmodel:t}}),t.container&&t.container.append(t.$el),t.trigger("rendered",new mvvm.Event)),t.$el},dispose:function(){var t=this;t.$el&&t.view&&$x.template(t.view)("destroy",t.$el)}});return mvvm.Filters=_.extend({},{isFalse:function(val){return val===!1},isNull:_.isNull,isUndefined:_.isUndefined,isObject:_.isObject,isNullOrUndefined:function(val){return void 0===val||null===val},isEmpty:function(val){return void 0===val||null===val||""===val},isEqualTo0:function(val){return 0===val},isEqualTo1:function(val){return 1===val},isGreaterThan0:function(val){return val>0},isLessThan0:function(val){},add1:function(val){return val+1},subtract1:function(val){return val-1}}),mvvm.BindingExpression=function(args){args&&_.extend(this,args)},_.extend(mvvm.BindingExpression.prototype,{toString:function(){var result="{",keys=_.keys(this).sort();result+='"'+keys[0]+'","'+this[keys[0]]+'"';for(var i=1;i<keys.length;i++)result+=',"'+keys[i]+'","'+this[keys[i]]+'"';return result+="}"}}),mvvm.ModelNavMixins={splitModelPath:function(path){var matches;return matches=path.match(/\w+(?=\.?)|(?=\[)\w+(?=\])/g)},resolveModelPath:function(model,path,options){return this.resolveModelExpression(model,{path:path},options)},resolveModelExpression:function(model,expression,options){var path=expression.path;(arguments.length<3||void 0===options)&&(options={}),options=_.defaults(options,{evalVal:!0,allowPartial:!0}),options=_.defaults(options,{applyFilter:options.evalVal});var oldLvl,modLvl=[model];if("undefined"==typeof path||null===path||""===path)return void 0;var parts;parts=path instanceof Array?path:this.splitModelPath(path);for(var i=0;i<parts.length;i++){var lvl=modLvl[modLvl.length-1];if(null==lvl&&options.allowPartial)break;if(null==lvl){modLvl=void 0;break}if(lvl instanceof Backbone.Collection?lvl=lvl.at(parts[i]):!lvl[parts[i]]&&lvl instanceof Backbone.Model&&lvl.has(parts[i])?lvl=lvl.get(parts[i]):i<parts.length-1||options.evalVal?(oldLvl=lvl,lvl=_.resultBB(lvl,parts[i])):lvl=lvl[parts[i]],"undefined"==typeof lvl){if(options.allowPartial)break;modLvl=void 0;break}modLvl.push(lvl)}var result1=void 0!==modLvl&&null!==modLvl&&modLvl.length>0?_.last(modLvl):modLvl;if(options.applyFilter){var result2=this._applyBindExpression(expression,result1,model);result2!==result1&&modLvl.push(result2)}return modLvl},resolveModelExpressionValue:function(model,expression){var t=this,val=t.resolveModelExpression(model,expression,{allowPartial:!1});return val=void 0!==val&&_.isArray(val)&&val.length>0?_.last(val):void 0},_applyBindExpression:function(expression,value,context){var orig=context;if(_.has(expression,"filter")&&_.isString(expression.filter)){context=context.clone(),context.createField("Filter",Object),context.set("Filter",mvvm.Filters);var filter=this.resolveModelPath(context,expression.filter,{evalVal:!1,allowPartial:!1});if(!_.isArray(filter))throw"Invalid filter, path does not exist";if(filter=_.last(filter),!_.isFunction(filter))throw"Invalid filter, not a function";value=filter(value,orig)}else _.has(expression,"pattern")&&_.isString(expression.pattern)&&(value=$x.format(expression.Pattern,value));return value},bindModelPath:function(model,path,callback,options){this.bindModelExpression(model,{path:path},callback,options)},bindModelExpression:function(model,expression,callback,options){var t=this,parts=this.splitModelPath(expression.path),lvls=this.resolveModelPath(model,parts),record={model:model,expression:expression,callback:callback},verifyAffectedMod=function(evt){var idx=_.indexOf(lvls,evt.model);return 0>idx||idx==parts.length?!1:0===idx?!0:_.has(evt.model.changed,parts[idx])?!0:!1},checkCallback=function(event,evt){var args,idx,opts,result=!1;switch(event){case"change":opts=evt.options,args=Array.prototype.slice.call(arguments,1,arguments.length),result=verifyAffectedMod.apply(this,args);break;case"add":case"remove":case"sort":case"reset":opts=evt.options,idx=_.indexOf(lvls,evt.collection),result=idx>=0&&(idx===lvls.length-1||_.indexOf(lvls,evt.collection)===idx+1)}if(result=result&&!((this instanceof Backbone.Model||this instanceof Backbone.Collection)&&_.has(evt,"recipients")&&_.has(evt.recipients,this.cid))){lvls=this.resolveModelPath(model,parts),evt.recipients=_.has(evt,"recipients")?evt.recipients:{},evt.recipients[this.cid]=!0,callback.apply(this,arguments);var newEvt=new mvvm.Event;newEvt.oldValue=record.value;var newVal=this.resolveModelExpression(record.model,record.expression);newVal=newVal.length===parts.length+1?_.last(lvls):void 0,newEvt.value=newVal,record.value=newVal,callback.apply(this,[newEvt])}};_.has(this,"_bindingCallbacks")||(t._bindingCallbacks=[]),record.checkCallback=_.bind(checkCallback,t),t._bindingCallbacks.push(record),model.on("all",record.checkCallback,t)},unbindModelPath:function(model,path,callback){this.unbindModelExpression(model,{path:path},callback)},unbindModelExpression:function(model,expression,callback){var itm=_.find(this._bindingCallbacks,function(val){return val.model===model&&_.isEqual(val.expression,expression)&&val.callback===callback});model.off("all",itm.checkCallback,this)},setModelPathValue:function(model,path,value,useSetter){useSetter=void 0===useSetter?!0:useSetter;var split=_.isArray(path)?path:this.splitModelPath(path),lvls=this.resolveModelPath(model,split,{evalVal:!1,allowPartial:!1}),lvlLen=lvls.length,last=lvls[lvlLen-1];useSetter&&_.isFunction(last)?last(value):last instanceof Backbone.Collection?lvls[lvlLen-2].update(value):lvls[lvlLen-2][split[lvlLen-1]]=value}},mvvm.Router=Backbone.Router.extend({initialize:function(options){var t=this;_.bindAll(this,"canRoute"),options=options||{},_.defaults(options,{root:"/",startHistory:!0,pushState:!0}),options.startHistory&&Backbone.history.start({pushState:options.pushState,root:options.root});var baseFull=location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")+options.root;$(document).on("click","a:not([data-bypass])",function(evt){var href=this.href;this.protocol+"//";if(href&&href.substr(0,baseFull.length)===baseFull&&"_blank"!==$(this).attr("target")&&"external"!==$(this).attr("rel")){var tail=href.substr(baseFull.length),isRouted=t.canRoute(tail);isRouted?(evt.preventDefault(),t.navigate(tail,{trigger:!0})):tail==Backbone.history.fragment&&evt.preventDefault()}})},canRoute:function(fragment){if(!Backbone.History.started)return!1;var pathStripper=(Backbone.history.root+(fragment=Backbone.history.getFragment(fragment||"")),/[?#].*$/);return fragment=fragment.replace(pathStripper,""),fragment===Backbone.history.fragment?!1:(fragment=Backbone.history.getFragment(fragment),_.any(Backbone.history.handlers,function(handler){return handler.route.test(fragment)?!0:void 0}))}}),mvvm}),function(root,factory){"function"==typeof define&&define.amd?define("xmvvm",["jquery","underscore","xutil","xmvvm-model","xtemplate"],function($,_,$x,mvvm){return root.XMVVM=factory($,_,$x,mvvm)}):root.XMVVM=factory(root.jQuery,root._,root.XUtil,root.XMVVM)}(this,function($,_,$x,mvvm){"use strict";mvvm.NodeTypes=[];var templateNode=mvvm.templateNode=function(options){var t=this;options=_.defaults(options,{childNodes:[],el:null,$el:null,inner:null,parent:null}),options.el&&!options.$el&&(options.$el=$(options.el)),options.$el instanceof $||(options.$el=$(options.$el)),options.el=options.$el.get(0),_.extend(t,options),this.initialize()};_.extend(templateNode.prototype,{initialize:function(){_.bindAll(this,"createInstance")},createInstance:function($el,context){return this.type.createInstance(this,$el,context)}});var resolveElement=function($el,indices){var curr=$el;return _.each(indices,function(val){curr=curr.contents().eq(val)}),curr},templateParser=mvvm.templateParser=function(){this.initialize()};_.extend(templateParser.prototype,{initialize:function(){_.bindAll(this,"parse","_parse","calculatePosition");var t=this;t.childScopeSelector="",t.parseFunctions={},_.each(mvvm.NodeTypes,function(val){var parser=_.defaults(val,{name:null,type:"bind",selector:null,parse:null,render:null});if(null===parser.name||""===parser.name)throw"Parser must specify a name";if(null===parser.parse||!_.isFunction(parser.parse))throw"Must specify a valid parse function";if("block"===parser.type&&(null==parser.selector||""==parser.selector))throw"If parser is a block, must specify a selector for all nested scopes.";t.parseFunctions[parser.name]=_.bind(parser.parse,t),"block"===parser.type&&(""!=t.childScopeSelector&&(t.childScopeSelector+=","),t.childScopeSelector+=parser.selector)});var excludeNestedScopesInner=function($el,idx){return $(this).parentsUntil($el,t.childScopeSelector).length>0};t.excludeNestedScopes=function($el){return _.partial(excludeNestedScopesInner,$el)}},parse:function(el){var t=this,innerNodes=[];"undefined"==typeof t.parserFunctions&&t.initialize();for(var node=new templateNode({el:$(el),inner:$(el).children()}),innerNodes=innerNodes.concat(t._parse(node));innerNodes.length>0;){var b=innerNodes.shift(),n=t._parse(b);_.isArray(n)&&n.length>0&&innerNodes.push.apply(innerNodes,n)}return node},_parse:function(node){var t=this,innerNodes=[],nodeTypes=mvvm.NodeTypes;_.each(_.where(nodeTypes,{type:"tree"}),function(val){innerNodes=innerNodes.concat(t.parseFunctions[val.name](node)||[])}),_.each(_.where(nodeTypes,{type:"block"}),function(val){innerNodes=innerNodes.concat(t.parseFunctions[val.name](node)||[])});var blocks=node.$el.find("*").not(t.childScopeSelector).not(t.excludeNestedScopes(node.$el)).add(node.$el);return _.each(_.where(nodeTypes,{type:"bind"}),function(val){blocks.each(function(idx,elem){t.parseFunctions[val.name](node,elem)})}),innerNodes},calculatePosition:function(child,parent){if(child.get(0)===parent.get(0))return[];child=$(child),parent=$(parent);var parents=child.parentsUntil(parent);if(0===child.closest(parent).length)return void 0;var indices=[child.parent().contents().index(child)];return parents.each(function(idx,elem){var $el=$(elem);indices.unshift($el.parent().contents().index($el))}),indices},parseBinding:function(modelRef,allowComplex){var matches,binding={},basicPatt=/^\{\{([\w\.\[\]]+)\}\}$/i,advPatt=/^\{\{(?:\s*(Path|Filter|Pattern|HTML)\s*=\s*(?:'([^']*)'|"([^"]*)")\s*\,?)+\}\}$/gi,advPatt2=/(Path|Filter|Pattern|HTML)\s*=\s*('[^']*'|"[^"]*")\s*/gi;if(1===arguments.length&&(allowComplex=!0),matches=modelRef.match(basicPatt),null!==matches&&matches.length>1)binding.path=matches[1];else if(allowComplex)if(null!==advPatt.exec(modelRef)){for(;matches=advPatt2.exec(modelRef);)binding[matches[1].toLowerCase()]=matches[2].substring(1,matches[2].length-1);binding.hasOwnProperty("path")||(binding=void 0)}else binding=modelRef;else binding=modelRef;return _.isObject(binding)?new mvvm.BindingExpression(binding):binding}});var cssTriggerNodeType=mvvm.cssTriggerNodeType={name:"css-trigger",type:"tree",parse:function(node){var t=this,result=[];return node.$el.find("[data-xt-event][data-xt-class]:first-child, [data-xt-event]+[data-xt-event][data-xt-class], [data-xt-event][data-xt-style]:first-child, [data-xt-event]+[data-xt-event][data-xt-style]").not(t.excludeNestedScopes(node.$el)).each(function(idx,elem){var $el=$(elem),options={$el:$el},styles=[];$el.is("[data-xt-style]")&&(styles=$el.data("xt-style").split(";"));var cssClass=$el.data("xt-class");options.event=$el.data("xt-event"),options.type=cssTriggerNodeType,options.position=t.calculatePosition($(elem).parent(),node.$el),void 0!==styles&&styles.length>0&&(options.styles={},_.each(styles,function(val){var vals=val.split(":");2===vals.length&&(options.styles[vals[0].trim()]=vals[1].trim())})),void 0!==cssClass&&(options.cssClass=cssClass),result.push(new templateNode(options)),$el.remove()}),node.childNodes=node.childNodes.concat(result),[]},createInstance:function(node,$el,context){var options={event:node.event,el:resolveElement($el,node.position),context:context};return _.has(node,"styles")&&(options.styles=node.styles),_.has(node,"cssClass")&&(options.cssClass=node.cssClass),new mvvm.StyleTrigger(options)}};mvvm.NodeTypes.push(cssTriggerNodeType);var actionTriggerNodeType=mvvm.actionTriggerNodeType={name:"action-trigger",type:"tree",parse:function(node){var t=this,result=[];return node.$el.find("[data-xt-event][data-xt-action]:first-child, [data-xt-event]+[data-xt-event][data-xt-action]").not(t.excludeNestedScopes(node.$el)).each(function(idx,elem){var $el=$(elem),options={$el:$el},data=$el.data("xt-data");options.event=$el.data("xt-event"),options.action=t.parseBinding($el.data("xt-action"),!1),options.type=actionTriggerNodeType,options.position=t.calculatePosition($(elem).parent(),node.$el),void 0!==data&&(options.data=t.parseBinding(data,!1)),result.push(new templateNode(options)),$el.remove()}),node.childNodes=node.childNodes.concat(result),[]},createInstance:function(node,$el,context){var options={event:node.event,el:resolveElement($el,node.position),context:context,action:node.action};return _.has(node,"data")&&(options.data=node.data),new mvvm.ActionTrigger(options)}};mvvm.NodeTypes.push(actionTriggerNodeType);var foreachNodeType=mvvm.foreachNodeType={name:"foreach",type:"block",selector:"[data-xt-foreach]",parse:function(node){var t=this,result=[],blocks=node.$el.find("[data-xt-foreach]").not(t.excludeNestedScopes(node.$el));return blocks.each(function(idx,elem){var $el=$(elem),options={$el:$(elem),type:foreachNodeType,position:t.calculatePosition($el,node.$el),expression:t.parseBinding($el.data("xt-foreach")),iterator:$el.data("xt-iterator"),indexer:$el.data("xt-index")};result.push(new templateNode(options))}),node.childNodes=node.childNodes.concat(result),result},createInstance:function(node,$el,context){var replace=resolveElement($el,node.position),item=new ForeachBlockInst({block:node,context:context,el:replace});return item.render(),item}};mvvm.NodeTypes.push(foreachNodeType);var ifNodeType=mvvm.ifNodeType={name:"if-else",type:"block",selector:"[data-xt-if],[data-xt-else-if],[data-xt-else]",parse:function(node){var t=this,result=[],blocks=node.$el.find("[data-xt-if]").not(t.excludeNestedScopes(node.$el));return blocks.each(function(idx,elem){var $el=$(elem),block=new templateNode({el:elem,type:ifNodeType,position:t.calculatePosition($el,node.$el),branches:[],defaultBranch:null}),curr=$el;do{var cond=curr.is("[data-xt-if]")?curr.data("xt-if"):curr.data("xt-else-if"),bBlock=new templateNode({el:curr,type:ifNodeType,subType:"branch",expression:t.parseBinding(cond)});curr.is("[data-xt-onrender]")&&(bBlock.onrender=t.parseBinding(curr.data("xt-onrender"))),block.branches.push(bBlock),result.push(bBlock),curr=curr.next()}while(curr.is("[data-xt-else-if]"));curr.is("[data-xt-else]")&&(block.defaultBranch=new templateNode({el:curr,type:ifNodeType,subType:"else"}),result.push(block.defaultBranch),curr.is("[data-xt-onrender]")&&(block.defaultBranch.onrender=t.parseBinding(curr.data("xt-onrender")))),node.childNodes.push(block)}),result},createInstance:function(node,$el,context){var replace=resolveElement($el,node.position),item=new IfBlockInst({block:node,context:context,el:replace});return item.render(),item}};mvvm.NodeTypes.push(ifNodeType);var partialNodeType=mvvm.partialNodeType={name:"partial",type:"block",selector:"[data-xt-partial]",parse:function(node){var t=this,blocks=node.$el.find("[data-xt-partial]").not(t.excludeNestedScopes(node.$el));blocks.each(function(idx,elem){var $el=$(elem),model=$el.data("xt-model");model&&(model=t.parseBinding(model));var partial=$el.data("xt-partial");if(void 0===model){var bind=t.parseBinding(partial);_.isObject(bind)&&(model=bind,partial=void 0)}node.childNodes.push(new templateNode({$el:$el,type:partialNodeType,position:t.calculatePosition($el,node.$el),template:partial,model:model}))})},createInstance:function(node,$el,context){var replace=resolveElement($el,node.position),item=new ChildTemplateBlockInst({block:node,context:context,el:replace});return item.render(),item}};mvvm.NodeTypes.push(partialNodeType);var attributeBindingNodeType=mvvm.attributeBindingNodeType={name:"attribute-binding",type:"bind",parse:function(node,elem){var $el=$(elem),t=this;_.each(elem.attributes,function(attr){var name=attr.name;if(("data-xt-"!==name.substr(0,8)||"data-xt-src"===name||"data-xt-value"===name)&&"type"!==name){var val=attr.value;val=t.parseBinding(val),_.isObject(val)&&node.childNodes.push(new templateNode({expression:val,type:attributeBindingNodeType,position:t.calculatePosition($el,node.$el),attr:name}))}})},createInstance:function(node,$el,context){var target=resolveElement($el,node.position),item=new mvvm.AttributeBinding({model:context,el:target,expression:node.expression,attr:node.attr});return item}};mvvm.NodeTypes.push(attributeBindingNodeType);var cssBindingNodeType=mvvm.cssBindingNodeType={name:"css-binding",type:"bind",parse:function(node,elem){var $el=$(elem),t=this,prefix="data-xt-class-",attrs=_.filter(elem.attributes,function(a){return _.startsWith(a.name,prefix)});_.each(attrs,function(attr){var name=attr.name,val=attr.value;val=t.parseBinding(val),_.isObject(val)&&node.childNodes.push(new templateNode({expression:val,type:cssBindingNodeType,position:t.calculatePosition($el,node.$el),cssClass:name.substr(prefix.length)}))})},createInstance:function(node,$el,context){var target=resolveElement($el,node.position),item=new mvvm.CssClassBinding({model:context,el:target,expression:node.expression,cssClass:node.cssClass});return item}};mvvm.NodeTypes.push(cssBindingNodeType);var textBindingNodeType=mvvm.textBindingNodeType={name:"text-binding",type:"bind",textBindingPattern:/\{\{([a-zA-Z][\w\._]*|([a-zA-z]\w*\s*=\s*('[^']*'|"[^"]*"),?\s*)+)\}\}/g,parse:function(node,elem){var t=this,$el=$(elem),contents=$el.contents();_.each(contents.filter(function(){return 3==this.nodeType}),function(txtnode){var binding=textBindingNodeType.createBinding.call(t,txtnode,node.$el,txtnode.nodeValue);null!==binding&&node.childNodes.push(binding)}),_.each($el.get(0).attributes,function(attr){if(!_.isObject(t.parseBinding(attr.value))){var binding=textBindingNodeType.createBinding.call(t,$el,node.$el,attr.value,attr.name);null!==binding&&node.childNodes.push(binding)}})},createBinding:function(el,parent,text,attrName){for(var t=this,$el=$(el),matches=[],match=null;match=textBindingNodeType.textBindingPattern.exec(text);)matches.push(match[0]);if(null!=matches&&matches.length>0){var patterns=_.uniq(matches);matches=_.map(patterns,function(val){return t.parseBinding(val)});var tblock=text;tblock=tblock.replace(/\{/,"&#123;").replace(/\}/,"&#125;");var pattern=text.replace(textBindingNodeType.textBindingPattern,function(val){return"{"+_.indexOf(patterns,val)+"}"}),args={type:textBindingNodeType,paths:matches,pattern:pattern,position:t.calculatePosition($el,parent)};return void 0!==attrName&&(args.attribute=attrName),new templateNode(args)}return null},createInstance:function(node,$el,context){var target=resolveElement($el,node.position),args={model:context,el:target,paths:node.paths,pattern:node.pattern};_.has(node,"attribute")&&(args.attribute=node.attribute);var item=new mvvm.TextNodeBinding(args);return item}};mvvm.NodeTypes.push(textBindingNodeType);var selectBindingNodeType=mvvm.selectBindingNodeType={name:"select-binding",type:"bind",parse:function(node,elem){var t=this,$el=$(elem);if($el.is("[data-xt-options]")){var val=$el.data("xt-options"),options={el:elem,type:selectBindingNodeType,path:val.substr(2,val.length-4),position:t.calculatePosition($el,node.$el)},textField=$el.data("xt-text-field"),valueField=$el.data("xt-value-field");void 0!==textField&&null!==textField&&(options.textField=textField),void 0!==valueField&&null!==valueField&&(options.valueField=valueField);var binding=new templateNode(options);node.childNodes.push(binding)}},createInstance:function(node,$el,context){var target=resolveElement($el,node.position),item=new mvvm.SelectBinding({model:context,el:target,path:node.path,textField:node.textField,valueField:node.valueField});return item}};mvvm.NodeTypes.push(selectBindingNodeType),mvvm.Binding=function(){},mvvm.Binding.extend=$x.extendClass,mvvm.AttributeBinding=mvvm.Binding.extend({constructor:function(options){var t=this;if(this.options=$x.extend({},options),this.options=_.defaults(this.options,this.defaults),null===t.options.model||null===t.options.path||null===t.options.el||null===t.options.attr)throw"model, path, el, and attr options are required";"value"!==t.options.attr&&(t.options.updateModel=!1),t.$el=$(t.options.el),_.bindAll(this,"value","elementValue","setModelAttr","modelChanged","bindModel","unbindModel","bindEl","setElProp","elChanged","dispose"),this.bindModel(),this.bindEl(),this.initialize()},initialize:function(){var t=this,curr=t.value();if(t.options.updateElement&&t.setElProp(curr),t.options.updateModel){var val=t.elementValue(),valStr=void 0===val||null===val?"":val;curr=void 0===curr||null===curr?"":curr,val!==t.options.expression.path&&valStr!=curr+""&&this.setModelAttr(val)}},defaults:{model:null,expression:null,el:null,attr:null,updateModel:!0,updateElement:!0},bindModel:function(){this._modelPath=this.resolveModelExpression(this.options.model,this.options.expression,{evalVal:!1,applyFilter:!1,allowPartial:!1}),this.bindModelExpression(this.options.model,this.options.expression,this.modelChanged)},unbindModel:function(){this.unbindModelExpression(this.options.model,this.options.expression,this.modelChanged)},value:function(){if("undefined"!=typeof this._modelPath&&0!==this._modelPath.length){var val=this._modelPath[this._modelPath.length-1];return _.isFunction(val)&&(val=val()),this._applyBindExpression(this.options.expression,val,this.options.model)}},elementValue:function(){var result,t=this,isValue="data-xt-value"===t.options.attr;if(t.$el.is('input[type="radio"]')&&isValue){var $el=t.$el.closest("form");0===$el.length&&($el=$(document)),result=$el.find($x.format('input[type="radio"][name="{0}"]:checked',t.$el.attr("name"))).val()}else result=t.$el.is('input[type="checkbox"]')&&isValue?t.$el.is(":checked")?t.$el.val():void 0:"value"===t.options.attr?t.$el.val():t.$el.attr(t.options.attr);return result},setModelAttr:function(val){var t=this,modLvl=t._modelPath;if(void 0===modLvl||null===modLvl)throw"Xintricity cannot set model value, expression does not exist: "+t.options.expression.path;var lvlCount=modLvl.length,parts=this.splitModelPath(t.options.expression.path);lvlCount>0&&_.isFunction(modLvl[lvlCount-1])?modLvl[lvlCount-1](val):modLvl[lvlCount-2][_.last(parts)]=val},modelChanged:function(event,model,options){var t=this;this._modelPath=this.resolveModelExpression(this.options.model,this.options.expression,{evalVal:!1,applyFilter:!1,allowPartial:!1}),t.options.updateElement&&"id"!==t.options.attr&&t.setElProp(t.value())},bindEl:function(){var t=this;if(3==t.options.el.nodeType)throw"Attribute binding cannot be used with text nodes";t.$el.on("change.binding",t.elChanged)},unbindEl:function(){var t=this;t.$el.off("change.binding",t.elChanged),this._modelPath=null},setElProp:function(val){var t=this;if(t.options.updateElement)if(t.$el.is('input[type="radio"]')&&"data-xt-value"===t.options.attr){var $el=t.$el.closest("form");0===$el.length&&($el=$(document)),$el=$el.find($x.format('input[type="radio"][name="{0}"][value="{1}"]',t.$el.attr("name"),val)),$el.prop("checked","checked")}else t.$el.is('input[type="checkbox"]')&&"data-xt-value"===t.options.attr?val==t.$el.val()?t.$el.prop("checked","checked"):t.$el.prop("checked",""):"value"===t.options.attr?t.$el.val(val):"data-xt-src"==t.options.attr&&t.$el.is("img")?t.$el.attr("src",val):t.$el.attr(t.options.attr,val)},elChanged:function(evt,ui){this.setModelAttr(this.elementValue())},dispose:function(){this.unbindModel(),this.unbindEl()}}),$x.extend(mvvm.AttributeBinding.prototype,mvvm.ModelNavMixins),mvvm.TextNodeBinding=mvvm.Binding.extend({constructor:function(options){var t=this;if(this.options=$x.extend({},options),this.options=_.defaults(this.options,this.defaults),null===t.options.model||null===t.options.paths||0===t.options.paths.length||null===t.options.el||null==t.options.pattern)throw"model, path, el, and attr options are required";t.options.el instanceof $&&(t.options.el=t.options.el.get(0)),this._modelPaths={},this._callbacks={},_.bindAll(this,"initialize","value","modelChanged","bindModel","updateText","dispose"),this.bindModel(),this.initialize()},initialize:function(){this.updateText()},defaults:{model:null,paths:null,el:null,pattern:null},bindModel:function(path){var paths,t=this;paths=1===arguments.length?[path]:this.options.paths,_.each(paths,function(p){t._callbacks[p]=_.bind(t.modelChanged,t,p),t.bindModelExpression(t.options.model,p,t._callbacks[p])})},value:function(path){var t=this,result=t.resolveModelExpression(t.options.model,path,{evalVal:!0,allowPartial:!1});return _.isArray(result)&&result.length>0?_.last(result):void 0},modelChanged:function(path){var t=this;t.updateText()},updateText:function(){var t=this,vals=[t.options.pattern],html=!1;_.each(t.options.paths,function(p){var v=t.value(p);v=void 0==v?"":v.toString(),_.has(p,"html")&&"true"===p.html?(vals.push(v),html=!0):(v=v?t.escapeHtml(v):v,vals.push(v))});var text=$x.format.apply(this,vals).replace(/&#123;/,"{").replace(/&#125;/,"}");if(_.has(t.options,"attribute"))$(t.options.el).attr(t.options.attribute,t.escapeEntities(text));else if(html){var node=document.createElement("div"),$el=$(t.options.el),parent=$el.parent().get(0),elems=t.options.el;elems=elems instanceof NodeList?[].slice.call(elems):[t.options.el],node.innerHTML=text,node=[].slice.call(node.childNodes),_.each(node,function(val){parent.insertBefore(val,elems[0])}),_.each(elems,function(val){parent.removeChild(val)}),$(node).parents("html").length>0&&$(node).filter("script").each(function(){$.globalEval(this.text||this.textContent||this.innerHTML||"")}),t.options.el=node}else t.options.el.nodeValue=t.escapeEntities(text)},escapeHtml:function(unsafe){return unsafe.replace(/&<>"/g,function(str){return mvvm.TextNodeBinding.HtmlEntities[str]})},escapeEntities:function(unsafe){return unsafe.replace(/[^\x20-\x7E]/g,function(str){
return mvvm.TextNodeBinding.EntityCodes[str]?"&"+mvvm.TextNodeBinding.EntityCodes[str]+";":str})},dispose:function(){var t=this,paths=this.options.paths;_.each(paths,function(p){t.unbindModelExpression(t.options.model,p,t._callbacks[p])}),t._modelPaths={},t._callbacks={},delete t._callbacks,delete t._modelPaths}}),$x.extend(mvvm.TextNodeBinding.prototype,mvvm.ModelNavMixins),mvvm.TextNodeBinding.HtmlEntities={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"},mvvm.TextNodeBinding.EntityCodes={apos:39,quot:34,amp:38,lt:60,gt:62,nbsp:160,iexcl:161,cent:162,pound:163,curren:164,yen:165,brvbar:166,sect:167,uml:168,copy:169,ordf:170,laquo:171,not:172,shy:173,reg:174,macr:175,deg:176,plusmn:177,sup2:178,sup3:179,acute:180,micro:181,para:182,middot:183,cedil:184,sup1:185,ordm:186,raquo:187,frac14:188,frac12:189,frac34:190,iquest:191,Agrave:192,Aacute:193,Acirc:194,Atilde:195,Auml:196,Aring:197,AElig:198,Ccedil:199,Egrave:200,Eacute:201,Ecirc:202,Euml:203,Igrave:204,Iacute:205,Icirc:206,Iuml:207,ETH:208,Ntilde:209,Ograve:210,Oacute:211,Ocirc:212,Otilde:213,Ouml:214,times:215,Oslash:216,Ugrave:217,Uacute:218,Ucirc:219,Uuml:220,Yacute:221,THORN:222,szlig:223,agrave:224,aacute:225,acirc:226,atilde:227,auml:228,aring:229,aelig:230,ccedil:231,egrave:232,eacute:233,ecirc:234,euml:235,igrave:236,iacute:237,icirc:238,iuml:239,eth:240,ntilde:241,ograve:242,oacute:243,ocirc:244,otilde:245,ouml:246,divide:247,oslash:248,ugrave:249,uacute:250,ucirc:251,uuml:252,yacute:253,thorn:254,yuml:255,OElig:338,oelig:339,Scaron:352,scaron:353,Yuml:376,fnof:402,circ:710,tilde:732,Alpha:913,Beta:914,Gamma:915,Delta:916,Epsilon:917,Zeta:918,Eta:919,Theta:920,Iota:921,Kappa:922,Lambda:923,Mu:924,Nu:925,Xi:926,Omicron:927,Pi:928,Rho:929,Sigma:931,Tau:932,Upsilon:933,Phi:934,Chi:935,Psi:936,Omega:937,alpha:945,beta:946,gamma:947,delta:948,epsilon:949,zeta:950,eta:951,theta:952,iota:953,kappa:954,lambda:955,mu:956,nu:957,xi:958,omicron:959,pi:960,rho:961,sigmaf:962,sigma:963,tau:964,upsilon:965,phi:966,chi:967,psi:968,omega:969,thetasym:977,upsih:978,piv:982,ensp:8194,emsp:8195,thinsp:8201,zwnj:8204,zwj:8205,lrm:8206,rlm:8207,ndash:8211,mdash:8212,lsquo:8216,rsquo:8217,sbquo:8218,ldquo:8220,rdquo:8221,bdquo:8222,dagger:8224,Dagger:8225,bull:8226,hellip:8230,permil:8240,prime:8242,Prime:8243,lsaquo:8249,rsaquo:8250,oline:8254,frasl:8260,euro:8364,image:8465,weierp:8472,real:8476,trade:8482,alefsym:8501,larr:8592,uarr:8593,rarr:8594,darr:8595,harr:8596,crarr:8629,lArr:8656,uArr:8657,rArr:8658,dArr:8659,hArr:8660,forall:8704,part:8706,exist:8707,empty:8709,nabla:8711,isin:8712,notin:8713,ni:8715,prod:8719,sum:8721,minus:8722,lowast:8727,radic:8730,prop:8733,infin:8734,ang:8736,and:8743,or:8744,cap:8745,cup:8746,"int":8747,there4:8756,sim:8764,cong:8773,asymp:8776,ne:8800,equiv:8801,le:8804,ge:8805,sub:8834,sup:8835,nsub:8836,sube:8838,supe:8839,oplus:8853,otimes:8855,perp:8869,sdot:8901,lceil:8968,rceil:8969,lfloor:8970,rfloor:8971,lang:9001,rang:9002,loz:9674,spades:9824,clubs:9827,hearts:9829,diams:9830},mvvm.CssClassBinding=mvvm.Binding.extend({constructor:function(options){var t=this;if(this.options=$x.extend({},options),this.options=_.defaults(this.options,this.defaults),null===t.options.model||null===t.options.path||null===t.options.el||null===t.options.cssClass)throw"model, path, cssClass, and el are required";t.$el=$(t.options.el),_.bindAll(this,"value","modelChanged","bindModel","unbindModel","setElClasses","dispose"),this.bindModel(),this.initialize()},initialize:function(){var t=this;t.setElClasses(t.value()),t.$el.removeAttr("data-xt-class-"+t.options.cssClass)},defaults:{model:null,expression:null,el:null,attr:null},bindModel:function(){this._modelPath=this.resolveModelExpression(this.options.model,this.options.expression,{evalVal:!1,allowPartial:!1}),this.bindModelExpression(this.options.model,this.options.expression,this.modelChanged)},unbindModel:function(){this.unbindModelExpression(this.options.model,this.options.expression,this.modelChanged)},value:function(){if("undefined"!=typeof this._modelPath&&0!==this._modelPath.length){var val=this._modelPath[this._modelPath.length-1];return _.isFunction(val)&&(val=val()),this._applyBindExpression(this.options.expression,val,this.options.model)}},modelChanged:function(event,model,options){var t=this;this._modelPath=this.resolveModelExpression(this.options.model,this.options.expression,{evalVal:!1,allowPartial:!1}),t.setElClasses(t.value())},setElClasses:function(val){var t=this;val?t.$el.addClass(t.options.cssClass,val):t.$el.removeClass(t.options.cssClass,val)},dispose:function(){this.unbindModel()}}),$x.extend(mvvm.CssClassBinding.prototype,mvvm.ModelNavMixins),mvvm.SelectBinding=mvvm.Binding.extend({constructor:function(options){var t=this;if(this.options=$x.extend({},options),this.options=_.defaults(this.options,this.defaults),null===t.options.model||null===t.options.path||null===t.options.el)throw"model, path, and el options are required";t.$el=$(t.options.el),_.bindAll(this,"value","bindModel","unbindModel","modelChanged","bindEl","createOptions","dispose"),this.bindModel(),this.bindEl(),this.initialize()},initialize:function(){var t=this,curr=t.$el.val();t.createOptions(t.value()),0===t.$el.children(":selected").length&&t.$el.val(t.$el.children(0).val());var after=t.$el.val();after!=curr&&t.$el.trigger("change")},defaults:{model:null,path:null,el:null,textField:"name",valueField:"value"},bindModel:function(){this._modelPath=this.resolveModelPath(this.options.model,this.options.path,{evalVal:!1,allowPartial:!1}),this.bindModelPath(this.options.model,this.options.path,this.modelChanged)},unbindModel:function(){var t=this;_.each(t._bindingCallbacks,function(elem,idx){t.unbindModelExpression(elem.model,elem.expression,elem.callback)}),this._bindingCallbacks=[]},value:function(){if("undefined"!=typeof this._modelPath&&0!==this._modelPath.length){var val=this._modelPath[this._modelPath.length-1];return _.isFunction(val)?val():val}},modelChanged:function(event,model,options){var t=this;this._modelPath=this.resolveModelPath(this.options.model,this.options.path,{evalVal:!1,allowPartial:!1}),t.createOptions(t.value())},bindEl:function(){var t=this;if(!t.options.el.is("select"))throw"el must be of node type <select>";$(t.options.el)},unbindEl:function(){var t=this,$el=$(t.options.el);$el.off("change.binding",t.elChanged),this._modelPath=null},createOptions:function(val){var t=this,$el=$(t.options.el),currVal=$el.val();$el.empty();var createOption=function(obj,key,list){var title=_.resultBB(obj,t.options.textField),value=_.resultBB(obj,t.options.valueField),opt=$(document.createElement("option"));opt.text(title).val(value),$el.append(opt)};val instanceof mvvm.Collection?val.each(createOption):_.each(val,createOption),$el.children("option").length>1&&$el.val(currVal)},dispose:function(){this.unbindModel(),this.unbindEl()}}),$x.extend(mvvm.SelectBinding.prototype,mvvm.ModelNavMixins),mvvm.Trigger=function(options){var t=this;(null===arguments||0===arguments.length)&&(options={}),t.options=_.defaults(options,t.defaults),t.initialize.apply(this)},$x.extend(mvvm.Trigger.prototype,{defaults:{el:null,event:"click"},initialize:function(){_.bindAll(this,"onTrigger","onTriggerInv","onTriggerInternal","onTriggerInvInternal","bind","unbind","dispose"),this.bind()},onTrigger:function(evt){},onTriggerInv:function(evt){},onTriggerInternal:function(evt){var t=this,nEvt=new mvvm.Event({event:t.options.event,target:evt.target});t.onTrigger(nEvt),nEvt.isDefaultPrevented()&&evt.preventDefault()},onTriggerInvInternal:function(evt){var t=this,nEvt=new mvvm.Event({event:t.options.event});t.onTrigger(nEvt),nEvt.isDefaultPrevented()&&evt.preventDefault()},bind:function(){var t=this,$el=$(t.options.el);switch(t.options.event){case null:throw"Event name cannot be null";case"hover":$el.on("mouseenter.binding",t.onTriggerInternal),$el.on("mouseleave.binding",t.onTriggerInvInternal);break;default:$el.on(t.options.event+".binding",t.onTriggerInternal)}},unbind:function(){var t=this,$el=$(t.options.el);switch(t.options.event){case null:throw"Event name cannot be null";case"hover":$el.off("mouseenter.binding",t.onTriggerInternal),$el.on("mouseleave.binding",t.onTriggerInvInternal);break;default:$el.off(t.options.event+".binding",t.onTriggerInternal)}},dispose:function(){this.unbind()}}),mvvm.Trigger.extend=$x.extendClass,mvvm.StyleTrigger=mvvm.Trigger.extend({initialize:function(){mvvm.Trigger.prototype.initialize.call(this)},defaults:{el:null,event:"click",target:null},onTrigger:function(){var t=this,$el=$(t.options.el),target=$el;null!=t.options.target&&(target=t.getTarget($el)),null!=t.options.cssClass&&(t.options.cssClass instanceof Array?_.each(t.options.cssClass,function(elem,idx,list){target.addClass(elem)}):target.addClass(t.options.cssClass)),null!=t.options.styles&&(t.prevStyles={},_.each(t.options.styles,function(value,key,list){t.prevStyles[key]=target.css(key),target.css(key,value)}))},onTriggerInv:function(){var target=$el;null!=t.options.target&&(target=t.getTarget($el)),null!=this.options.cssClass&&(this.options.cssClass instanceof Array?_.each(this.options.cssClass,function(elem,idx,list){target.removeClass(elem)}):target.removeClass(this.options.cssClass)),null!=this.options.styles&&(this.prevStyles={},_.each(this.options.styles,function(value,key,list){target.css(key,this.prevStyles[key])}))},getTarget:function($el){return $el}}),$x.extend(mvvm.StyleTrigger.prototype,mvvm.ModelNavMixins),mvvm.Actions=_.extend({},{}),mvvm.ActionTrigger=mvvm.Trigger.extend({defaults:{el:null,event:"click",context:{},action:null,data:void 0},initialize:function(){mvvm.Trigger.prototype.initialize.call(this)},onTrigger:function(evt){var t=this;if(null!=t.options.context&&null!=t.options.action){var action=t.resolveModelExpression(t.options.context,t.options.action,{evalVal:!1});_.isArray(action)&&(action=_.last(action));var value=t.options.data,hasValue=void 0!==t.options.data;hasValue&&_.has(value,"path")&&(evt.data=t.resolveModelExpressionValue(t.options.context,value)),action(evt)}}}),$x.extend(mvvm.ActionTrigger.prototype,mvvm.ModelNavMixins);var createPlaceholderNode=function(){return document.createTextNode("")},tmplBlockInst=function(options){var t=this;t.options=$x.extend({},options),arguments.length>0&&(_.defaults(t.options,t.defaults),options.el&&this.setEl(options.el)),t.initialize()};tmplBlockInst.extend=$x.extendClass,$x.extend(tmplBlockInst.prototype,{defaults:{block:null,context:null,el:null},initialize:function(){var t=this;t.childInstances=[],_.bindAll(t,"render")},render:function(){},renderInternal:function(block,el,context){var t=this,block=block?block:this.options.block,$el=$(el),instances=[];return _.each(block.childNodes,function(val,idx){var inst=val.createInstance($el,context);instances.push(inst),t.childInstances.push(inst),inst instanceof tmplBlockInst&&inst.render()}),instances},renderLocalBindingsAndTriggers:function(block,el,context){var t=this,block=block?block:this.options.block,$el=$(el),nodes=_.filter(block.childNodes,function(b){return("bind"===b.type.type||"trigger"===b.type.type)&&0===b.position.length});_.each(nodes,function(val,idx){var inst=val.createInstance($el,context);t.childInstances.push(inst),inst instanceof tmplBlockInst&&inst.render()})},setEl:function(el){this.el=el,this.$el=$(el)},resolveElement:function($el,indices){var curr=$el;return _.each(indices,function(val){curr=curr.contents().eq(val)}),curr},clear:function(){var t=this;_.each(t.childInstances,function(item){item.dispose&&item.dispose()}),t.childInstances=[],t.$el.empty()},dispose:function(){var t=this;t.clear()},createContext:function(properties,baseContext){var context,t=this;return context=null!=baseContext?t.options.context.clone():new mvvm.Model,_.each(properties,function(value,key,list){context.set(key,value),_.isUndefined(value)||_.isNull(value)||context.createField(key,{type:value.constructor})}),context}}),$x.extend(tmplBlockInst.prototype,mvvm.ModelNavMixins);var TemplateBlockInst=tmplBlockInst.extend({initialize:function(){tmplBlockInst.prototype.initialize.apply(this),_.bindAll(this,"render")},render:function(){var t=this,block=t.options.block;t.setEl(block.$el.clone());var context=t.createContext(t.options.context);t.renderInternal(block,t.$el,context),t.$el.removeClass("xt-template")}}),ChildTemplateBlockInst=tmplBlockInst.extend({initialize:function(){var t=this;tmplBlockInst.prototype.initialize.apply(this),_.bindAll(t,"modelChanged","render");var mod=t.options.block.model;t.bindModelExpression(t.options.context,mod,t.modelChanged),t.model=t.resolveModelExpressionValue(t.options.context,mod)},modelChanged:function(){var mod=t.options.block.model;t.unbindModelPath(t.options.context,mod,t.modelChanged),t.bindModelExpression(t.options.context,mod,t.modelChanged),t.model=t.resolveModelExpressionValue(t.options.context,mod)},render:function(){var t=this,block=t.options.block;t.clear();var template=block.template;if((_.isUndefined(template)||_.isNull(template))&&t.model instanceof mvvm.ViewModel){var rplc=t.model.render();rplc.insertBefore(t.$el.eq(0)),t.$el.remove(),t.setEl(rplc)}else{_.isObject(template)&&(template=t.resolveModelExpressionValue(t.options.context,template)),$x.template(template)("destroy",t.$el);var rplc=$x.template(template)(t.model);rplc.insertBefore(t.$el.eq(0)),t.$el.remove(),t.setEl(rplc)}},dispose:function(){var t=this,block=t.options.block;t.clear();var template=block.template;(_.isUndefined(template)||_.isNull(template))&&t.model instanceof mvvm.ViewModel&&t.model.dispose()}}),IfBlockInst=tmplBlockInst.extend({initialize:function(){var t=this,block=t.options.block;t.current=null;for(var $el=t.$el,$next=$el.next();$next.filter("[data-xt-else-if]").length>0;)t.$el=t.$el.add($next),$next=$next.next();$next.filter("[data-xt-else]").length>0&&(t.$el=t.$el.add($next)),tmplBlockInst.prototype.initialize.apply(t),_.bindAll(t,"render"),this.branches=[],_.each(block.branches,function(val,idx){var branch={};branch.callback=_.bind(t.modelChanged,t,idx),branch.value=t.resolveModelExpressionValue(t.options.context,val.expression),null===t.current&&branch.value&&(t.current=idx),t.bindModelExpression(t.options.context,val.expression,branch.callback),t.branches.push(branch)})},modelChanged:function(idx){var t=this,block=t.options.block,bbranch=block.branches[idx],branch=t.branches[idx],curr=branch.value;if(branch.value=t.resolveModelExpressionValue(t.options.context,bbranch.expression),(null===t.current||idx<=t.current)&&branch.value!=curr){for(var next=null,i=0;i<t.branches.length;i++)if(this.branches[i].value){next=i;break}null===next&&null!==block.defaultBranch&&(next=t.branches.length),t.current=next,t.render()}},render:function(){var t=this,node=t.options.block,block=null!==t.current&&t.current<t.branches.length?node.branches[t.current]:node.defaultBranch;t.clear();var $next=null;if(block){var $next=block.$el.clone();t.renderInternal(block,$next,t.options.context)}else $next=$(createPlaceholderNode());for(var i=0;i<t.branches.length-1;i++)$next=$next.add(createPlaceholderNode());if(null!==node.defaultBranch&&($next=$next.add(createPlaceholderNode())),$next.removeAttr("data-xt-if").removeAttr("data-xt-else-if").removeAttr("data-xt-else"),t.$el.eq(0).prev().length?$next.insertBefore(t.$el.eq(0)):t.$el.eq(0).parent().prepend($next),t.$el.remove(),t.setEl($next),block&&_.has(block,"onrender")){var action=t.resolveModelExpression(t.options.context,block.onrender);_.isArray(action)&&action.length>0&&(action=_.last(action))($next)}}}),ForeachBlockInst=tmplBlockInst.extend({initialize:function(){var t=this;tmplBlockInst.prototype.initialize.apply(this);var mod=t.options.block.expression;_.bindAll(t,"render","modelChanged"),t.bindModelExpression(t.options.context,mod,t.modelChanged),t.value=t.resolveModelExpressionValue(t.options.context,mod),t.blocks={}},modelChanged:function(event){var t=this,mod=t.options.block.expression,nextVal=t.resolveModelExpressionValue(t.options.context,mod),update=t.value!=nextVal||"add"===event||"remove"===event||"sort"===event||"reset"===event;t.value=nextVal,update&&(t.value=t.resolveModelExpressionValue(t.options.context,mod),t.render())},render:function(){var t=this,block=t.options.block;if(t.$el.contents().detach(),t.renderLocalBindingsAndTriggers(t.options.block,t.$el,t.options.context),t.value&&t.value.length>0){var iterName=block.iterator,indexerName=_.has(block,"indexer")?block.indexer:void 0;block.$el.clone().children();t.$el.removeAttr("data-xt-foreach"),t.$el.removeAttr("data-xt-iterator");var rerender=function(elem,idx,list){var cid=elem.cid;if(cid&&_.has(t.blocks,cid)&&(t.blocks[cid].index===idx||void 0===indexerName))return t.$el.append(t.blocks[cid].$el),_.each(t.blocks[cid].childInstances,function(n){t.childInstances.push(n)}),void delete t.blocks[cid];var attrs={};void 0!==indexerName&&(attrs[indexerName]=idx),attrs[iterName]=elem;var context=t.createContext(attrs,t.options.context),rplc=$(block.el).clone(),insts=t.renderInternal(t.options.block,rplc,context);elem.cid&&(t.nextBlocks[elem.cid]={index:idx,item:elem,$el:rplc.children(),childInstances:insts}),t.$el.append(rplc.children())};t.nextBlocks={};var childInstances=t.childInstances;t.childInstances=[],t.value instanceof mvvm.Collection?t.value.forEach(rerender):_.each(t.value,rerender),_.each(childInstances,function(b){_.contains(t.childInstances,b)||b.dispose()}),t.blocks=t.nextBlocks,delete t.nextBlocks}if(_.has(block,"onrender")){var action=t.resolveModelExpression(t.options.context,block.onrender);_.isArray(action)&&action.length>0&&(action=_.last(action))($next)}}}),templateInstances={};return mvvm.Template=function(block,context){var t=this;t.block=block,t.context=context,t.tmplID=Math.floor(1e8*Math.random()),templateInstances[t.tmplID]=this},$x.extend(mvvm.Template.prototype,{render:function(){var t=this;return t.instance=new TemplateBlockInst({block:t.block,context:t.context}),t.instance.render(),t.$el=t.instance.$el.children(),t.$el.first().data("template-id",t.tmplID),t.$el},dispose:function(){var t=this;t.$el.replaceWith(document.createTextNode("")),t.instance.dispose(),t.$el.remove()}}),mvvm.Template.compile=function(){var el;if(arguments.length>2)throw"Invalid arguments";el=arguments[0]instanceof $?arguments[0]:$(arguments[0]),el=$("<div></div>").append(el);var parser=new mvvm.templateParser,block=parser.parse(el);if(2===arguments.length&&arguments[1]===!0)return block;var handleCommand=function(cmd,model,options){if(!_.isString(cmd)){options=model,model=cmd;var context={model:model};options&&options.context&&$x.extend(context,options.context);var tmpl=new mvvm.Template(block,context);return tmpl.render()}var $el,cmd=arguments[0];if(!_.isString(cmd))throw"Invalid argument (1), String expected";switch(cmd){case"destroy":if(2!==arguments.length)throw"Invalid number of arguments";if($el=arguments[1],!($el instanceof $))throw"Invalid argument (2), jQuery expected";$el.first().data("template-id")&&templateInstances[$el.data("template-id")].dispose()}};return handleCommand},"undefined"!=typeof test&&(mvvm.templateInstances=templateInstances),mvvm}),"function"==typeof define&&define.amd&&define("xintricity",["xutil","xmvvm"],function(){});