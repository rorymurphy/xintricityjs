/*
Copyright (c) 2013, Rory Murphy
All rights reserved.

Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:

Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.
Neither the name of the Rory Murphy nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR
CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
*/(function(f,b){"function"===typeof define&&define.amd?define("XUtil",["jquery","underscore"],function(g,d){return f.XUtil=b(g,d,f)}):f.$x=f.XUtil=b(f.jQuery,f._,f)})(this,function(f,b,g){var d;"undefined"!==typeof l&&(d=l);var l={noConflict:function(){d?g.$x=d:delete g.$x},namespace:function(b){b=b.split(".");var d;f.each(b,function(b,e){0==b&&(d=g);e in d||(d[e]={});d=d[e]});return d},format:function(b){var d=arguments;return b=b.replace(/\{(\d+)\}/ig,function(b,e,k,q){return d[parseInt(e)+1]})}},
p=/\/[^w_]+\//;l.slugify=function(b){return b.replace(p,"-").toLowerCase()};l.extend=function(d){b.each(Array.prototype.slice.call(arguments,1),function(b){if(b){var f="undefined"!==typeof{}.__lookupGetter__,e;for(e in b){var k,q;f&&(k=b.__lookupGetter__(e),q=b.__lookupSetter__(e));k||q?(k&&d.__defineGetter__(e,k),q&&d.__defineSetter__(e,q)):d[e]=b[e]}}});return d};l.extendClass=function(d,f){var g=this,e;e=d&&b.has(d,"constructor")?d.constructor:function(){return g.apply(this,arguments)};l.extend(e,
g,f);var k=function(){this.constructor=e};k.prototype=g.prototype;e.prototype=new k;d&&l.extend(e.prototype,d);e.__super__=g.prototype;return e};return l});
(function(f,b){"function"===typeof define&&define.amd?define("XBase",["underscore"],function(g){return f.__XBase__=b(f,g)}):f.__XBase__=b(f,_)})(this,function(f,b){var g=[].slice,d;d="undefined"!==typeof exports?exports:{};d.VERSION="1.1.0";(b=f._)||"undefined"===typeof require||(b=require("underscore"));var l=f.$x;l||"undefined"===typeof require||(l=require("XUtil"));var p=f.XMVVM;p||"undefined"===typeof require||(p=require("XMVVM"));d.$=f.jQuery||f.Zepto||f.ender||f.$;d.emulateHTTP=!1;d.emulateJSON=
!1;var p=l.extendClass,C=function(){throw Error('A "url" property or function must be specified');},y=function(a,b){var c=b.error;b.error=function(h){c&&c(a,h,b);a.trigger("error",a,h,b)}},v=0;d.Event=function(a){this.eid="e"+v;v++;var b=!1;this.preventDefault=function(){b=!0};this.isDefaultPrevented=function(){return b};var c=!1;this.bubble=function(){c=!0};this.isBubbled=function(){return c};l.extend(this,a)};d.Event.extend=l.extendClass;var e=d.Events={on:function(a,b,c,h){if(!q(this,"on",a,[b,
c])||!b)return this;this._events||(this._events={});(this._events[a]||(this._events[a]=[])).push({callback:b,context:c,bubbled:h,ctx:c||this});return this},once:function(a,u,c,h){if(!q(this,"once",a,[u,c])||!u)return this;var e=this,d=b.once(function(){e.off(a,d,c,h);u.apply(this,arguments)});d._callback=u;return this.on(a,d,c,h)},off:function(a,u,c,h){var e,d,k,n,f,x,D,m;if(!this._events||!q(this,"off",a,[u,c]))return this;if(!(a||u||c||h))return this._events={},this;n=a?[a]:b.keys(this._events);
f=0;for(x=n.length;f<x;f++)if(a=n[f],k=this._events[a]){this._events[a]=e=[];if(u||c||h)for(D=0,m=k.length;D<m;D++)d=k[D],(u&&u!==d.callback&&u!==d.callback._callback||c&&c!==d.context||h&&h!==d.bubbled)&&e.push(d);e.length||delete this._events[a]}return this},trigger:function(a){if(!this._events)return this;var u=g.call(arguments,1);if(!q(this,"trigger",a,u))return this;var c=this._events[a];u[0]instanceof d.Event&&u[0].isBubbled()&&(c=b.filter(c,function(a){return a.bubbled}));var h=this._events.all;
c&&z(c,u);h&&z(h,arguments);return this},stopListening:function(a,u,c){var h=this._listeningTo;if(!h)return this;var e=!u&&!c;c||"object"!==typeof u||(c=this);a&&((h={})[a._listenId]=a);for(var d in h)a=h[d],a.off(u,c,this),(e||b.isEmpty(a._events))&&delete this._listeningTo[d];return this}},k=/\s+/,q=function(a,b,c,h){if(!c)return!0;if("object"===typeof c){for(var e in c)a[b].apply(a,[e,c[e]].concat(h));return!1}if(k.test(c)){c=c.split(k);e=0;for(var d=c.length;e<d;e++)a[b].apply(a,[c[e]].concat(h));
return!1}return!0},z=function(a,b){var c,h=-1,e=a.length,d=b[0],k=b[1],n=b[2];switch(b.length){case 0:for(;++h<e;)(c=a[h]).callback.call(c.ctx);break;case 1:for(;++h<e;)(c=a[h]).callback.call(c.ctx,d);break;case 2:for(;++h<e;)(c=a[h]).callback.call(c.ctx,d,k);break;case 3:for(;++h<e;)(c=a[h]).callback.call(c.ctx,d,k,n);break;default:for(;++h<e;)(c=a[h]).callback.apply(c.ctx,b)}};b.each({listenTo:"on",listenToOnce:"once"},function(a,c){e[c]=function(c,h,u){var e=this._listeningTo||(this._listeningTo=
{}),d=c._listenId||(c._listenId=b.uniqueId("l"));e[d]=c;u||"object"!==typeof h||(u=this);c[a](h,u,this);return this}});e.bind=e.on;e.unbind=e.off;b.extend(d,e);var m=d.Model=function(a,c){var h=a||{};c||(c={});this.cid=b.uniqueId("c");this.attributes={};c.collection&&(this.collection=c.collection);c.parse&&(h=this.parse(h,c)||{});h=b.defaults({},h,b.result(this,"defaults"));this.set(h,c);this.changed={};this.initialize.apply(this,arguments)};b.extend(m.prototype,e,{changed:null,validationError:null,
idAttribute:"id",initialize:function(){},toJSON:function(a){return b.clone(this.attributes)},sync:function(){return d.sync.apply(this,arguments)},get:function(a){return this.attributes[a]},escape:function(a){return b.escape(this.get(a))},has:function(a){return null!=this.get(a)},set:function(a,c,h){var e,d,k,n,q,f,x;if(null==a)return this;"object"===typeof a?(d=a,h=c):(d={})[a]=c;h||(h={});if(!this._validate(d,h))return!1;k=h.unset;n=h.silent;a=[];q=this._changing;this._changing=!0;q||(this._previousAttributes=
b.clone(this.attributes),this.changed={});x=this.attributes;f=this._previousAttributes;this.idAttribute in d&&(this.id=d[this.idAttribute]);for(e in d)c=d[e],b.isEqual(x[e],c)||a.push(e),b.isEqual(f[e],c)?delete this.changed[e]:this.changed[e]=c,k?delete x[e]:x[e]=c;if(!n)for(a.length&&(this._pending=!0),c=0,e=a.length;c<e;c++)this.trigger("change:"+a[c],this,x[a[c]],h);if(q)return this;if(!n)for(;this._pending;)this._pending=!1,this.trigger("change",this,h);this._changing=this._pending=!1;return this},
unset:function(a,c){return this.set(a,void 0,b.extend({},c,{unset:!0}))},clear:function(a){var c={},h;for(h in this.attributes)c[h]=void 0;return this.set(c,b.extend({},a,{unset:!0}))},hasChanged:function(a){return null==a?!b.isEmpty(this.changed):b.has(this.changed,a)},changedAttributes:function(a){if(!a)return this.hasChanged()?b.clone(this.changed):!1;var c,h=!1,e=this._changing?this._previousAttributes:this.attributes,d;for(d in a)b.isEqual(e[d],c=a[d])||((h||(h={}))[d]=c);return h},previous:function(a){return null!=
a&&this._previousAttributes?this._previousAttributes[a]:null},previousAttributes:function(){return b.clone(this._previousAttributes)},fetch:function(a){a=a?b.clone(a):{};void 0===a.parse&&(a.parse=!0);var c=this,h=a.success;a.success=function(b){if(!c.set(c.parse(b,a),a))return!1;h&&h(c,b,a);c.trigger("sync",c,b,a)};y(this,a);return this.sync("read",this,a)},save:function(a,c,h){var e,d=this.attributes;null==a||"object"===typeof a?(e=a,h=c):(e={})[a]=c;h=b.extend({validate:!0},h);if(e&&!h.wait){if(!this.set(e,
h))return!1}else if(!this._validate(e,h))return!1;e&&h.wait&&(this.attributes=b.extend({},d,e));void 0===h.parse&&(h.parse=!0);var k=this,n=h.success;h.success=function(a){k.attributes=d;var c=k.parse(a,h);h.wait&&(c=b.extend(e||{},c));if(b.isObject(c)&&!k.set(c,h))return!1;n&&n(k,a,h);k.trigger("sync",k,a,h)};y(this,h);a=this.isNew()?"create":h.patch?"patch":"update";"patch"===a&&(h.attrs=e);a=this.sync(a,this,h);e&&h.wait&&(this.attributes=d);return a},destroy:function(a){a=a?b.clone(a):{};var c=
this,h=a.success,e=function(){c.trigger("destroy",c,c.collection,a)};a.success=function(b){(a.wait||c.isNew())&&e();h&&h(c,b,a);c.isNew()||c.trigger("sync",c,b,a)};if(this.isNew())return a.success(),!1;y(this,a);var d=this.sync("delete",this,a);a.wait||e();return d},url:function(){var a=b.result(this,"urlRoot")||b.result(this.collection,"url")||C();return this.isNew()?a:a+("/"===a.charAt(a.length-1)?"":"/")+encodeURIComponent(this.id)},parse:function(a,b){return a},clone:function(){return new this.constructor(this.attributes)},
isNew:function(){return null==this.id},isValid:function(a){return this._validate({},b.extend(a||{},{validate:!0}))},_validate:function(a,c){if(!c.validate||!this.validate)return!0;a=b.extend({},this.attributes,a);var h=this.validationError=this.validate(a,c)||null;if(!h)return!0;this.trigger("invalid",this,h,b.extend(c,{validationError:h}));return!1}});b.each("keys values pairs invert pick omit".split(" "),function(a){m.prototype[a]=function(){var c=g.call(arguments);c.unshift(this.attributes);return b[a].apply(b,
c)}});var r=d.Collection=function(a,c){c||(c={});c.model&&(this.model=c.model);void 0!==c.comparator&&(this.comparator=c.comparator);this._reset();this.initialize.apply(this,arguments);a&&this.reset(a,b.extend({silent:!0},c))},s={add:!0,remove:!0,merge:!0},w={add:!0,remove:!1};b.extend(r.prototype,e,{model:m,initialize:function(){},toJSON:function(a){return this.map(function(b){return b.toJSON(a)})},sync:function(){return d.sync.apply(this,arguments)},add:function(a,c){return this.set(a,b.extend({merge:!1},
c,w))},remove:function(a,c){var h=!b.isArray(a);a=h?[a]:b.clone(a);c||(c={});var e,d,k,n;e=0;for(d=a.length;e<d;e++)if(n=a[e]=this.get(a[e]))delete this._byId[n.id],delete this._byId[n.cid],k=this.indexOf(n),this.models.splice(k,1),this.length--,c.silent||(c.index=k,this.trigger("remove",n,this,c)),this._removeReference(n);return h?a[0]:a},set:function(a,c){c=b.defaults({},c,s);c.parse&&(a=this.parse(a,c));var h=!b.isArray(a);a=h?a?[a]:[]:b.clone(a);var e,d,k,n,q,f,x=c.at,D=this.model,z=this.comparator&&
null==x&&!1!==c.sort,l=b.isString(this.comparator)?this.comparator:null,g=[],G=[],p={},r=c.add,I=c.merge,B=c.remove,A=!z&&r&&B?[]:!1;e=0;for(d=a.length;e<d;e++){q=a[e];k=q instanceof m?n=q:q[D.prototype.idAttribute];if(k=this.get(k))B&&(p[k.cid]=!0),I&&(q=q===n?n.attributes:q,c.parse&&(q=k.parse(q,c)),k.set(q,c),z&&!f&&k.hasChanged(l)&&(f=!0)),a[e]=k;else if(r){n=a[e]=this._prepareModel(q,c);if(!n)continue;g.push(n);n.on("all",this._onModelEvent,this);this._byId[n.cid]=n;null!=n.id&&(this._byId[n.id]=
n)}A&&A.push(k||n)}if(B){e=0;for(d=this.length;e<d;++e)p[(n=this.models[e]).cid]||G.push(n);G.length&&this.remove(G,c)}if(g.length||A&&A.length)if(z&&(f=!0),this.length+=g.length,null!=x)for(e=0,d=g.length;e<d;e++)this.models.splice(x+e,0,g[e]);else for(A&&(this.models.length=0),n=A||g,e=0,d=n.length;e<d;e++)this.models.push(n[e]);f&&this.sort({silent:!0});if(!c.silent){e=0;for(d=g.length;e<d;e++)n=g[e],this.trigger("add",n,this,c);(f||A&&A.length)&&this.trigger("sort",this,c)}return h?a[0]:a},reset:function(a,
c){c||(c={});for(var h=0,e=this.models.length;h<e;h++)this._removeReference(this.models[h]);c.previousModels=this.models;this._reset();a=this.add(a,b.extend({silent:!0},c));c.silent||this.trigger("reset",this,c);return a},push:function(a,c){return this.add(a,b.extend({at:this.length},c))},pop:function(a){var c=this.at(this.length-1);this.remove(c,a);return c},unshift:function(a,c){return this.add(a,b.extend({at:0},c))},shift:function(a){var c=this.at(0);this.remove(c,a);return c},slice:function(){return g.apply(this.models,
arguments)},get:function(a){return null==a?void 0:this._byId[a.id]||this._byId[a.cid]||this._byId[a]},at:function(a){return this.models[a]},where:function(a,c){return b.isEmpty(a)?c?void 0:[]:this[c?"find":"filter"](function(c){for(var b in a)if(a[b]!==c.get(b))return!1;return!0})},findWhere:function(a){return this.where(a,!0)},sort:function(a){if(!this.comparator)throw Error("Cannot sort a set without a comparator");a||(a={});b.isString(this.comparator)||1===this.comparator.length?this.models=this.sortBy(this.comparator,
this):this.models.sort(b.bind(this.comparator,this));a.silent||this.trigger("sort",this,a);return this},pluck:function(a){return b.invoke(this.models,"get",a)},fetch:function(a){a=a?b.clone(a):{};void 0===a.parse&&(a.parse=!0);var c=a.success,h=this;a.success=function(b){h[a.reset?"reset":"set"](b,a);c&&c(h,b,a);h.trigger("sync",h,b,a)};y(this,a);return this.sync("read",this,a)},create:function(a,c){c=c?b.clone(c):{};if(!(a=this._prepareModel(a,c)))return!1;c.wait||this.add(a,c);var h=this,e=c.success;
c.success=function(a,c,b){b.wait&&h.add(a,b);e&&e(a,c,b)};a.save(null,c);return a},parse:function(a,c){return a},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0;this.models=[];this._byId={}},_prepareModel:function(a,c){if(a instanceof m)return a.collection||(a.collection=this),a;c=c?b.clone(c):{};c.collection=this;var h=new this.model(a,c);if(!h.validationError)return h;this.trigger("invalid",this,h.validationError,c);return!1},_removeReference:function(a){this===
a.collection&&delete a.collection;a.off("all",this._onModelEvent,this)},_onModelEvent:function(a,c,b,h){if("add"!==a&&"remove"!==a||b===this)"destroy"===a&&this.remove(c,h),c&&a==="change:"+c.idAttribute&&(delete this._byId[c.previous(c.idAttribute)],null!=c.id&&(this._byId[c.id]=c)),this.trigger.apply(this,arguments)}});b.each("forEach each map collect reduce foldl inject reduceRight foldr find detect filter select reject every all some any include contains invoke max min toArray size first head take initial rest tail drop last without difference indexOf shuffle lastIndexOf isEmpty chain".split(" "),
function(a){r.prototype[a]=function(){var c=g.call(arguments);c.unshift(this.models);return b[a].apply(b,c)}});b.each(["groupBy","countBy","sortBy"],function(a){r.prototype[a]=function(c,h){var e=b.isFunction(c)?c:function(a){return a.get(c)};return b[a](this.models,e,h)}});d.sync=function(a,c,h){var e=A[a];b.defaults(h||(h={}),{emulateHTTP:d.emulateHTTP,emulateJSON:d.emulateJSON});var k={type:e,dataType:"json"};h.url||(k.url=b.result(c,"url")||C());null!=h.data||!c||"create"!==a&&"update"!==a&&"patch"!==
a||(k.contentType="application/json",k.data=JSON.stringify(h.attrs||c.toJSON(h)));h.emulateJSON&&(k.contentType="application/x-www-form-urlencoded",k.data=k.data?{model:k.data}:{});if(h.emulateHTTP&&("PUT"===e||"DELETE"===e||"PATCH"===e)){k.type="POST";h.emulateJSON&&(k.data._method=e);var n=h.beforeSend;h.beforeSend=function(a){a.setRequestHeader("X-HTTP-Method-Override",e);if(n)return n.apply(this,arguments)}}"GET"===k.type||h.emulateJSON||(k.processData=!1);"PATCH"===k.type&&H&&(k.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")});
a=h.xhr=d.ajax(b.extend(k,h));c.trigger("request",c,a,h);return a};var H="undefined"!==typeof window&&!!window.ActiveXObject&&!(window.XMLHttpRequest&&(new XMLHttpRequest).dispatchEvent),A={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};d.ajax=function(){return d.$.ajax.apply(d.$,arguments)};var B=d.Router=function(a){a||(a={});a.routes&&(this.routes=a.routes);this._bindRoutes();this.initialize.apply(this,arguments)},F=/\((.*?)\)/g,E=/(\(\?)?:\w+/g,a=/\*\w+/g,c=/[\-{}\[\]+?.,\\\^$|#\s]/g;
b.extend(B.prototype,e,{initialize:function(){},route:function(a,c,h){b.isRegExp(a)||(a=this._routeToRegExp(a));b.isFunction(c)&&(h=c,c="");h||(h=this[c]);var e=this;d.history.route(a,function(b){b=e._extractParameters(a,b);h&&h.apply(e,b);e.trigger.apply(e,["route:"+c].concat(b));e.trigger("route",c,b);d.history.trigger("route",e,c,b)});return this},navigate:function(a,c){d.history.navigate(a,c);return this},_bindRoutes:function(){if(this.routes){this.routes=b.result(this,"routes");for(var a,c=b.keys(this.routes);null!=
(a=c.pop());)this.route(a,this.routes[a])}},_routeToRegExp:function(b){b=b.replace(c,"\\$&").replace(F,"(?:$1)?").replace(E,function(a,c){return c?a:"([^/]+)"}).replace(a,"(.*?)");return RegExp("^"+b+"$")},_extractParameters:function(a,c){var h=a.exec(c).slice(1);return b.map(h,function(a){return a?decodeURIComponent(a):null})}});H="undefined"!==typeof window&&!!window.ActiveXObject&&!(window.XMLHttpRequest&&(new XMLHttpRequest).dispatchEvent);A={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",
read:"GET"};d.ajax=function(){return d.$.ajax.apply(d.$,arguments)};var h=d.History=function(){this.handlers=[];b.bindAll(this,"checkUrl");"undefined"!==typeof window&&(this.location=window.location,this.history=window.history)},x=/^[#\/]|\s+$/g,D=/^\/+|\/+$/g,n=/msie [\w.]+/,G=/\/$/,I=/[?#].*$/;h.started=!1;b.extend(h.prototype,e,{interval:50,getHash:function(a){return(a=(a||this).location.href.match(/#(.*)$/))?a[1]:""},getFragment:function(a,c){if(null==a)if(this._hasPushState||!this._wantsHashChange||
c){a=this.location.pathname;var b=this.root.replace(G,"");a.indexOf(b)||(a=a.slice(b.length))}else a=this.getHash();return a.replace(x,"")},start:function(a){if(h.started)throw Error("Backbone.history has already been started");h.started=!0;this.options=b.extend({root:"/"},this.options,a);this.root=this.options.root;this._wantsHashChange=!1!==this.options.hashChange;this._wantsPushState=!!this.options.pushState;this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);a=
this.getFragment();var c=document.documentMode,c=n.exec(navigator.userAgent.toLowerCase())&&(!c||7>=c);this.root=("/"+this.root+"/").replace(D,"/");c&&this._wantsHashChange&&(this.iframe=d.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(a));if(this._hasPushState)d.$(window).on("popstate",this.checkUrl);else if(this._wantsHashChange&&"onhashchange"in window&&!c)d.$(window).on("hashchange",this.checkUrl);else this._wantsHashChange&&(this._checkUrlInterval=
setInterval(this.checkUrl,this.interval));this.fragment=a;a=this.location;c=a.pathname.replace(/[^\/]$/,"$&/")===this.root;if(this._wantsHashChange&&this._wantsPushState){if(!this._hasPushState&&!c)return this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0;this._hasPushState&&c&&a.hash&&(this.fragment=this.getHash().replace(x,""),this.history.replaceState({},document.title,this.root+this.fragment+a.search))}if(!this.options.silent)return this.loadUrl()},
stop:function(){d.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl);clearInterval(this._checkUrlInterval);h.started=!1},route:function(a,c){this.handlers.unshift({route:a,callback:c})},checkUrl:function(a){a=this.getFragment();a===this.fragment&&this.iframe&&(a=this.getFragment(this.getHash(this.iframe)));if(a===this.fragment)return!1;this.iframe&&this.navigate(a);this.loadUrl()},loadUrl:function(a){a=this.fragment=this.getFragment(a);return b.any(this.handlers,function(c){if(c.route.test(a))return c.callback(a),
!0})},navigate:function(a,c){if(!h.started)return!1;c&&!0!==c||(c={trigger:!!c});var b=this.root+(a=this.getFragment(a||""));a=a.replace(I,"");if(this.fragment!==a){this.fragment=a;""===a&&"/"!==b&&(b=b.slice(0,-1));if(this._hasPushState)this.history[c.replace?"replaceState":"pushState"]({},document.title,b);else if(this._wantsHashChange)this._updateHash(this.location,a,c.replace),this.iframe&&a!==this.getFragment(this.getHash(this.iframe))&&(c.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,
a,c.replace));else return this.location.assign(b);if(c.trigger)return this.loadUrl(a)}},_updateHash:function(a,c,b){b?(b=a.href.replace(/(javascript:|#).*$/,""),a.replace(b+"#"+c)):a.hash="#"+c}});d.history=new h;B=d.Router=function(a){a||(a={});a.routes&&(this.routes=a.routes);this._bindRoutes();this.initialize.apply(this,arguments)};F=/\((.*?)\)/g;E=/(\(\?)?:\w+/g;a=/\*\w+/g;c=/[\-{}\[\]+?.,\\\^$|#\s]/g;b.extend(B.prototype,e,{initialize:function(){},route:function(a,c,h){b.isRegExp(a)||(a=this._routeToRegExp(a));
b.isFunction(c)&&(h=c,c="");h||(h=this[c]);var e=this;d.history.route(a,function(b){b=e._extractParameters(a,b);h&&h.apply(e,b);e.trigger.apply(e,["route:"+c].concat(b));e.trigger("route",c,b);d.history.trigger("route",e,c,b)});return this},navigate:function(a,c){d.history.navigate(a,c);return this},_bindRoutes:function(){if(this.routes){this.routes=b.result(this,"routes");for(var a,c=b.keys(this.routes);null!=(a=c.pop());)this.route(a,this.routes[a])}},_routeToRegExp:function(b){b=b.replace(c,"\\$&").replace(F,
"(?:$1)?").replace(E,function(a,c){return c?a:"([^/]+)"}).replace(a,"(.*?)");return RegExp("^"+b+"$")},_extractParameters:function(a,c){var h=a.exec(c).slice(1);return b.map(h,function(a){return a?decodeURIComponent(a):null})}});m.extend=r.extend=B.extend=h.extend=p;return d});
(function(f,b){"function"===typeof define&&define.amd?define("XTemplate",["jQuery","underscore","XUtil"],function(f,d,l){return l.template=b(f,d,l)}):$x.template=b(f.jQuery,f._,f.XUtil)})(this,function(f,b,g){g=function(){b.bindAll(this,"initialize","addTemplate")};g.prototype={_templates:{},_templateTypes:{},initialize:function(){},hasTemplate:function(d){var g=b.has(this._templates,d);g||(d=f("#"+d),g=0<d.length&&(void 0!==d.data("xt-template")||d.is('script[type^="text/template"]')));return g},
getTemplate:function(f){d();b.has(this._templates,f)||this.addTemplate(f);return this._templates[f]},addTemplate:function(g,l,y){d();if(void 0===y||null===y){var v=f("#"+g);if(0==v.length)throw"Must specify a name that corresponds to a template element or provide the template text";v.is('script[type^="text/template"]');y=v.html();void 0===l&&(l=v.data("xt-template"),void 0===l&&(v=v.attr("type"),v=/^text\/template-(.+)$/.exec(v),1<v.length&&(l=v[1])))}if(!b.has(this._templateTypes,l))throw"Unrecognized template type";
l=this._templateTypes[l](y);this._templates[g]=l},registerTemplateType:function(b,d){this._templateTypes[b]=d}};var d=function(){b.has(this._templateTypes,"underscore")||this.registerTemplateType("underscore",function(d){return b.template(d)});b.has(this._templateTypes,"mustache")||"undefined"==typeof Mustache||this.registerTemplateType("mustache",function(b){return Mustache.compile(b)});b.has(this._templateTypes,"handlebars")||"undefined"==typeof Handlebars||this.registerTemplateType("handlebars",
function(b){return Handlebars.compile(b)});b.has(this._templateTypes,"xintricity")||"undefined"==typeof XMVVM||this.registerTemplateType("xintricity",function(b){return XMVVM.Template.compile(b)})},l=new g;g=function(b){return l.getTemplate(b)};g.addTemplate=function(){l.addTemplate.apply(l,arguments)};g.registerTemplateTypes=function(){l.registerTemplateType.apply(l,arguments)};d=b.bind(d,l);return g});
(function(f,b){"function"===typeof define&&define.amd?define("XMVVM-Model",["jquery","underscore","XUtil","XBase"],function(g,d,l,p){return f.XMVVM=b(g,d,l,p)}):f.XMVVM=b($,_,$x,__XBase__)})(this,function(f,b,g,d){var l={};d.Model.isParentTypeOf=function(b){return d.Model.prototype.isPrototypeOf(b.prototype)};d.Collection.isParentTypeOf=function(b){return d.Collection.prototype.isPrototypeOf(b.prototype)};var p=g.extendClass,C=function(e,d){this.fields||(this.fields={});this.fields&&!b.has(this,"fields")&&
(this.fields=g.extend({},this.fields));b.isFunction(d)&&(d={type:d});b.defaults(d,{persist:!0,type:Object});d.name=e;this.fields[e]=d;this[e]=function(){if(1===arguments.length)this.set(e,arguments[0]);else return this.get(e)}};b.mixin({resultBB:function(e,k,q){void 0===q&&(q=!0);var f=e[k];void 0===f&&e instanceof d.Model&&(f=e.get(k));void 0!==f&&q&&b.isFunction(f)&&(f=f());return f},startsWith:function(b,d){return b.substr(0,d.length)===d},endsWith:function(b,d){var f=b.length-d.length;return 0<=
f&&b.substr(f)===d}});l.Event=d.Event;var y=function(e,d){var f=Array.prototype.slice.call(arguments),g,m=d,r=d.indexOf(":"),s=void 0;b.has(e,m)?s=e[m]:0<=r&&(m=m.substr(0,r+1),b.has(e,m)&&(s=e[m]));if(void 0!==s){var p={};b.each(s,function(b,e){p[b]=f[e+2]});g=new l.Event(p)}return g},v=function(b,d,f,g){Array.prototype.slice.call(arguments);var m;m=null;4<arguments.length&&!(arguments[4]instanceof l.Event)?(m=Array.prototype.slice.call(arguments,3),m.unshift(f),m=y.apply(this,m),m=void 0!==m?[g,
m]:Array.prototype.slice.call(arguments,3)):4===arguments.length?(m={},m[d]=this,m=new l.Event(m),m=[g].concat([m])):m=Array.prototype.slice.call(arguments,3);b.prototype.trigger.apply(this,m)};l.Model=d.Model.extend({constructor:function(e,k){var f=this;b.bindAll(this,"createField","set");b.defaults(f,{fields:{}});b.chain(f.fields).keys().each(function(e){f[e]=b.bind(f[e],f)});d.Model.apply(this,[e,k])},fields:{},createField:function(e,d){C.call(this,e,d);this[e]=b.bind(this[e],this)},clone:function(){var e=
new this.constructor(this.attributes);b.chain(e.fields).keys().each(function(d){e[d]=b.bind(e[d],e)});e.fields=g.extend({},this.fields);b.each(e.fields,function(b,d,f){e.constructor.prototype&&e.constructor.prototype.fields&&e.constructor.prototype.fields[d]||e.createField(d,b)});return e},toJSON:function(){var e=this,d=b.clone(e.attributes);b.each(d,function(f,g){if(!b.has(e.fields,g)||e.fields[g].persist)if(f instanceof l.Model||f instanceof l.Collection)d[g]=f.toJSON()});return d},trigger:b.partial(v,
d.Model,"model",{add:["model","collection","options"],remove:["model","collection","options"],destroy:["model","collection","options"],change:["model","options"],"change:":["model","value","options"],request:["model","xhr","options"],sync:["model","resp","options"],error:["model","xhr","options"],invalid:["model","error","options"]}),set:function(e,k,f){var g=this,m,l,s=g.fields;b.isObject(e)?(m=e,f=k):(m={})[e]=k;var p=b.clone(m);b.each(m,function(e,k,f){var q,m;f=e;if(null!==s&&b.has(s,k)&&(q=s[k],
f=g._prepareValue(q,e),m=!0,b.isFunction(q.validate)&&(m=q.validate(e)),!0!==m))throw m;l=g[k];null!==l&&(l instanceof d.Model||l instanceof d.Collection)&&l.off("all",a,this);if(f instanceof d.Model||f instanceof d.Collection){var a=function(a,h){var e=Array.prototype.slice.call(arguments);b.has(h,"model")&&h.model===g||b.has(h,"recipients")&&b.has(h.recipients,g.cid)||(h.bubble(),h.recipients=h.recipients||{},h.recipients[g.cid]=!0,g.trigger.apply(g,e))};(e=g.get(k))&&e.off("all",a,g.cid+k);f.on("all",
a,g.cid+k)}p[k]=f});return d.Model.prototype.set.apply(this,[p,f])},_prepareValue:function(e,k){if(void 0===k||null===k)return k;switch(e.type){case "int":"int"!==typeof k&&(k=parseInt(k));break;case Number:b.isNumber(k)||(k=parseFloat(k));break;case Boolean:b.isBoolean(k)||(k=!0==k);break;case String:b.isString(k)||(k+="");break;case Date:k instanceof Date||(b.isNumber(k)?k=new Date(k):b.isString(k)&&(k=Date.parse(k)));break;case Array:if(!(k instanceof Array))throw"Type mismatch";break;default:if(!(k instanceof
e.type))if((e.type===d.Model||d.Model.isParentTypeOf(e.type))&&b.isObject(k)||(e.type===d.Collection||d.Collection.isParentTypeOf(e.type))&&(b.isObject(k)||b.isArray(k)))k=new e.type(k);else if(!(k instanceof e.type))throw"Type mismatch";}return k},parse:function(e){var k={};b.each(this.fields,function(b,f,g){d.Model.isParentTypeOf(b.type)||d.Collection.isParentTypeOf(b.type)?k[b.name]=new b.type(e[b.name],{parse:!0}):k[b.name]=e[b.name]});return k}});l.Model.extend=function(e,d){if(e.fields){var f=
e.fields;delete e.fields}var g=p.call(this,e,d);f&&(e.fields=f);this.prototype.fields&&b.each(this.prototype.fields,function(b,e){C.call(g.prototype,e,b)});b.has(e,"fields")&&b.each(e.fields,function(b,e){C.call(g.prototype,e,b)});return g};l.Model.createField=function(b,d,f){C.call(b,d,f)};l.Model.defaults={useGetSet:!1};l.Collection=d.Collection.extend({unique:function(){var e=array.slice.call(arguments);e.unshift(this.models);return b.unique.apply(b,e)},_onModelEvent:function(b,f,g,l){"add"!==
b&&"remove"!==b||g===this?d.Collection.prototype._onModelEvent.apply(this,arguments):this.trigger.apply(this,arguments)},trigger:b.partial(v,d.Collection,"collection",{add:["model","collection","options"],remove:["model","collection","options"],destroy:["model","collection","options"],reset:["collection","options"],sort:["collection","options"],request:["collection","xhr","options"],sync:["collection","resp","options"],error:["collection","xhr","options"]})});l.ViewModel=l.Model.extend({view:null,
fields:{model:Object},render:function(){this.view&&(this.$el=g.template(this.view)(this.model(),{context:{viewmodel:this}}));return this.$el},dispose:function(){this.$el&&this.view&&g.template(this.view)("destroy",this.$el)}});l.Filters=b.extend({},{isFalse:function(b){return!1===b},isNull:b.isNull,isUndefined:b.isUndefined,isObject:b.isObject,isNullOrUndefined:function(b){return void 0===b||null===b},isEmpty:function(b){return void 0===b||null===b||""===b},isEqualTo0:function(b){return 0===b},isEqualTo1:function(b){return 1===
b},isGreaterThan0:function(b){return 0<b},isLessThan0:function(b){0>b},add1:function(b){return b+1},subtract1:function(b){return b-1}});l.BindingExpression=function(d){d&&b.extend(this,d)};b.extend(l.BindingExpression.prototype,{toString:function(){for(var d="{",f=b.keys(this).sort(),d=d+('"'+f[0]+'","'+this[f[0]]+'"'),g=1;g<f.length;g++)d+=',"'+f[g]+'","'+this[f[g]]+'"';return d+"}"}});l.ModelNavMixins={splitModelPath:function(b){return b.match(/\w+(?=\.?)|(?=\[)\w+(?=\])/g)},resolveModelPath:function(b,
d,f){return this.resolveModelExpression(b,{path:d},f)},resolveModelExpression:function(e,f,g){var l=f.path;if(3>arguments.length||void 0===g)g={};g=b.defaults(g,{evalVal:!0,allowPartial:!0});g=b.defaults(g,{applyFilter:g.evalVal});var m=[e];if("undefined"!==typeof l&&null!==l&&""!==l){for(var l=l instanceof Array?l:this.splitModelPath(l),r=0;r<l.length;r++){var s=m[m.length-1];if(null==s&&g.allowPartial)break;else if(null==s){m=void 0;break}s=s instanceof d.Collection?s.at(l[r]):!s[l[r]]&&s instanceof
d.Model&&s.has(l[r])?s.get(l[r]):r<l.length-1||g.evalVal?b.resultBB(s,l[r]):s[l[r]];if("undefined"===typeof s){g.allowPartial||(m=void 0);break}m.push(s)}l=void 0!==m&&null!==m&&0<m.length?b.last(m):m;g.applyFilter&&(r=this._applyBindExpression(f,l,e),r!==l&&m.push(r));return m}},resolveModelExpressionValue:function(d,f){var g=this.resolveModelExpression(d,f,{allowPartial:!1});return g=void 0!==g&&b.isArray(g)&&0<g.length?b.last(g):void 0},_applyBindExpression:function(d,f,q){if(b.has(d,"filter")&&
b.isString(d.filter)){q=q.clone();q.createField("Filter",Object);q.set("Filter",l.Filters);d=this.resolveModelPath(q,d.filter,{evalVal:!1,allowPartial:!1});if(b.isArray(d))d=b.last(d);else throw"Invalid filter, path does not exist";if(b.isFunction(d))f=d(f);else throw"Invalid filter, not a function";}else b.has(d,"pattern")&&b.isString(d.pattern)&&(f=g.format(d.Pattern,f));return f},bindModelPath:function(b,d,f,g){this.bindModelExpression(b,{path:d},f,g)},bindModelExpression:function(e,f,g,p){var m=
this.splitModelPath(f.path),r=this.resolveModelPath(e,m),s={model:e,expression:f,callback:g},v=function(d){var e=b.indexOf(r,d.model);return 0>e||e==m.length||0!==e&&!b.has(d.model.changed,m[e])?!1:!0};b.has(this,"_bindingCallbacks")||(this._bindingCallbacks=[]);s.checkCallback=b.bind(function(f,k){var p;p=!1;switch(f){case "change":p=Array.prototype.slice.call(arguments,1,arguments.length);p=v.apply(this,p);break;case "add":case "remove":p=b.indexOf(r,k.collection),p=0<=p&&(p===r.length-1||b.indexOf(r,
k.collection)===p+1)}if(p=p&&!((this instanceof d.Model||this instanceof d.Collection)&&b.has(k,"recipients")&&b.has(k.recipients,this.cid))){r=this.resolveModelPath(e,m);k.recipients=b.has(k,"recipients")?k.recipients:{};k.recipients[this.cid]=!0;g.apply(this,arguments);p=new l.Event;p.oldValue=s.value;var z=this.resolveModelExpression(s.model,s.expression),z=z.length===m.length+1?b.last(r):void 0;p.value=z;s.value=z;g.apply(this,[p])}},this);this._bindingCallbacks.push(s);e.on("all",s.checkCallback,
this)},unbindModelPath:function(b,d,f){this.unbindModelExpression(b,{path:d},f)},unbindModelExpression:function(d,f,g){var l=b.find(this._bindingCallbacks,function(l){return l.model===d&&b.isEqual(l.expression,f)&&l.callback===g});d.off("all",l.checkCallback,this)},setModelPathValue:function(e,f,g,l){l=void 0===l?!0:l;f=b.isArray(f)?f:this.splitModelPath(f);e=this.resolveModelPath(e,f,{evalVal:!1,allowPartial:!1});var m=e.length,p=e[m-1];l&&b.isFunction(p)?p(g):p instanceof d.Collection?e[m-2].update(g):
e[m-2][f[m-1]]=g}};l.Router=d.Router.extend({initialize:function(e){var g=this;b.bindAll(this,"canRoute");e=e||{};b.defaults(e,{root:"/",startHistory:!0,pushState:!0});e.startHistory&&d.history.start({pushState:e.pushState,root:e.root});var l=location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")+e.root;f(document).on("click","a:not([data-bypass])",function(b){var e=f(this).attr("href");e&&e.substr(0,l.length)===l&&"_blank"!==f(this).attr("target")&&"external"!==f(this).attr("rel")&&
(e=e.substr(l.length),g.canRoute(e)?(b.preventDefault(),g.navigate(e,{trigger:!0})):e==d.history.fragment&&b.preventDefault())})},canRoute:function(e){if(!d.History.started)return!1;e=d.history.getFragment(e||"");e=e.replace(/[?#].*$/,"");if(e===d.history.fragment)return!1;e=d.history.getFragment(e);return b.any(d.history.handlers,function(b){if(b.route.test(e))return!0})}});return l});
(function(f,b){"function"===typeof define&&define.amd?define(["jQuery","underscore","XUtil","XMVVM-Model"],function(g,d,l,p){return f.XMVVM=b(g,d,l,p,XBase)}):f.XMVVM=b(f.jQuery,f._,f.XUtil,f.XMVVM)})(this,function(f,b,g,d){d.NodeTypes=[];var l=d.templateNode=function(a){a=b.defaults(a,{childNodes:[],el:null,$el:null,inner:null,parent:null});a.el&&!a.$el&&(a.$el=f(a.el));a.$el instanceof f||(a.$el=f(a.$el));a.el=a.$el.get(0);b.extend(this,a);this.initialize()};b.extend(l.prototype,{initialize:function(){b.bindAll(this,
"createInstance")},createInstance:function(a,c){return this.type.createInstance(this,a,c)}});var p=function(a,c){var h=a;b.each(c,function(a){h=h.contents().eq(a)});return h},C=d.templateParser=function(){this.initialize()};b.extend(C.prototype,{initialize:function(){b.bindAll(this,"parse","_parse","calculatePosition");var a=this;a.childScopeSelector="";a.parseFunctions={};b.each(d.NodeTypes,function(c){c=b.defaults(c,{name:null,type:"bind",selector:null,parse:null,render:null});if(null===c.name||
""===c.name)throw"Parser must specify a name";if(null===c.parse||!b.isFunction(c.parse))throw"Must specify a valid parse function";if("block"===c.type&&(null==c.selector||""==c.selector))throw"If parser is a block, must specify a selector for all nested scopes.";a.parseFunctions[c.name]=b.bind(c.parse,a);"block"===c.type&&(""!=a.childScopeSelector&&(a.childScopeSelector+=","),a.childScopeSelector+=c.selector)});var c=function(c,b){return 0<f(this).parentsUntil(c,a.childScopeSelector).length};a.excludeNestedScopes=
function(a){return b.partial(c,a)}},parse:function(a){var c=[];"undefined"===typeof this.parserFunctions&&this.initialize();a=new l({el:f(a),inner:f(a).children()});for(c=c.concat(this._parse(a));0<c.length;){var h=c.shift(),h=this._parse(h);b.isArray(h)&&0<h.length&&c.push.apply(c,h)}return a},_parse:function(a){var c=this,h=[],e=d.NodeTypes;b.each(b.where(e,{type:"tree"}),function(b){h=h.concat(c.parseFunctions[b.name](a)||[])});b.each(b.where(e,{type:"block"}),function(b){h=h.concat(c.parseFunctions[b.name](a)||
[])});var f=a.$el.find("*").not(c.childScopeSelector).not(c.excludeNestedScopes(a.$el)).add(a.$el);b.each(b.where(e,{type:"bind"}),function(b){f.each(function(h,d){c.parseFunctions[b.name](a,d)})});return h},calculatePosition:function(a,c){if(a.get(0)===c.get(0))return[];a=f(a);c=f(c);var b=a.parentsUntil(c);if(0!==a.closest(c).length){var d=[a.parent().contents().index(a)];b.each(function(a,c){var b=f(c);d.unshift(b.parent().contents().index(b))});return d}},parseBinding:function(a,c){var h={},e,
f=/^\{\{(?:\s*(Path|Filter|Pattern|HTML)\s*=\s*(?:'([^']*)'|"([^"]*)")\s*\,?)+\}\}$/ig,n=/(Path|Filter|Pattern|HTML)\s*=\s*('[^']*'|"[^"]*")\s*/ig;1===arguments.length&&(c=!0);e=a.match(/^\{\{([\w\.\[\]]+)\}\}$/i);if(null!==e&&1<e.length)h.path=e[1];else if(c)if(null!==f.exec(a)){for(;e=n.exec(a);)h[e[1].toLowerCase()]=e[2].substring(1,e[2].length-1);h.hasOwnProperty("path")||(h=void 0)}else h=a;else h=a;return b.isObject(h)?new d.BindingExpression(h):h}});var y=d.cssTriggerNodeType={name:"css-trigger",
type:"tree",parse:function(a){var c=this,h=[];a.$el.find("[data-xt-event][data-xt-class]:first-child, [data-xt-event]+[data-xt-event][data-xt-class], [data-xt-event][data-xt-style]:first-child, [data-xt-event]+[data-xt-event][data-xt-style]").not(c.excludeNestedScopes(a.$el)).each(function(d,e){var n=f(e),g={$el:n},k=[];n.is("[data-xt-style]")&&(k=n.data("xt-style").split(";"));var m=n.data("xt-class");g.event=n.data("xt-event");g.type=y;g.position=c.calculatePosition(f(e).parent(),a.$el);void 0!==
k&&0<k.length&&(g.styles={},b.each(k,function(a){a=a.split(":");2===a.length&&(g.styles[a[0].trim()]=a[1].trim())}));void 0!==m&&(g.cssClass=m);h.push(new l(g));n.remove()});a.childNodes=a.childNodes.concat(h);return[]},createInstance:function(a,c,h){c={event:a.event,el:p(c,a.position),context:h};b.has(a,"styles")&&(c.styles=a.styles);b.has(a,"cssClass")&&(c.cssClass=a.cssClass);return new d.StyleTrigger(c)}};d.NodeTypes.push(y);var v=d.actionTriggerNodeType={name:"action-trigger",type:"tree",parse:function(a){var c=
this,b=[];a.$el.find("[data-xt-event][data-xt-action]:first-child, [data-xt-event]+[data-xt-event][data-xt-action]").not(c.excludeNestedScopes(a.$el)).each(function(d,e){var n=f(e),g={$el:n},k=n.data("xt-data");g.event=n.data("xt-event");g.action=c.parseBinding(n.data("xt-action"),!1);g.type=v;g.position=c.calculatePosition(f(e).parent(),a.$el);void 0!==k&&(g.data=c.parseBinding(k,!1));b.push(new l(g));n.remove()});a.childNodes=a.childNodes.concat(b);return[]},createInstance:function(a,c,h){c={event:a.event,
el:p(c,a.position),context:h,action:a.action};b.has(a,"data")&&(c.data=a.data);return new d.ActionTrigger(c)}};d.NodeTypes.push(v);var e=d.foreachNodeType={name:"foreach",type:"block",selector:"[data-xt-foreach]",parse:function(a){var c=this,b=[];a.$el.find("[data-xt-foreach]").not(c.excludeNestedScopes(a.$el)).each(function(d,g){var n=f(g),n={$el:f(g),type:e,position:c.calculatePosition(n,a.$el),expression:c.parseBinding(n.data("xt-foreach")),iterator:n.data("xt-iterator"),indexer:n.data("xt-index")};
b.push(new l(n))});a.childNodes=a.childNodes.concat(b);return b},createInstance:function(a,c,b){c=p(c,a.position);a=new F({block:a,context:b,el:c});a.render();return a}};d.NodeTypes.push(e);var k=d.ifNodeType={name:"if-else",type:"block",selector:"[data-xt-if],[data-xt-else-if],[data-xt-else]",parse:function(a){var c=this,b=[];a.$el.find("[data-xt-if]").not(c.excludeNestedScopes(a.$el)).each(function(d,e){var g=f(e),m=new l({el:e,type:k,position:c.calculatePosition(g,a.$el),branches:[],defaultBranch:null});
do{var p=g.is("[data-xt-if]")?g.data("xt-if"):g.data("xt-else-if"),p=new l({el:g,type:k,subType:"branch",expression:c.parseBinding(p)});g.is("[data-xt-onrender]")&&(p.onrender=c.parseBinding(g.data("xt-onrender")));m.branches.push(p);b.push(p);g=g.next()}while(g.is("[data-xt-else-if]"));g.is("[data-xt-else]")&&(m.defaultBranch=new l({el:g,type:k,subType:"else"}),b.push(m.defaultBranch),g.is("[data-xt-onrender]")&&(m.defaultBranch.onrender=c.parseBinding(g.data("xt-onrender"))));a.childNodes.push(m)});
return b},createInstance:function(a,c,b){c=p(c,a.position);a=new B({block:a,context:b,el:c});a.render();return a}};d.NodeTypes.push(k);var q=d.partialNodeType={name:"partial",type:"block",selector:"[data-xt-partial]",parse:function(a){var c=this;a.$el.find("[data-xt-partial]").not(c.excludeNestedScopes(a.$el)).each(function(d,e){var g=f(e),n=g.data("xt-model");n&&(n=c.parseBinding(n));var k=g.data("xt-partial");if(void 0===n){var m=c.parseBinding(k);b.isObject(m)&&(n=m,k=void 0)}a.childNodes.push(new l({$el:g,
type:q,position:c.calculatePosition(g,a.$el),template:k,model:n}))})},createInstance:function(a,c,b){c=p(c,a.position);a=new A({block:a,context:b,el:c});a.render();return a}};d.NodeTypes.push(q);var z=d.attributeBindingNodeType={name:"attribute-binding",type:"bind",parse:function(a,c){var d=f(c),e=this;b.each(c.attributes,function(c){var f=c.name;"data-xt-"===f.substr(0,8)&&"data-xt-src"!==f&&"data-xt-value"!==f||"type"===f||(c=c.value,c=e.parseBinding(c),b.isObject(c)&&a.childNodes.push(new l({expression:c,
type:z,position:e.calculatePosition(d,a.$el),attr:f})))})},createInstance:function(a,c,b){c=p(c,a.position);return new d.AttributeBinding({model:b,el:c,expression:a.expression,attr:a.attr})}};d.NodeTypes.push(z);var m=d.cssBindingNodeType={name:"css-binding",type:"bind",parse:function(a,c){var d=f(c),e=this,g=b.filter(c.attributes,function(a){return b.startsWith(a.name,"data-xt-class-")});b.each(g,function(c){var f=c.name;c=c.value;c=e.parseBinding(c);b.isObject(c)&&a.childNodes.push(new l({expression:c,
type:m,position:e.calculatePosition(d,a.$el),cssClass:f.substr(14)}))})},createInstance:function(a,c,b){c=p(c,a.position);return new d.CssClassBinding({model:b,el:c,expression:a.expression,cssClass:a.cssClass})}};d.NodeTypes.push(m);var r=d.textBindingNodeType={name:"text-binding",type:"bind",textBindingPattern:/\{\{([a-zA-Z][\w\._]*|([a-zA-z]\w*\s*=\s*('[^']*'|"[^"]*"),?\s*)+)\}\}/g,parse:function(a,c){var d=this,e=f(c),g=e.contents();b.each(g.filter(function(){return 3==this.nodeType}),function(c){c=
r.createBinding.call(d,c,a.$el,c.nodeValue);null!==c&&a.childNodes.push(c)});b.each(e.get(0).attributes,function(c){b.isObject(d.parseBinding(c.value))||(c=r.createBinding.call(d,e,a.$el,c.value,c.name),null!==c&&a.childNodes.push(c))})},createBinding:function(a,c,d,e){var g=this;a=f(a);for(var k=[],m=null;m=r.textBindingPattern.exec(d);)k.push(m[0]);if(null!=k&&0<k.length){var p=b.uniq(k),k=b.map(p,function(a){return g.parseBinding(a)});d.replace(/\{/,"&#123;").replace(/\}/,"&#125;");d=d.replace(r.textBindingPattern,
function(a){return"{"+b.indexOf(p,a)+"}"});c={type:r,paths:k,pattern:d,position:g.calculatePosition(a,c)};void 0!==e&&(c.attribute=e);return new l(c)}return null},createInstance:function(a,c,e){c=p(c,a.position);e={model:e,el:c,paths:a.paths,pattern:a.pattern};b.has(a,"attribute")&&(e.attribute=a.attribute);return new d.TextNodeBinding(e)}};d.NodeTypes.push(r);var s=d.selectBindingNodeType={name:"select-binding",type:"bind",parse:function(a,c){var b=f(c);if(b.is("[data-xt-options]")){var d=b.data("xt-options"),
d={el:c,type:s,path:d.substr(2,d.length-4),position:this.calculatePosition(b,a.$el)},e=b.data("xt-text-field"),b=b.data("xt-value-field");void 0!==e&&null!==e&&(d.textField=e);void 0!==b&&null!==b&&(d.valueField=b);b=new l(d);a.childNodes.push(b)}},createInstance:function(a,c,b){c=p(c,a.position);return new d.SelectBinding({model:b,el:c,path:a.path,textField:a.textField,valueField:a.valueField})}};d.NodeTypes.push(s);d.Binding=function(){};d.Binding.extend=g.extendClass;d.AttributeBinding=d.Binding.extend({constructor:function(a){this.options=
g.extend({},a);this.options=b.defaults(this.options,this.defaults);if(null===this.options.model||null===this.options.path||null===this.options.el||null===this.options.attr)throw"model, path, el, and attr options are required";"value"!==this.options.attr&&(this.options.updateModel=!1);this.$el=f(this.options.el);b.bindAll(this,"value","elementValue","setModelAttr","modelChanged","bindModel","unbindModel","bindEl","setElProp","elChanged","dispose");this.bindModel();this.bindEl();this.initialize()},
initialize:function(){var a=this.value();this.options.updateElement&&this.setElProp(a);if(this.options.updateModel){var c=this.elementValue();c!==this.options.expression.path&&(void 0===c||null===c?"":c)!=(void 0===a||null===a?"":a)+""&&this.setModelAttr(c)}},defaults:{model:null,expression:null,el:null,attr:null,updateModel:!0,updateElement:!0},bindModel:function(){this._modelPath=this.resolveModelExpression(this.options.model,this.options.expression,{evalVal:!1,applyFilter:!1,allowPartial:!1});
this.bindModelExpression(this.options.model,this.options.expression,this.modelChanged)},unbindModel:function(){this.unbindModelExpression(this.options.model,this.options.expression,this.modelChanged)},value:function(){if("undefined"!==typeof this._modelPath&&0!==this._modelPath.length){var a=this._modelPath[this._modelPath.length-1];b.isFunction(a)&&(a=a());return this._applyBindExpression(this.options.expression,a,this.options.model)}},elementValue:function(){var a;a="data-xt-value"===this.options.attr;
this.$el.is('input[type="radio"]')&&a?(a=this.$el.closest("form"),0===a.length&&(a=f(document)),a=a.find(g.format('input[type="radio"][name="{0}"]:checked',this.$el.attr("name"))).val()):a=this.$el.is('input[type="checkbox"]')&&a?this.$el.is(":checked")?this.$el.val():void 0:"value"===this.options.attr?this.$el.val():this.$el.attr(this.options.attr);return a},setModelAttr:function(a){var c=this._modelPath;if(void 0===c||null===c)throw"Xintricity cannot set model value, expression does not exist: "+
this.options.expression.path;var d=c.length,e=this.splitModelPath(this.options.expression.path);if(0<d&&b.isFunction(c[d-1]))c[d-1](a);else c[d-2][b.last(e)]=a},modelChanged:function(a,c,b){this._modelPath=this.resolveModelExpression(this.options.model,this.options.expression,{evalVal:!1,applyFilter:!1,allowPartial:!1});this.options.updateElement&&"id"!==this.options.attr&&this.setElProp(this.value())},bindEl:function(){if(3==this.options.el.nodeType)throw"Attribute binding cannot be used with text nodes";
this.$el.on("change.binding",this.elChanged)},unbindEl:function(){this.$el.off("change.binding",this.elChanged);this._modelPath=null},setElProp:function(a){if(this.options.updateElement)if(this.$el.is('input[type="radio"]')&&"data-xt-value"===this.options.attr){var c=this.$el.closest("form");0===c.length&&(c=f(document));c=c.find(g.format('input[type="radio"][name="{0}"][value="{1}"]',this.$el.attr("name"),a));c.prop("checked","checked")}else this.$el.is('input[type="checkbox"]')&&"data-xt-value"===
this.options.attr?a==this.$el.val()?this.$el.prop("checked","checked"):this.$el.prop("checked",""):"value"===this.options.attr?this.$el.val(a):"data-xt-src"==this.options.attr&&this.$el.is("img")?this.$el.attr("src",a):this.$el.attr(this.options.attr,a)},elChanged:function(a,c){this.setModelAttr(this.elementValue())},dispose:function(){this.unbindModel();this.unbindEl()}});g.extend(d.AttributeBinding.prototype,d.ModelNavMixins);d.TextNodeBinding=d.Binding.extend({constructor:function(a){this.options=
g.extend({},a);this.options=b.defaults(this.options,this.defaults);if(null===this.options.model||null===this.options.paths||0===this.options.paths.length||null===this.options.el||null==this.options.pattern)throw"model, path, el, and attr options are required";this.options.el instanceof f&&(this.options.el=this.options.el.get(0));this._modelPaths={};this._callbacks={};b.bindAll(this,"initialize","value","modelChanged","bindModel","updateText","dispose");this.bindModel();this.initialize()},initialize:function(){this.updateText()},
defaults:{model:null,paths:null,el:null,pattern:null},bindModel:function(a){var c=this;b.each(1===arguments.length?[a]:this.options.paths,function(a){c._callbacks[a]=b.bind(c.modelChanged,c,a);c.bindModelExpression(c.options.model,a,c._callbacks[a])})},value:function(a){a=this.resolveModelExpression(this.options.model,a,{evalVal:!0,allowPartial:!1});return b.isArray(a)&&0<a.length?b.last(a):void 0},modelChanged:function(a){this.updateText()},updateText:function(){var a=this,c=[a.options.pattern],
d=!1;b.each(a.options.paths,function(e){var f=a.value(e),f=void 0==f?"":f.toString();b.has(e,"html")&&"true"===e.html?(c.push(f),d=!0):(f=f?a.escapeHtml(f):f,c.push(f))});var e=g.format.apply(this,c).replace(/&#123;/,"{").replace(/&#125;/,"}");if(b.has(a.options,"attribute"))f(a.options.el).attr(a.options.attribute,a.escapeEntities(e));else if(d){var k=document.createElement("div"),l=f(a.options.el).parent().get(0),m=a.options.el;m instanceof NodeList||(m=[a.options.el]);k.innerHTML="<div>"+e+"</div>";
k=k.children;b.each(k,function(a){l.insertBefore(a,m[0])});b.each(m,function(a){l.removeChild(a)});0<f(k).parents("html").length&&f(k).filter("script").each(function(){f.globalEval(this.text||this.textContent||this.innerHTML||"")});a.options.el=k}else a.options.el.nodeValue=a.escapeEntities(e)},escapeHtml:function(a){return a.replace(/&<>"/g,function(a){return d.TextNodeBinding.HtmlEntities[a]})},escapeEntities:function(a){return a.replace(/[^\x20-\x7E]/g,function(a){return d.TextNodeBinding.EntityCodes[a]?
"&"+d.TextNodeBinding.EntityCodes[a]+";":a})},dispose:function(){var a=this;b.each(this.options.paths,function(c){a.unbindModelExpression(a.options.model,c,a._callbacks[c])});a._modelPaths={};a._callbacks={};delete a._callbacks;delete a._modelPaths}});g.extend(d.TextNodeBinding.prototype,d.ModelNavMixins);d.TextNodeBinding.HtmlEntities={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"};d.TextNodeBinding.EntityCodes={apos:39,quot:34,amp:38,lt:60,gt:62,nbsp:160,iexcl:161,cent:162,pound:163,curren:164,
yen:165,brvbar:166,sect:167,uml:168,copy:169,ordf:170,laquo:171,not:172,shy:173,reg:174,macr:175,deg:176,plusmn:177,sup2:178,sup3:179,acute:180,micro:181,para:182,middot:183,cedil:184,sup1:185,ordm:186,raquo:187,frac14:188,frac12:189,frac34:190,iquest:191,Agrave:192,Aacute:193,Acirc:194,Atilde:195,Auml:196,Aring:197,AElig:198,Ccedil:199,Egrave:200,Eacute:201,Ecirc:202,Euml:203,Igrave:204,Iacute:205,Icirc:206,Iuml:207,ETH:208,Ntilde:209,Ograve:210,Oacute:211,Ocirc:212,Otilde:213,Ouml:214,times:215,
Oslash:216,Ugrave:217,Uacute:218,Ucirc:219,Uuml:220,Yacute:221,THORN:222,szlig:223,agrave:224,aacute:225,acirc:226,atilde:227,auml:228,aring:229,aelig:230,ccedil:231,egrave:232,eacute:233,ecirc:234,euml:235,igrave:236,iacute:237,icirc:238,iuml:239,eth:240,ntilde:241,ograve:242,oacute:243,ocirc:244,otilde:245,ouml:246,divide:247,oslash:248,ugrave:249,uacute:250,ucirc:251,uuml:252,yacute:253,thorn:254,yuml:255,OElig:338,oelig:339,Scaron:352,scaron:353,Yuml:376,fnof:402,circ:710,tilde:732,Alpha:913,
Beta:914,Gamma:915,Delta:916,Epsilon:917,Zeta:918,Eta:919,Theta:920,Iota:921,Kappa:922,Lambda:923,Mu:924,Nu:925,Xi:926,Omicron:927,Pi:928,Rho:929,Sigma:931,Tau:932,Upsilon:933,Phi:934,Chi:935,Psi:936,Omega:937,alpha:945,beta:946,gamma:947,delta:948,epsilon:949,zeta:950,eta:951,theta:952,iota:953,kappa:954,lambda:955,mu:956,nu:957,xi:958,omicron:959,pi:960,rho:961,sigmaf:962,sigma:963,tau:964,upsilon:965,phi:966,chi:967,psi:968,omega:969,thetasym:977,upsih:978,piv:982,ensp:8194,emsp:8195,thinsp:8201,
zwnj:8204,zwj:8205,lrm:8206,rlm:8207,ndash:8211,mdash:8212,lsquo:8216,rsquo:8217,sbquo:8218,ldquo:8220,rdquo:8221,bdquo:8222,dagger:8224,Dagger:8225,bull:8226,hellip:8230,permil:8240,prime:8242,Prime:8243,lsaquo:8249,rsaquo:8250,oline:8254,frasl:8260,euro:8364,image:8465,weierp:8472,real:8476,trade:8482,alefsym:8501,larr:8592,uarr:8593,rarr:8594,darr:8595,harr:8596,crarr:8629,lArr:8656,uArr:8657,rArr:8658,dArr:8659,hArr:8660,forall:8704,part:8706,exist:8707,empty:8709,nabla:8711,isin:8712,notin:8713,
ni:8715,prod:8719,sum:8721,minus:8722,lowast:8727,radic:8730,prop:8733,infin:8734,ang:8736,and:8743,or:8744,cap:8745,cup:8746,"int":8747,there4:8756,sim:8764,cong:8773,asymp:8776,ne:8800,equiv:8801,le:8804,ge:8805,sub:8834,sup:8835,nsub:8836,sube:8838,supe:8839,oplus:8853,otimes:8855,perp:8869,sdot:8901,lceil:8968,rceil:8969,lfloor:8970,rfloor:8971,lang:9001,rang:9002,loz:9674,spades:9824,clubs:9827,hearts:9829,diams:9830};d.CssClassBinding=d.Binding.extend({constructor:function(a){this.options=g.extend({},
a);this.options=b.defaults(this.options,this.defaults);if(null===this.options.model||null===this.options.path||null===this.options.el||null===this.options.cssClass)throw"model, path, cssClass, and el are required";this.$el=f(this.options.el);b.bindAll(this,"value","modelChanged","bindModel","unbindModel","setElClasses","dispose");this.bindModel();this.initialize()},initialize:function(){this.setElClasses(this.value());this.$el.removeAttr("data-xt-class-"+this.options.cssClass)},defaults:{model:null,
expression:null,el:null,attr:null},bindModel:function(){this._modelPath=this.resolveModelExpression(this.options.model,this.options.expression,{evalVal:!1,allowPartial:!1});this.bindModelExpression(this.options.model,this.options.expression,this.modelChanged)},unbindModel:function(){this.unbindModelExpression(this.options.model,this.options.expression,this.modelChanged)},value:function(){if("undefined"!==typeof this._modelPath&&0!==this._modelPath.length){var a=this._modelPath[this._modelPath.length-
1];b.isFunction(a)&&(a=a());return this._applyBindExpression(this.options.expression,a,this.options.model)}},modelChanged:function(a,c,b){this._modelPath=this.resolveModelExpression(this.options.model,this.options.expression,{evalVal:!1,allowPartial:!1});this.setElClasses(this.value())},setElClasses:function(a){a?this.$el.addClass(this.options.cssClass,a):this.$el.removeClass(this.options.cssClass,a)},dispose:function(){this.unbindModel()}});g.extend(d.CssClassBinding.prototype,d.ModelNavMixins);
d.SelectBinding=d.Binding.extend({constructor:function(a){this.options=g.extend({},a);this.options=b.defaults(this.options,this.defaults);if(null===this.options.model||null===this.options.path||null===this.options.el)throw"model, path, and el options are required";this.$el=f(this.options.el);b.bindAll(this,"value","bindModel","unbindModel","modelChanged","bindEl","createOptions","dispose");this.bindModel();this.bindEl();this.initialize()},initialize:function(){var a=this.$el.val();this.createOptions(this.value());
0===this.$el.children(":selected").length&&this.$el.val(this.$el.children(0).val());this.$el.val()!=a&&this.$el.trigger("change")},defaults:{model:null,path:null,el:null,textField:"name",valueField:"value"},bindModel:function(){this._modelPath=this.resolveModelPath(this.options.model,this.options.path,{evalVal:!1,allowPartial:!1});this.bindModelPath(this.options.model,this.options.path,this.modelChanged)},unbindModel:function(){var a=this;b.each(a._bindingCallbacks,function(c,b){a.unbindModelExpression(c.model,
c.expression,c.callback)});this._bindingCallbacks=[]},value:function(){if("undefined"!==typeof this._modelPath&&0!==this._modelPath.length){var a=this._modelPath[this._modelPath.length-1];return b.isFunction(a)?a():a}},modelChanged:function(a,c,b){this._modelPath=this.resolveModelPath(this.options.model,this.options.path,{evalVal:!1,allowPartial:!1});this.createOptions(this.value())},bindEl:function(){if(!this.options.el.is("select"))throw"el must be of node type <select>";f(this.options.el)},unbindEl:function(){f(this.options.el).off("change.binding",
this.elChanged);this._modelPath=null},createOptions:function(a){var c=this,e=f(c.options.el),g=e.val();e.empty();var k=function(a,d,g){d=b.resultBB(a,c.options.textField);a=b.resultBB(a,c.options.valueField);g=f(document.createElement("option"));g.text(d).val(a);e.append(g)};a instanceof d.Collection?a.each(k):b.each(a,k);1<e.children("option").length&&e.val(g)},dispose:function(){this.unbindModel();this.unbindEl()}});g.extend(d.SelectBinding.prototype,d.ModelNavMixins);d.Trigger=function(a){if(null===
arguments||0===arguments.length)a={};this.options=b.defaults(a,this.defaults);this.initialize.apply(this)};g.extend(d.Trigger.prototype,{defaults:{el:null,event:"click"},initialize:function(){b.bindAll(this,"onTrigger","onTriggerInv","onTriggerInternal","onTriggerInvInternal","bind","unbind","dispose");this.bind()},onTrigger:function(a){},onTriggerInv:function(a){},onTriggerInternal:function(a){var c=new d.Event({event:this.options.event,target:a.target});this.onTrigger(c);c.isDefaultPrevented()&&
a.preventDefault()},onTriggerInvInternal:function(a){var c=new d.Event({event:this.options.event});this.onTrigger(c);c.isDefaultPrevented()&&a.preventDefault()},bind:function(){var a=f(this.options.el);switch(this.options.event){case null:throw"Event name cannot be null";case "hover":a.on("mouseenter.binding",this.onTriggerInternal);a.on("mouseleave.binding",this.onTriggerInvInternal);break;default:a.on(this.options.event+".binding",this.onTriggerInternal)}},unbind:function(){var a=f(this.options.el);
switch(this.options.event){case null:throw"Event name cannot be null";case "hover":a.off("mouseenter.binding",this.onTriggerInternal);a.on("mouseleave.binding",this.onTriggerInvInternal);break;default:a.off(this.options.event+".binding",this.onTriggerInternal)}},dispose:function(){this.unbind()}});d.Trigger.extend=g.extendClass;d.StyleTrigger=d.Trigger.extend({initialize:function(){d.Trigger.prototype.initialize.call(this)},defaults:{el:null,event:"click",target:null},onTrigger:function(){var a=this,
c=f(a.options.el),d=c;null!=a.options.target&&(d=a.getTarget(c));null!=a.options.cssClass&&(a.options.cssClass instanceof Array?b.each(a.options.cssClass,function(a,c,b){d.addClass(a)}):d.addClass(a.options.cssClass));null!=a.options.styles&&(a.prevStyles={},b.each(a.options.styles,function(c,b,e){a.prevStyles[b]=d.css(b);d.css(b,c)}))},onTriggerInv:function(){var a=$el;null!=t.options.target&&(a=t.getTarget($el));null!=this.options.cssClass&&(this.options.cssClass instanceof Array?b.each(this.options.cssClass,
function(c,b,d){a.removeClass(c)}):a.removeClass(this.options.cssClass));null!=this.options.styles&&(this.prevStyles={},b.each(this.options.styles,function(c,b,d){a.css(b,this.prevStyles[b])}))},getTarget:function(a){return a}});g.extend(d.StyleTrigger.prototype,d.ModelNavMixins);d.Actions=b.extend({},{});d.ActionTrigger=d.Trigger.extend({defaults:{el:null,event:"click",context:{},action:null,data:void 0},initialize:function(){d.Trigger.prototype.initialize.call(this)},onTrigger:function(a){if(null!=
this.options.context&&null!=this.options.action){var c=this.resolveModelExpression(this.options.context,this.options.action,{evalVal:!1});b.isArray(c)&&(c=b.last(c));var d=this.options.data;void 0!==this.options.data&&b.has(d,"path")&&(a.data=this.resolveModelExpressionValue(this.options.context,d));c(a)}}});g.extend(d.ActionTrigger.prototype,d.ModelNavMixins);var w=function(a){this.options=g.extend({},a);0<arguments.length&&(b.defaults(this.options,this.defaults),a.el&&this.setEl(a.el));this.initialize()};
w.extend=g.extendClass;g.extend(w.prototype,{defaults:{block:null,context:null,el:null},initialize:function(){this.childInstances=[];b.bindAll(this,"render")},render:function(){},renderInternal:function(a,c,d){var e=this;a=a?a:this.options.block;var g=f(c),k=[];b.each(a.childNodes,function(a,c){var b=a.createInstance(g,d);k.push(b);e.childInstances.push(b);b instanceof w&&b.render()});return k},renderLocalBindingsAndTriggers:function(a,c,d){var e=this;a=a?a:this.options.block;var g=f(c);a=b.filter(a.childNodes,
function(a){return("bind"===a.type.type||"trigger"===a.type.type)&&0===a.position.length});b.each(a,function(a,b){var c=a.createInstance(g,d);e.childInstances.push(c);c instanceof w&&c.render()})},setEl:function(a){this.el=a;this.$el=f(a)},resolveElement:function(a,c){var d=a;b.each(c,function(a){d=d.contents().eq(a)});return d},clear:function(){b.each(this.childInstances,function(a){a.dispose&&a.dispose()});this.childInstances=[];this.$el.empty()},dispose:function(){this.clear()},createContext:function(a,
c){var e;e=null!=c?this.options.context.clone():new d.Model;b.each(a,function(a,c,d){e.set(c,a);b.isUndefined(a)||b.isNull(a)||e.createField(c,{type:a.constructor})});return e}});g.extend(w.prototype,d.ModelNavMixins);var H=w.extend({initialize:function(){w.prototype.initialize.apply(this);b.bindAll(this,"render")},render:function(){var a=this.options.block;this.setEl(a.$el.clone());var c=this.createContext(this.options.context);this.renderInternal(a,this.$el,c);this.$el.removeClass("xt-template")}}),
A=w.extend({initialize:function(){w.prototype.initialize.apply(this);b.bindAll(this,"modelChanged","render");var a=this.options.block.model;this.bindModelExpression(this.options.context,a,this.modelChanged);this.model=this.resolveModelExpressionValue(this.options.context,a)},modelChanged:function(){var a=t.options.block.model;t.unbindModelPath(t.options.context,a,t.modelChanged);t.bindModelExpression(t.options.context,a,t.modelChanged);t.model=t.resolveModelExpressionValue(t.options.context,a)},render:function(){var a=
this.options.block;this.clear();a=a.template;(b.isUndefined(a)||b.isNull(a))&&this.model instanceof d.ViewModel?a=this.model.render():(b.isObject(a)&&(a=this.resolveModelExpressionValue(this.options.context,a)),g.template(a)("destroy",this.$el),a=g.template(a)(this.model));a.insertBefore(this.$el.eq(0));this.$el.remove();this.setEl(a)},dispose:function(){var a=this.options.block;this.clear();a=a.template;(b.isUndefined(a)||b.isNull(a))&&this.model instanceof d.ViewModel&&this.model.dispose()}}),B=
w.extend({initialize:function(){var a=this,c=a.options.block;a.current=null;for(var d=a.$el.next();0<d.filter("[data-xt-else-if]").length;)a.$el=a.$el.add(d),d=d.next();0<d.filter("[data-xt-else]").length&&(a.$el=a.$el.add(d));w.prototype.initialize.apply(a);b.bindAll(a,"render");this.branches=[];b.each(c.branches,function(c,d){var e={};e.callback=b.bind(a.modelChanged,a,d);e.value=a.resolveModelExpressionValue(a.options.context,c.expression);null===a.current&&e.value&&(a.current=d);a.bindModelExpression(a.options.context,
c.expression,e.callback);a.branches.push(e)})},modelChanged:function(a){var c=this.options.block,b=this.branches[a],d=b.value;b.value=this.resolveModelExpressionValue(this.options.context,c.branches[a].expression);if((null===this.current||a<=this.current)&&b.value!=d){a=null;for(b=0;b<this.branches.length;b++)if(this.branches[b].value){a=b;break}null===a&&null!==c.defaultBranch&&(a=this.branches.length);this.current=a;this.render()}},render:function(){var a=this.options.block,c=null!==this.current&&
this.current<this.branches.length?a.branches[this.current]:a.defaultBranch;this.clear();var d=null;c?(d=c.$el.clone(),this.renderInternal(c,d,this.options.context)):d=f(document.createTextNode(""));for(var e=0;e<this.branches.length-1;e++)d=d.add(document.createTextNode(""));null!==a.defaultBranch&&(d=d.add(document.createTextNode("")));d.removeAttr("data-xt-if").removeAttr("data-xt-else-if").removeAttr("data-xt-else");this.$el.eq(0).prev().length?d.insertBefore(this.$el.eq(0)):this.$el.eq(0).parent().prepend(d);
this.$el.remove();this.setEl(d);c&&b.has(c,"onrender")&&(a=this.resolveModelExpression(this.options.context,c.onrender),b.isArray(a)&&0<a.length&&(a=b.last(a),a(d)))}}),F=w.extend({initialize:function(){w.prototype.initialize.apply(this);var a=this.options.block.expression;b.bindAll(this,"render","modelChanged");this.bindModelExpression(this.options.context,a,this.modelChanged);this.value=this.resolveModelExpressionValue(this.options.context,a);this.blocks={}},modelChanged:function(a){var b=this.options.block.expression,
d=this.resolveModelExpressionValue(this.options.context,b);a=this.value!=d||"add"===a||"remove"===a||"sort"===a||"reset"===a;this.value=d;a&&(this.value=this.resolveModelExpressionValue(this.options.context,b),this.render())},render:function(){var a=this,c=a.options.block;a.$el.contents().detach();a.renderLocalBindingsAndTriggers(a.options.block,a.$el,a.options.context);if(a.value&&0<a.value.length){var e=c.iterator,g=b.has(c,"indexer")?c.indexer:void 0;c.$el.clone().children();a.$el.removeAttr("data-xt-foreach");
a.$el.removeAttr("data-xt-iterator");var k=function(d,k,l){if((l=d.cid)&&b.has(a.blocks,l)&&(a.blocks[l].index===k||void 0===g))a.$el.append(a.blocks[l].$el),b.each(a.blocks[l].childInstances,function(b){a.childInstances.push(b)}),delete a.blocks[l];else{l={};void 0!==g&&(l[g]=k);l[e]=d;var m=a.createContext(l,a.options.context);l=f(c.el).clone();m=a.renderInternal(a.options.block,l,m);d.cid&&(a.nextBlocks[d.cid]={index:k,item:d,$el:l.children(),childInstances:m});a.$el.append(l.children())}};a.nextBlocks=
{};var l=a.childInstances;a.childInstances=[];a.value instanceof d.Collection?a.value.forEach(k):b.each(a.value,k);b.each(l,function(c){b.contains(a.childInstances,c)||c.dispose()});a.blocks=a.nextBlocks;delete a.nextBlocks}b.has(c,"onrender")&&(k=a.resolveModelExpression(a.options.context,c.onrender),b.isArray(k)&&0<k.length&&(k=b.last(k),k($next)))}}),E={};d.Template=function(a,b){this.block=a;this.context=b;this.tmplID=Math.floor(1E8*Math.random());E[this.tmplID]=this};g.extend(d.Template.prototype,
{render:function(){var a=new H({block:this.block,context:this.context});a.render();a=a.$el;a.data("template-id",this.tmplID);return a.children()},dispose:function(){}});d.Template.compile=function(){var a;if(2<arguments.length)throw"Invalid arguments";a=arguments[0]instanceof f?arguments[0]:f(arguments[0]);a=f("<div></div>").append(a);var c=(new d.templateParser).parse(a);return 2===arguments.length&&!0===arguments[1]?c:function(a,e,k){if(!b.isString(a)){k=e;var l={model:a};k&&k.context&&g.extend(l,
k.context);return(new d.Template(c,l)).render()}a=arguments[0];if(!b.isString(a))throw"Invalid argument (1), String expected";switch(a){case "destroy":if(2!==arguments.length)throw"Invalid number of arguments";l=arguments[1];if(!(l instanceof f))throw"Invalid argument (2), jQuery expected";l.data("template-id")&&E[l.data("template-id")].dispose()}}};"undefined"!==typeof test&&(d.templateInstances=E);return d});
